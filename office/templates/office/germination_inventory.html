{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Uprising Seeds - Germination / Inventory</title>

    <!-- base -->
    <link rel="stylesheet" href="{% static 'office/css/base.css' %}">
    <link rel="stylesheet" href="{% static 'office/css/germination_inventory.css' %}">

</head>

<body>

    <!-- Message System Container -->
    <div class="messages-container" id="messagesContainer"></div>

    <div class="container">
        <!-- Header Section -->
        <div class="header">
            <div class="header-top">
                <div class="header-left">
                    <a href="{% url 'office_landing' %}" class="back-button">
                        ‚Üê Dashboard
                    </a>
                    <h1 class="page-title">Germination / Inventory</h1>
                </div>

                <div class="header-right">
                    <div class="filter-group">
                        <label class="filter-label">Category:</label>
                        <select class="filter-select" id="categoryFilter">
                            <option value="">All Categories</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Group:</label>
                        <select class="filter-select" id="groupFilter">
                            <option value="">All Groups</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Crop:</label>
                        <select class="filter-select" id="cropFilter">
                            <option value="">All Crops</option>
                        </select>
                    </div>

                    <!-- ADD THIS NEW FILTER -->
                    <div class="filter-group">
                        <label class="filter-label">Website:</label>
                        <select class="filter-select website-filter" id="websiteFilter">
                            <option value="">All</option>
                            <option value="true">üü¢ Complete</option>
                            <option value="false">üî¥ Incomplete</option>
                        </select>
                    </div>

                    <button class="clear-filters" id="clearFiltersBtn">
                        Clear Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="content">
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr id="tableHeader">
                            <th>Variety</th>
                            <th>Lot</th>
                            <th>Current Inv</th>
                            <th>Previous Inv</th>
                            <th>Difference</th>
                            <!-- Germination columns will be added dynamically -->
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
                
                <!-- Loading State -->
                <div class="loading-state" id="loadingState">
                    <div class="loading-spinner"></div>
                    <div>Loading germination and inventory data...</div>
                </div>

                <!-- Empty State -->
                <div class="empty-state" id="emptyState" style="display: none;">
                    <div class="empty-state-icon">üìä</div>
                    <div class="empty-state-text">No data found</div>
                    <div class="empty-state-subtext">Try adjusting your filters or check that data has been entered</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Print Confirmation Modal -->
    <div class="modal" id="printModal">
        <div class="modal-content">
            <div class="modal-icon" id="modalIcon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6,9 6,2 18,2 18,9"></polyline>
                    <path d="M6,18H4a2,2,0,0,1-2-2V11a2,2,0,0,1,2-2H20a2,2,0,0,1,2,2v5a2,2,0,0,1-2,2H18"></path>
                    <polyline points="6,14 18,14 18,22 6,22 6,14"></polyline>
                </svg>
            </div>
            <h3 class="modal-title" id="modalTitle">Print Germination Label</h3>
            <div class="modal-message">
                <div id="modalText">Are you sure you want to print a germination sample label for:</div>
                <div class="modal-variety" id="modalVariety">Loading...</div>
                <div id="modalExtraText" style="display: none;">Do you wish to print another label?</div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" id="modalCancel">Cancel</button>
                <button class="modal-btn primary" id="modalConfirm">Print Label</button>
            </div>
        </div>
    </div>



    <div id="growout-modal" class="modal">
        <div class="modal-content">

            <div class="modal-title">
            Record Growout
            </div>

            <div class="modal-message">
            Record growout for
            <strong id="growout-variety-name"></strong>
            </div>

            <div class="growout-form">

            <div class="form-row">
                <label for="growout-grower">Grower</label>
                <select id="growout-grower">
                <option value="" disabled selected hidden>‚Äî Select grower ‚Äî</option>

                {% for grower in growers %}
                    <option value="{{ grower.code }}">
                    {{ grower.code }} ‚Äì {{ grower.name }}
                    </option>
                {% endfor %}
                </select>
            </div>

            <div class="form-row">
                <label for="growout-year">Year</label>
                <input
                type="text"
                id="growout-year"
                placeholder="YY"
                maxlength="2"
                pattern="\d{2}"
                />
            </div>

            <div class="form-row">
                <label for="growout-qty">Quantity (lbs)</label>
                <input
                type="number"
                id="growout-qty"
                step="0.01"
                />
            </div>

            <div class="form-row">
                <label for="growout-price">Price / lb</label>
                <input
                type="number"
                id="growout-price"
                step="0.01"
                />
            </div>

            </div> <!-- /.growout-form -->

            <div class="modal-buttons">
            <button type="button" class="modal-btn secondary" id="growout-cancel-btn">
                Cancel
            </button>
            <button type="button" class="modal-btn primary" id="growout-save-btn">
                Save
            </button>
            </div>

        </div>
    </div>



    <!-- Reprint/Resend Modal -->
    <div class="modal" id="reprintModal">
        <div class="modal-content">
            <div class="modal-icon warning">!</div>
            <h3 class="modal-title">Label Already Printed</h3>
            <div class="modal-message">
                <div>A germination sample label has already been printed for:</div>
                <div class="modal-variety" id="reprintModalVariety">Loading...</div>
                <div style="margin-top: 12px; font-size: 14px; color: #666;">
                    <strong>Reprint:</strong> Print additional labels (same sample)<br>
                    <strong>Resend:</strong> Send a new germination sample
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" id="reprintModalCancel">Cancel</button>
                <button class="modal-btn primary" id="reprintModalReprint">Reprint</button>
                <button class="modal-btn warning" id="reprintModalResend">Resend</button>
            </div>
        </div>
    </div>
    
    <!-- Bulk Confirmation Modal -->
    <div class="modal" id="bulkModal">
        <div class="modal-content">
            <div class="modal-icon bulk-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 7h-9"></path>
                    <path d="M14 17H5"></path>
                    <circle cx="17" cy="17" r="3"></circle>
                    <circle cx="7" cy="7" r="3"></circle>
                </svg>
            </div>
            <h3 class="modal-title">Confirm Bulk Stock on Website</h3>
            <div class="modal-message">
                <div>Are you sure you want to mark bulk stock as available on the website for:</div>
                <div class="modal-variety" id="bulkModalVariety">Loading...</div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" id="bulkModalCancel">Cancel</button>
                <button class="modal-btn primary" id="bulkModalConfirm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Sales Modal -->
    <div class="sales-modal" id="salesModal">
        <div class="sales-modal-content">
            <button class="sales-modal-close" id="salesModalClose">&times;</button>
            <h2 class="sales-modal-title" id="salesModalTitle">Sales Data</h2>
            
            <div id="salesContent">
                <div class="sales-loading" id="salesLoading">
                    <div class="sales-loading-spinner"></div>
                    <div>Loading sales data...</div>
                </div>
                
                <table class="sales-data-table" id="salesTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>Product SKU</th>
                            <th id="quantityHeader">Quantity Sold</th>
                        </tr>
                    </thead>
                    <tbody id="salesTableBody"></tbody>
                </table>
                
                <div class="sales-empty" id="salesEmpty" style="display: none;">
                    <div class="sales-empty-icon">üìä</div>
                    <div>No sales data found for this variety</div>
                </div>

                <!-- Current Inventory Section -->
                <div class="inventory-section" id="inventorySection" style="display: none;">
                    <div class="inventory-divider"></div>
                    <h3 class="inventory-title">Current Lot Inventory & Germination</h3>
                    <div class="inventory-container">
                        <table class="inventory-table">
                            <thead>
                                <tr>
                                    <th>Lot</th>
                                    <th id="germYear1Header">Year</th>
                                    <th id="germYear2Header">Year</th>
                                    <th id="germYear3Header">Year</th>
                                    <th>Inventory (lbs)</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTableBody"></tbody>
                            <tfoot>
                                <tr class="inventory-total-row">
                                    <td colspan="4" class="inventory-total-label">
                                        <div class="inventory-total-label-content">
                                            <span class="inventory-legend" id="inventoryLegend" style="display: none;"><span class="germ-pending">*</span>Out for germ</span>
                                            <span class="inventory-total-text">Total Inventory (lbs):</span>
                                        </div>
                                    </td>
                                    <td class="inventory-total-value" id="inventoryTotal"></td>
                                </tr>
                            </tfoot>
                        </table>
                 
                        <div class="inventory-empty" id="inventoryEmpty" style="display: none;">
                            <div>No active lots found for this variety</div>
                        </div>
                    </div>
                </div>

                <!-- Usage Section -->
                <div class="usage-section" id="usageSection" style="display: none;">
                    <div class="usage-divider"></div>
                    <h3 class="usage-title">Variety Usage</h3>
                    <div class="usage-container">
                        <div class="usage-loading" id="usageLoading">
                            <div class="usage-loading-spinner"></div>
                            <div>Calculating usage...</div>
                        </div>
                        
                        <div class="usage-content" id="usageContent" style="display: none;">
                            <div class="usage-summary">
                                <div class="usage-stat">
                                    <span class="usage-label">Sales Year:</span>
                                    <span class="usage-value" id="usageSeasonRange">--</span>
                                </div>
                                <div class="usage-stat">
                                    <span class="usage-label">Total Used:</span>
                                    <span class="usage-value usage-highlight" id="usageTotalLbs">--</span>
                                </div>
                                <div class="usage-stat">
                                    <span class="usage-label">Lots Tracked:</span>
                                    <span class="usage-value" id="usageLotCount">--</span>
                                </div>
                            </div>
                            
                            <!-- Lot details table (optional, can be collapsed) -->
                            <details class="usage-details">
                                <summary>View lot details</summary>
                                <table class="usage-lot-table">
                                    <thead>
                                        <tr>
                                            <th>Lot</th>
                                            <th>Start (lbs)</th>
                                            <th>End (lbs)</th>
                                            <th>Used (lbs)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usageLotTableBody"></tbody>
                                </table>
                            </details>
                        </div>
                        
                        <div class="usage-empty" id="usageEmpty" style="display: none;">
                            <div>No usage data available for this variety</div>
                        </div>
                    </div>
                </div>

                <!-- Wholesale Section -->
                <div class="wholesale-section" id="wholesaleSection" style="display: none;">
                    <div class="wholesale-divider"></div>
                    <div class="wholesale-container">
                        <label class="wholesale-checkbox-wrapper">
                            <input type="checkbox" id="wholesaleCheckbox" class="wholesale-checkbox-input">
                            <span class="wholesale-checkbox-custom"></span>
                            <span class="wholesale-label">Wholesale</span>
                        </label>

                        <!-- ADD THIS NEW CHECKBOX -->
                        <label class="wholesale-checkbox-wrapper">
                            <input type="checkbox" id="notAvailableCheckbox" class="wholesale-checkbox-input">
                            <span class="wholesale-checkbox-custom"></span>
                            <span class="wholesale-label">Not Available</span>
                        </label>
                        
                        <!-- NEW: Rack Type Selection -->
                        <div class="rack-type-container" id="rackTypeContainer" style="display: none;">
                            <div class="rack-type-options">
                                <label class="rack-option">
                                    <input type="radio" name="rackType" value="1" class="rack-radio">
                                    <span class="rack-label">1</span>
                                </label>
                                <label class="rack-option">
                                    <input type="radio" name="rackType" value="2" class="rack-radio">
                                    <span class="rack-label">2</span>
                                </label>
                                <label class="rack-option">
                                    <input type="radio" name="rackType" value="3" class="rack-radio">
                                    <span class="rack-label">3</span>
                                </label>
                                <label class="rack-option">
                                    <input type="radio" name="rackType" value="C" class="rack-radio">
                                    <span class="rack-label">C</span>
                                </label>
                            </div>
                        </div>
                        <button class="wholesale-save-btn" id="wholesaleSaveBtn">Save</button>
                    </div>
                </div>



                <!-- Growout Section -->
                {% comment %} <div class="growout-section" id="growoutSection" style="display: none;">
                    <div class="growout-container">
                        <span class="growout-label">Growout:</span>
                        <div class="growout-selection">
                            <button class="growout-box blank" data-value="" title="No status"></button>
                            <button class="growout-box green" data-value="green" title="Good to go"></button>
                            <button class="growout-box orange" data-value="orange" title="Needs attention"></button>
                            <button class="growout-box red" data-value="red" title="Priority"></button>
                        </div>
                    </div>
                </div> {% endcomment %}


            </div>
        </div>
    </div>

    <script>
        // Pass Django URLs to JavaScript
        window.appUrls = {
            germinationInventoryData: "{% url 'germination_inventory_data' %}",
            createGermSamplePrint: "{% url 'create_germ_sample_print' %}",
            varietySalesData: "{% url 'variety_sales_data' sku_prefix='PLACEHOLDER' %}",
            updateWebsiteBulk: "{% url 'update_website_bulk' %}"
        };
    </script>

    <!-- Load external JS -->
    <script src="{% static 'office/js/germination_inventory.js' %}"></script>
</body>
</html>