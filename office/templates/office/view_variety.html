{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Variety Lookup - Uprising Seeds</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px 0;
        }

        .container {
            max-width: 1600px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header Section */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px 20px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            gap: 30px;
            animation: fadeInUp 0.4s ease-out;
            position: relative;
            z-index: 1000; 
        }

        .header-left {
            flex: 1;
            min-width: 300px;
        }

        .top-row {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .dashboard-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            text-decoration: none;
            margin-bottom: 0;
            width: fit-content;
        }

        .dashboard-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .dashboard-btn svg {
            width: 16px;
            height: 16px;
        }

        .brand-section {
            margin-bottom: 0;
        }

        .brand-title {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }

        .brand-subtitle {
            font-size: 1rem;
            color: #666;
            font-weight: 500;
        }

        /* Search Bar */
        .search-container {
            position: relative;
            width: 100%;
            z-index: 10000;
        }

        .search-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 12px;
            font-size: 1rem;
            background: rgba(102, 126, 234, 0.05);
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: white;
        }

        .search-input::placeholder {
            color: #999;
            font-weight: 400;
        }

        .search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            z-index: 9999;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid rgba(102, 126, 234, 0.2);
            margin-top: 5px;
            display: none;
        }

        .search-dropdown.show {
            display: block;
        }

        .dropdown-item {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            transition: background 0.2s ease;
        }

        .dropdown-item:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-variety-name {
            font-weight: 600;
            color: #333;
            font-size: 0.95rem;
        }

        .dropdown-variety-type {
            color: #666;
            font-size: 0.85rem;
            margin-top: 2px;
        }

        /* Header Center - Variety Info */
        .header-center {
            flex: 1;
            text-align: center;
            min-width: 300px;
        }

        .variety-info {
            padding: 10px;
        }

        .variety-name {
            font-size: 2rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
            min-height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .variety-details {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .variety-detail {
            background: rgba(102, 126, 234, 0.1);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .variety-detail-label {
            color: #667eea;
            font-weight: 600;
        }

        .variety-detail-value {
            color: #333;
        }

        /* Header Right - Photo */
        .header-right {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            min-width: 150px;
            padding: 0;
        }

        .variety-photo-container {
            width: 150px;
            height: 150px;
            border-radius: 15px;
            overflow: hidden;
            background: rgba(102, 126, 234, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(102, 126, 234, 0.2);
            margin: -30px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .variety-photo-container:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .variety-photo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-placeholder {
            color: #667eea;
            font-weight: 600;
            text-align: center;
            font-size: 0.9rem;
        }

        /* Main Content Container */
        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            animation: fadeInUp 0.8s ease-out;
        }
        
        .edit-icon {
            cursor: pointer;
            color: #667eea;
            margin-left: 8px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            opacity: 0.6;
        }

        .edit-icon:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #764ba2;
            opacity: 1;
            transform: scale(1.1);
        }

        .edit-icon svg {
            width: 14px;
            height: 14px;
        }

        .lot-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .lot-option-btn {
            padding: 12px 16px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            background: rgba(102, 126, 234, 0.05);
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .lot-option-btn:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .lot-option-btn.no-lot {
            background: rgba(255, 0, 0, 0.05);
            border-color: rgba(255, 0, 0, 0.2);
        }

        /* Left Side - Tables Container */
        .tables-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        /* Right Side - Label Info Section */
        .label-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            height: fit-content;
        }

        .label-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .label-group {
            margin-bottom: 30px;
        }

        .label-group:last-child {
            margin-bottom: 0;
        }

        .label-group-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .label-line {
            margin-bottom: 8px;
            padding: 8px 12px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }

        .label-line:last-child {
            margin-bottom: 0;
        }

        .label-line-empty {
            color: #999;
            font-style: italic;
        }

        .label-edit-section {
            margin-bottom: 25px;
            padding: 15px;
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 8px;
            background: rgba(102, 126, 234, 0.02);
        }

        .label-edit-section h4 {
            margin-bottom: 15px;
            color: #667eea;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9rem;
        }

        .label-edit-section .form-group {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .label-edit-section .form-group:last-child {
            margin-bottom: 0;
        }

        .label-edit-section .form-group label {
            width: 60px;
            text-align: right;
            font-weight: 500;
            color: #555;
            flex-shrink: 0;
        }

        .label-edit-section input {
            flex: 1;
            min-width: 300px;
        }

        .label-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            position: relative; /* Add this */
        }

        .days-line {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-left: 3px solid #764ba2;
        }

        .days-line strong {
            font-weight: 600;
        }

        .table-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .table-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .product-cell-content {
            display: flex;
            align-items: center;
            gap: 8px; /* Even spacing between all elements */
        }

        .product-cell-content .print-icon,
        .product-cell-content .edit-icon {
            margin: 0; /* Remove any existing margins */
            flex-shrink: 0; /* Don't shrink the icons */
        }

        .product-sku {
            flex: 1; /* Take up remaining space */
            min-width: 0; /* Allow text to shrink if needed */
        }

        /* Center all columns in products table */
        .products-table th,
        .products-table td {
            text-align: center;
        }

        /* Left-align the first column (Product) in products table */
        .products-table th:first-child,
        .products-table td:first-child {
            text-align: left;
        }


        /* Keep your existing rule */
        .lots-table th:first-child,
        .lots-table td:first-child {
            text-align: left;
        }

        /* Add this new rule */
        .lots-table td:first-child {
            padding-left: 12px; /* Match the products table padding */
        }

        .lots-table .edit-icon {
            margin-left: 0; /* Remove any left margin */
            margin-right: 8px; /* Add consistent spacing after icon */
        }

        .lots-table th:not(:first-child),
        .lots-table td:not(:first-child) {
            text-align: center;
        }

        .data-table thead {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }


        .data-table thead th {
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .products-table thead th { 
            text-align: center; 
        }

        .data-table tbody tr {
            background: white;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .data-table tbody tr:hover {
            background: rgba(102, 126, 234, 0.03);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        .data-table tbody tr:last-child {
            border-bottom: none;
        }

        .data-table tbody td {
            padding: 15px 12px;
            font-size: 0.9rem;
            color: #555;
            vertical-align: top;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            font-style: italic;
        }

        .boolean-indicator {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-weight: bold;
            font-size: 0.75rem;
        }

        .boolean-true {
            background: #10ac84;
            color: white;
        }

        .boolean-false {
            background: #ddd;
            color: #666;
        }

        /* Print Icon */
        .print-icon {
            cursor: pointer;
            color: #667eea;
            margin-right: 8px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 4px;
        }

        .print-icon:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #764ba2;
            transform: scale(1.1);
        }

        .print-icon svg {
            width: 16px;
            height: 16px;
        }

        /* Print Popup */
        .print-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .print-popup-overlay.show {
            display: flex;
        }

        .print-popup {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: popupSlideIn 0.3s ease-out;
        }

        .print-popup-header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
        }

        .print-popup-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #333;
            text-align: center;
        }

        .print-popup-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #999;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            position: absolute;
            right: -20px;  /* Move more to the right */
            top: -20px;
        }

        .print-popup-close:hover {
            background: rgba(0, 0, 0, 0.1);
            color: #333;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            overflow-y: auto;
        }

        .modal-overlay.show {
            display: flex;
        }

         .modal {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: popupSlideIn 0.3s ease-out;
            position: relative;
        }

        .modal-open {
            overflow: hidden;
            width: 100vw;
            max-width: 100vw;
        }
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #999;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .close-modal:hover {
            background: rgba(0, 0, 0, 0.1);
            color: #333;
        }

        .modal-header {
            margin-bottom: 25px;
            text-align: center;
        }

        .modal-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #333;
            margin: 0;
        }

        .success-message {
            background: #f0fdf4;
            border: 1px solid #10ac84;
            border-left: 4px solid #10ac84;
            color: #065f46;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

         .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group label {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            font-size: 0.9rem;
            text-align: left;
        }

        .form-group input:not([type="checkbox"]),
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
            box-sizing: border-box;
            text-align: left;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group input[readonly] {
            background: #f8f9fa;
            color: #666;
        }

        .checkbox-group {
            flex-direction: row;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .checkbox-group label {
            margin: 0;
            font-weight: 500;
        }

        /* Field width classes */
        .field-narrow {
            width: 150px !important;
            max-width: 150px;
        }

        .field-medium {
            width: 200px !important;
            max-width: 200px;
        }

        .field-wide {
            width: 100% !important;
        }

        .error-message {
            color: #dc3545;
            font-size: 0.85rem;
            margin-top: 4px;
            display: none;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            padding-top: 20px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.95rem;
        }

        .btn-secondary {
            background: #f1f3f4;
            color: #666;
        }

        .btn-secondary:hover {
            background: #e8eaed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .print-quantity-container {
            margin-bottom: 25px;
            text-align: center; 
        }

        .print-quantity-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            display: block;
        }

        .print-quantity-input {
            width: 80px;
            padding: 12px 16px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
            text-align: center;
        }

        .print-quantity-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .print-inputs-row {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: flex-end;
            margin-bottom: 25px;
        }

        .print-inputs-row .print-quantity-container {
            margin-bottom: 0; /* Remove bottom margin since parent handles spacing */
            flex: 0 0 auto; /* Don't grow or shrink */
        }

        /* Make sure the year select has consistent width */
        #packedForYearSelect {
            width: 110px; /* Slightly wider for "20XX" format */
        }

        #packedForYearInput {
            width: 110px; /* Match the select width */
        }

        .print-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 25px;
        }

        .print-option-btn {
            padding: 12px 16px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            background: rgba(102, 126, 234, 0.05);
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .print-option-btn:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .print-option-btn.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .print-actions {
            display: flex;
            gap: 12px;
        }

        .print-action-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .print-btn {
            background: #4CAF50;  /* Matte green */
            color: white;
        }

        .print-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);  /* Green shadow */
            background: #45a049;  /* Slightly darker green on hover */
        }

        .cancel-btn {
            background: #ffcdd2;  /* Light red */
            color: #d32f2f;  /* Darker red text */
        }

        .cancel-btn:hover {
            background: #ef9a9a;  /* Slightly darker light red on hover */
        }

        /* Photo Popup */
        .photo-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .photo-popup-overlay.show {
            display: flex;
        }

        .photo-popup {
            background: white;
            border-radius: 20px;
            padding: 20px;
            max-width: 90vw;
            max-height: 90vh;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.4);
            animation: popupSlideIn 0.3s ease-out;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .photo-popup-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.5);
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .photo-popup-close:hover {
            background: rgba(0, 0, 0, 0.7);
            transform: scale(1.1);
        }

        .photo-popup-image {
            max-width: 100%;
            max-height: 70vh;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .photo-popup-caption {
            margin-top: 20px;
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
            text-align: center;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .photo-popup-placeholder {
            width: 300px;
            height: 300px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #667eea;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .add-icon {
            cursor: pointer;
            color: #667eea;
            margin-left: 10px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            opacity: 0.7;
        }

        .add-icon:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #764ba2;
            opacity: 1;
            transform: scale(1.1);
        }

        .add-icon svg {
            width: 18px;
            height: 18px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            width: 100%;
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .form-group input,
        .form-group select {
            width: 180px;
            padding: 10px 12px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
            margin: 0;
            display: block;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group select {
            width: 200px;
        }

        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
            resize: vertical;
            font-family: inherit;
        }

        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Hide spinners only for the lbs remaining input */
        #retireLbsInput::-webkit-outer-spin-button,
        #retireLbsInput::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        #retireLbsInput {
            -moz-appearance: textfield;
            -webkit-appearance: textfield;
            text-align: center;
        }

        #stockSeedQtyInput {
            width: 200px;
            text-align: center;
        }

        #stockSeedNotesInput {
            width: 100%;
            height: 120px;
        }

        #germinationRateInput {
            width: 120px;
            text-align: center;
        }

        #germinationDateInput {
            width: 160px;
        }

        .lot-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .lot-action-btn {
            padding: 12px 20px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            background: rgba(102, 126, 234, 0.05);
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .lot-action-btn:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .lot-action-btn.delete-btn {
            background: rgba(255, 0, 0, 0.05);
            border-color: rgba(255, 0, 0, 0.2);
            color: #dc3545;
        }

        .lot-action-btn.delete-btn:hover {
            background: rgba(255, 0, 0, 0.1);
            border-color: rgba(255, 0, 0, 0.3);
        }

        .delete-confirm-btn {
            background: #dc3545;
            color: white;
        }

        .delete-confirm-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }


        .status-btn-current {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .status-btn-available {
            background: #f1f3f4;
            color: #666;
        }

        .status-btn-available:hover {
            background: #e8eaed;
        }


        .messages-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 5000;
            max-width: 400px;
        }

        .message {
            background: white;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #ccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideInRight 0.3s ease-out;
        }

        .message-success {
            border-left-color: #10ac84;
            background: #f0fdf4;
        }

        .message-error {
            border-left-color: #ff6b6b;
            background: #fef2f2;
        }

        .message-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: #666;
            cursor: pointer;
            margin-left: 10px;
        }

        .data-table thead th:first-child {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Add-icon in table header - white color for visibility */
        .data-table thead .add-icon {
            color: white;
            opacity: 1;
            margin-left: 0; /* Override the default margin-left: 10px */
            flex-shrink: 0;
        }

        .data-table thead .add-icon:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #f0f0f0;
            opacity: 1;
            transform: scale(1.1);
        }


        /* Change All Products Checkbox Styling */
        .change-all-checkbox-container {
            margin-bottom: 20px;
            padding: 15px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 12px;
            background: rgba(102, 126, 234, 0.05);
            text-align: center;
        }

        .change-all-checkbox-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            cursor: pointer;
            font-weight: 500;
            color: #333;
            font-size: 0.95rem;
        }

        .change-all-checkbox {
            width: 18px;
            height: 18px;
            accent-color: #667eea;
            cursor: pointer;
            margin: 0;
        }

        .checkbox-text {
            user-select: none;
        }

        .change-all-checkbox-label:hover {
            color: #667eea;
        }

        .change-all-checkbox-container:has(.change-all-checkbox:checked) {
            background: rgba(102, 126, 234, 0.1);
            border-color: rgba(102, 126, 234, 0.4);
        }





        /* Lot History Popup Styles */
        .lot-history-modal {
            max-width: 500px; /* Narrower popup */
            max-height: 90vh;
            overflow-y: auto;
        }

        .lot-history-content {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .history-section {
            background: rgba(102, 126, 234, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.1);
            overflow: hidden;
        }

        .history-section-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 20px;
        }

        .history-section-header h3 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .history-section-content {
            padding: 20px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(102, 126, 234, 0.1);
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #333;
            min-width: 120px;
            text-align: left;
        }

        .info-value {
            color: #555;
            text-align: right;
            flex: 1;
        }

        /* Status indicators for lot history popup only */
        .lot-status-indicator {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            text-align: center !important;
            min-width: 40px;
            max-width: 40px;
            flex: none !important;
        }

        .lot-status-indicator.true {
            background: #ffcdd2;
            color: #d32f2f;
        }

        .lot-status-indicator.false {
            background: #c8e6c9;
            color: #388e3c;
        }

        .lot-status-indicator.retired {
            background: #ffecb3;
            color: #f57c00;
        }

        /* Single-line record format */
        .record-item {
            background: white;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid rgba(102, 126, 234, 0.1);
            margin-bottom: 8px;
            border-left: 3px solid transparent; 
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative; /* Make sure this line exists */
        }

        .record-item:last-child {
            margin-bottom: 0;
        }

        .record-main-info {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
        }

        /* .record-date {
            font-weight: 600;
            color: #667eea;
            font-size: 0.9rem;
            min-width: 80px;
        } */
         .record-date {
            font-weight: 600;
            color: #667eea;
            font-size: 0.9rem;
            min-width: 90px;  /* Increased to accommodate full date */
            flex-shrink: 0;
        }

        /* .record-detail {
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 100px;
        } */

        .record-detail {
            display: flex;
            align-items: center;
            gap: 6px;
            width: 85px; /* Fixed width for consistency */
        }

        .record-detail-label {
            font-size: 0.8rem;
            color: #666;
            font-weight: 500;
        }

        .record-detail-value {
            font-weight: 600;
            color: #333;
            white-space: nowrap;
        }

        .record-status {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            min-width: 60px;
            text-align: center;
        }

        .record-status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .record-status.active {
            background: #d4edda;
            color: #155724;
        }

        /* Notes section for records */
        .record-notes {
            margin-top: 8px;
            padding: 8px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 6px;
            font-style: italic;
            color: #666;
            font-size: 0.9rem;
            border-top: 1px solid rgba(102, 126, 234, 0.1);
        }

        /* Stock seed specific layout */
        .stock-record-item {
            background: white;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid rgba(102, 126, 234, 0.1);
            margin-bottom: 8px;
        }

        .stock-record-item:last-child {
            margin-bottom: 0;
        }

        .stock-record-main {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .no-records {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 20px;
        }

        .note-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid #667eea;
            margin-bottom: 10px;
        }

        .note-item:last-child {
            margin-bottom: 0;
        }

        .note-date {
            font-size: 0.8rem;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .note-text {
            color: #333;
            line-height: 1.4;
        }

        /* Packing history year headers */
        .packing-year-header {
            margin: 20px 0 10px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.2);
        }

        .packing-year-header:first-child {
            margin-top: 0;
        }

        .packing-year-header h4 {
            margin: 0;
            color: #667eea;
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Spacing between year groups */
        .year-group-spacing {
            height: 15px;
        }

        /* Only indent record items within packing history section */
        #packingHistoryContent .packing-year-header + .record-item,
        #packingHistoryContent .record-item + .record-item {
            margin-left: 15px;
        }

        /* Loading/Disabled button states */
        .print-action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed !important;
            pointer-events: none;
        }

        .print-action-btn.loading:disabled {
            cursor: wait !important;
            pointer-events: none;
        }

        /* Spinning cursor for the entire popup during loading */
        .print-popup.loading {
            cursor: wait !important;
        }

        .print-popup.loading * {
            cursor: wait !important;
        }

        /* Loading spinner for print button */
        .print-btn.loading::after {
            content: "";
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-left: 8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }


        /* Clickable row with note */
        .record-item.has-note {
            cursor: pointer;
            transition: background-color 0.2s ease;
            background: rgba(102, 126, 234, 0.03);
            border-left-color: #667eea;
        }

        .record-item.has-note:hover {
            background: rgba(102, 126, 234, 0.08);
            border-color: rgba(102, 126, 234, 0.2);
        }

        /* Note popup */
        .note-popup {
            position: fixed;
            background: white;
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 15px;
            max-width: 350px;
            min-width: 200px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            display: none;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .note-popup.show {
            display: block;
        }

        .note-popup-content {
            color: #333;
            margin-bottom: 10px;
        }

        .note-popup-close {
            position: absolute;
            top: 5px;
            right: 8px;
            background: none;
            border: none;
            font-size: 1.2rem;
            color: #999;
            cursor: pointer;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .note-popup-close:hover {
            color: #333;
        }



        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes popupSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }



        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive design */
        @media (max-width: 1200px) {
            .header {
                flex-direction: column;
                gap: 20px;
            }

            .header-left, .header-center, .header-right {
                min-width: auto;
                width: 100%;
            }

            .main-content {
                grid-template-columns: 1fr;
            }

            .header-right {
                display: none;
            }

            .print-options {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .variety-details {
                flex-direction: column;
                align-items: center;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .field-narrow,
            .field-medium {
                width: 100% !important;
                max-width: 100%;
            }
            
            .header-right {
                display: none;
            }

            /* Fix ALL modal overlays */
            .modal-overlay,
            .print-popup-overlay,
            .photo-popup-overlay {
                padding: 0;
                align-items: flex-start;
                justify-content: flex-start;
            }
            
             /* Fix ALL modal content */
            .modal,
            .print-popup,
            .photo-popup {
                width: 100vw;
                height: 100vh;
                max-width: 100vw;
                max-height: 100vh;
                border-radius: 0;
                padding: 20px;
                margin: 0;
                position: fixed;
                top: 0;
                left: 0;
                overflow-y: auto;
            }

            /* Special handling for photo popup to maintain aspect ratio */
            .photo-popup {
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }

            .lot-history-modal {
                width: 100vw;
                height: 100vh;
                max-width: 100vw;
                max-height: 100vh;
                border-radius: 0;
                padding: 15px;
            }
            
            .info-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
            
            .info-label {
                min-width: auto;
            }
            
            .info-value {
                text-align: left;
            }
            
            .lot-status-indicator {
                align-self: flex-start;
            }
            
            .record-main-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .record-detail {
                min-width: auto;
            }
            
            .stock-record-main {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
        }
      
    </style>
</head>

<body>
    <div class="container">
        <!-- Header Section -->
        <div class="header">
            <!-- Left: Brand and Search -->
            <div class="header-left">
                <div class="top-row">
                    <button class="dashboard-btn" onclick="goToDashboard()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 12H5M12 19l-7-7 7-7"/>
                        </svg>
                        Dashboard
                    </button>
                    
                    <div class="brand-section">
                        <h1 class="brand-title">Variety Lookup</h1>
                    </div>
                </div>
                            
                <div class="search-container">
                    <input type="text" class="search-input" id="varietySearch" placeholder="Search varieties..." autocomplete="off">
                    <div class="search-dropdown" id="searchDropdown">
                        <!-- Dropdown items will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Center: Variety Info -->
            <div class="header-center">
                <div class="variety-info">
                    <div class="variety-name" id="varietyName">
                        {% if variety %}{{ variety.var_name|default:"Select a variety" }}{% else %}Select a variety{% endif %}
                    </div>
                    <div class="variety-details">
                        <div class="variety-detail">
                            <span class="variety-detail-label">SKU:</span>
                            <span class="variety-detail-value" id="varietySku">{% if variety %}{{ variety.sku_prefix }}{% else %}--{% endif %}</span>
                        </div>
                        <div class="variety-detail">
                            <span class="variety-detail-label">Type:</span>
                            <span class="variety-detail-value" id="varietyType">{% if variety %}{{ variety.veg_type|default:"--" }}{% else %}--{% endif %}</span>
                        </div>
                        {% if variety and variety.days %}
                        <div class="variety-detail">
                            <span class="variety-detail-value">{{ variety.days }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Right: Photo -->
            <div class="header-right">
                <div class="variety-photo-container" onclick="showPhotoPopup()">
                    {% if variety and variety.photo_path %}
                        <img src="{% static variety.photo_path %}" alt="{{ variety.var_name }}" class="variety-photo" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="photo-placeholder" style="display: none;">
                            Photo Not<br>Found
                        </div>
                    {% else %}
                        <div class="photo-placeholder">
                            No Photo<br>Available
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>


        <!-- Add this after the header section -->
        {% if messages %}
            <div class="messages-container">
                {% for message in messages %}
                    <div class="message message-{{ message.tags }}">
                        <span class="message-text">{{ message }}</span>
                        <button class="message-close" onclick="this.parentElement.remove()">×</button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <!-- Main Content: Tables on Left, Labels on Right -->
        <div class="main-content">
            <!-- Left Side: Tables Container -->
            <div class="tables-container">
                <!-- Products Table -->
                <div class="table-section">
                    {% if products %}
                    <div class="table-wrapper">
                        <table class="data-table products-table">
                            <thead>
                                <tr>
                                    <th>
                                        Product
                                        <span class="add-icon" onclick="showAddProductPopup()">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="12" cy="12" r="10"></circle>
                                                <line x1="12" y1="8" x2="12" y2="16"></line>
                                                <line x1="8" y1="12" x2="16" y2="12"></line>
                                            </svg>
                                        </span>
                                    </th>
                                    <th>Lot</th>
                                    <th>YTD Sales</th>
                                    <th>Last Year Sales</th>
                                    <th># Printed</th>
                                    <th>Env. Type</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for product in products %}
                                    <tr data-product-id="{{ product.pk }}"
                                        data-variety-name="{{ product.variety.var_name }}"
                                        data-crop="{{ product.variety.crop|default:'' }}"
                                        data-days="{{ product.variety.days|default:'' }}"
                                        data-sku-suffix="{{ product.sku_suffix|default:'' }}"
                                        data-pkg-size="{{ product.pkg_size|default:'' }}"
                                        data-env-type="{{ product.env_type|default:'' }}"
                                        data-alt-sku="{{ product.alt_sku|default:'' }}"
                                        data-lineitem-name="{{ product.lineitem_name|default:'' }}"
                                        data-rack-location="{{ product.rack_location|default:'' }}"
                                        data-env-multiplier="{{ product.env_multiplier|default:'' }}"
                                        data-scoop-size="{{ product.scoop_size|default:'' }}"
                                        data-print-back="{{ product.print_back|yesno:'true,false' }}"
                                        data-is-sub-product="{{ product.is_sub_product|yesno:'true,false' }}"
                                        data-rad-type="{{ product.variety.get_rad_type|default:'' }}"
                                        data-desc1="{{ product.variety.desc_line1|default:'' }}"
                                        data-desc2="{{ product.variety.desc_line2|default:'' }}"
                                        data-desc3="{{ product.variety.desc_line3|default:'' }}"
                                        data-back1="{{ product.variety.back1|default:'' }}"
                                        data-back2="{{ product.variety.back2|default:'' }}"
                                        data-back3="{{ product.variety.back3|default:'' }}"
                                        data-back4="{{ product.variety.back4|default:'' }}"
                                        data-back5="{{ product.variety.back5|default:'' }}"
                                        data-back6="{{ product.variety.back6|default:'' }}"
                                        data-back7="{{ product.variety.back7|default:'' }}"
                                        data-lot-code="{% if product.lot %}{% if product.lot.grower and product.lot.year %}{{ product.lot.grower }}{{ product.lot.year }}{% if product.lot.harvest %}{{ product.lot.harvest }}{% endif %}{% endif %}{% endif %}"
                                        data-germination="{% if product.lot %}{{ product.lot.get_most_recent_germ_percent|default:'' }}{% endif %}"
                                        data-lot-for-year="{% if product.lot %}{{ product.lot.get_most_recent_germ_for_year|default:'' }}{% endif %}"
                                        data-for-year="25"
                                        data-last-print-date="{{ product.get_last_print_date }}">
                                        <td>
                                            <div class="product-cell-content">
                                                <span class="print-icon" onclick="showPrintPopup('{{ product.pk }}', '{{ product.variety.var_name|escapejs }} - {{ product.sku_suffix|escapejs }}')">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <polyline points="6,9 6,2 18,2 18,9"></polyline>
                                                        <path d="M6,18H4a2,2,0,0,1-2-2V11a2,2,0,0,1,2-2H20a2,2,0,0,1,2,2v5a2,2,0,0,1-2,2H18"></path>
                                                        <polyline points="6,14 18,14 18,22 6,22 6,14"></polyline>
                                                    </svg>
                                                </span>
                                                <span class="edit-icon" onclick="showProductActionsPopup('{{ product.pk }}')">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                                    </svg>
                                                </span>
                                                <span class="product-sku">{{ product.sku_suffix|default:"--" }}</span>
                                            </div>
                                        </td>
                                        <td>
                                            {% if product.lot %}
                                                {% if product.lot.grower and product.lot.year %}
                                                    {{ product.lot.grower }}{{ product.lot.year }}{% if product.lot.harvest %}{{ product.lot.harvest }}{% endif %}
                                                {% else %}
                                                    --
                                                {% endif %}
                                            {% else %}
                                                --
                                            {% endif %}
                                            <!-- <span class="edit-icon" onclick="editProductLot('{{ product.pk }}')">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                                </svg>
                                            </span> -->
                                        </td>
                                        <td>{{ product.get_ytd_sales|default:"--" }}</td>
                                        <td>{{ product.get_last_year_sales|default:"--" }}</td>
                                        <td>{{ product.get_total_printed|default:"0" }}</td>
                                        <td>{{ product.env_type|default:"--" }}</td>
                                    </tr>
                                    {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="empty-state">
                        No products found for this variety
                    </div>
                    {% endif %}
                </div>

                 <!-- Lots Table -->
                <div class="table-section">
                    <div class="table-wrapper">
                        <table class="data-table lots-table">
                            <thead>
                                <tr>
                                    <th>
                                        Lot
                                        <span class="add-icon" onclick="showAddLotPopup()">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="12" cy="12" r="10"></circle>
                                                <line x1="12" y1="8" x2="12" y2="16"></line>
                                                <line x1="8" y1="12" x2="16" y2="12"></line>
                                            </svg>
                                        </span>
                                    </th>
                                    <th>Germ</th>
                                    <th>Inventory</th>
                                    <th>Status</th>
                                    <th>Low Inventory</th>
                                    <th>Stock</th>
                                </tr>
                            </thead>
                            {% if lots %}
                            <tbody>
                                {% for lot in lots %}
                                <tr>
                                    <td>
                                        <span class="edit-icon" data-lot-id="{{ lot.pk }}" data-low-inv="{{ lot.low_inv|yesno:'true,false' }}" onclick="showLotActionsPopup(this)">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                            </svg>
                                        </span>
                                        {% if lot.grower and lot.year %}
                                            {{ lot.grower }}{{ lot.year }}{% if lot.harvest %}{{ lot.harvest }}{% endif %}
                                        {% else %}
                                            --
                                        {% endif %}
                                    </td>
                                    <td>
                                        {{ lot.get_most_recent_germ_percent_with_year|default:"--" }}
                                        {% if lot.get_germ_record_with_no_test_date %}*{% endif %}
                                    </td>
                                    <td>{{ lot.get_most_recent_inventory|default:"--" }}</td>
                                    <td>{{ lot.get_lot_status|default:"--" }}</td>
                                    <td>
                                        {% if lot.low_inv %}
                                            Yes
                                        {% else %}
                                            No
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if lot.check_stock_seed %}
                                            Yes
                                        {% else %}
                                            No
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            {% endif %}
                        </table>
                    </div>
                    
                    {% if not lots %}
                    <div class="empty-state">
                        No lots found for this variety
                    </div>
                    {% endif %}
                    
                    {% if has_pending_germ %}
                        <div style="margin-top: 15px; margin-bottom: -15px; padding: 12px 20px; font-size: 0.9rem; color: #666; font-style: italic;">
                            * A new germination sample has been sent to the lab for testing
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Right Side: Label Info Section -->
            <div class="label-section">
                <div class="label-content">
                    <div class="label-group">
                        <div class="label-group-title">
                            Front Label
                            <span class="edit-icon" onclick="showEditFrontLabelsPopup()" style="margin-left: 10px;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                            </span>
                        </div>
                        {% if variety %}
                            <div class="label-line">
                                {% if variety.desc_line1 %}{{ variety.desc_line1 }}{% else %}<span class="label-line-empty">Line 1 not set</span>{% endif %}
                            </div>
                            <div class="label-line">
                                {% if variety.desc_line2 %}{{ variety.desc_line2 }}{% else %}<span class="label-line-empty">Line 2 not set</span>{% endif %}
                            </div>
                            {% if variety.desc_line3 %}
                            <div class="label-line">
                                {{ variety.desc_line3 }}
                            </div>
                            {% endif %}
                        {% else %}
                            <div class="label-line"><span class="label-line-empty">No variety selected</span></div>
                        {% endif %}
                    </div>

                    <div class="label-group">
                        <div class="label-group-title">
                            Back Label
                            <span class="edit-icon" onclick="showEditBackLabelsPopup()" style="margin-left: 10px;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                            </span>
                        </div>
                        {% if variety %}
                            <div class="label-line">
                                {% if variety.back1 %}{{ variety.back1 }}{% else %}<span class="label-line-empty">Back line 1 not set</span>{% endif %}
                            </div>
                            <div class="label-line">
                                {% if variety.back2 %}{{ variety.back2 }}{% else %}<span class="label-line-empty">Back line 2 not set</span>{% endif %}
                            </div>
                            <div class="label-line">
                                {% if variety.back3 %}{{ variety.back3 }}{% else %}<span class="label-line-empty">Back line 3 not set</span>{% endif %}
                            </div>
                            <div class="label-line">
                                {% if variety.back4 %}{{ variety.back4 }}{% else %}<span class="label-line-empty">Back line 4 not set</span>{% endif %}
                            </div>
                            <div class="label-line">
                                {% if variety.back5 %}{{ variety.back5 }}{% else %}<span class="label-line-empty">Back line 5 not set</span>{% endif %}
                            </div>
                            <div class="label-line">
                                {% if variety.back6 %}{{ variety.back6 }}{% else %}<span class="label-line-empty">Back line 6 not set</span>{% endif %}
                            </div>
                            <div class="label-line">
                                {% if variety.back7 %}{{ variety.back7 }}{% else %}<span class="label-line-empty">Back line 7 not set</span>{% endif %}
                            </div>
                        {% else %}
                            <div class="label-line"><span class="label-line-empty">No variety selected</span></div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Popup -->
    <div class="photo-popup-overlay" id="photoPopupOverlay">
        <div class="photo-popup">
            <button class="photo-popup-close" onclick="hidePhotoPopup()">×</button>
            
            {% if variety and variety.photo_path %}
                <img src="{% static variety.photo_path %}" alt="{{ variety.var_name }}" class="photo-popup-image" id="photoPopupImage" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="photo-popup-placeholder" style="display: none;">
                    Photo Not Found
                </div>
            {% else %}
                <div class="photo-popup-placeholder">
                    No Photo Available
                </div>
            {% endif %}
            
            <div class="photo-popup-caption" id="photoPopupCaption">
                {% if variety %}{{ variety.var_name }}{% else %}No variety selected{% endif %}
            </div>
        </div>
    </div>

    <!-- Print Popup -->

    <div class="print-popup-overlay" id="printPopupOverlay">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Print Labels</h3>
                <button class="print-popup-close" onclick="hidePrintPopup()">×</button>
            </div>
        
            <!-- Wrap both inputs in a flex container -->
            <div class="print-inputs-row">
                <div class="print-quantity-container">
                    <label class="print-quantity-label" for="printQuantity">Quantity:</label>
                    <input type="number" class="print-quantity-input" id="printQuantity" min="1" value="1">
                </div>
                <div class="print-quantity-container">
                    <label class="print-quantity-label" for="packedForYearSelect">Packed for year:</label>
                    <input type="text" class="print-quantity-input" id="packedForYearInput" style="display: none;" readonly>
                    <select class="print-quantity-input" id="packedForYearSelect" style="display: none;">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
            </div>

            <div class="print-options">
                <button class="print-option-btn selected" data-option="front_single">Front Single</button>
                <button class="print-option-btn" data-option="front_sheet">Front Sheet</button>
                <button class="print-option-btn" data-option="back_single">Back Single</button>
                <button class="print-option-btn" data-option="back_sheet">Back Sheet</button>
                <button class="print-option-btn" data-option="front_back_single">Front/Back Single</button>
                <button class="print-option-btn" data-option="front_back_sheet">Front/Back Sheet</button>
            </div>
        
            <div class="print-actions">
                <button class="print-action-btn cancel-btn" onclick="hidePrintPopup()">Cancel</button>
                <button class="print-action-btn print-btn" onclick="submitPrintJob()">Print</button>
            </div>
        </div>
    </div>

    <!-- Low Inventory Warning Popup -->
    <div class="print-popup-overlay" id="lowInventoryWarning">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Low Inventory Warning</h3>
                <button class="print-popup-close" onclick="hideLowInventoryWarning()">×</button>
            </div>
            <p style="text-align: center; margin-bottom: 25px; color: #ff6b6b;">
                This product is assigned to a lot with low inventory.<br>
                <strong>Do you want to continue printing?</strong>
            </p>
            <div class="print-actions">
                <button class="print-action-btn cancel-btn" onclick="hideLowInventoryWarning()">Cancel</button>
                <button class="print-action-btn print-btn" onclick="continuePrintDespiteLowInv()">Continue</button>
            </div>
        </div>
    </div>

    <!-- Recent Print Warning Popup -->
    <div class="print-popup-overlay" id="recentPrintWarning">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Recent Print Detected</h3>
                <button class="print-popup-close" onclick="hideRecentPrintWarning()">×</button>
            </div>
            <p style="text-align: center; margin-bottom: 25px; color: #ff6b6b;">
                This product was last printed on <strong id="lastPrintDateDisplay"></strong>.<br>
                <strong>Do you want to continue printing?</strong>
            </p>
            <div class="print-actions">
                <button class="print-action-btn cancel-btn" onclick="hideRecentPrintWarning()">Cancel</button>
                <button class="print-action-btn print-btn" onclick="continueRecentPrint()">Continue</button>
            </div>
        </div>
    </div>

    <!-- Pending Status Warning Popup -->
    <div class="print-popup-overlay" id="pendingStatusWarning">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Cannot Print</h3>
                <button class="print-popup-close" onclick="hidePendingStatusWarning()">×</button>
            </div>
            <p style="text-align: center; margin-bottom: 20px; color: #ff6b6b;">
                This product is assigned to a lot with pending status.<br>
                <strong>Please activate the lot before printing.</strong>
            </p>
            <div class="print-actions">
                <button class="print-action-btn cancel-btn" onclick="hidePendingStatusWarning()">OK</button>
            </div>
        </div>
    </div>

    <!-- Add Lot Popup -->
    <div class="print-popup-overlay" id="addLotPopup">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Add New Lot</h3>
                <button class="print-popup-close" onclick="hideAddLotPopup()">×</button>
            </div>
            
            <form id="addLotForm" onsubmit="submitAddLot(event)">
                <div class="form-group">
                    <label>Grower:</label>
                    <select id="lotGrowerSelect" required>
                        <option value="">Select grower</option>
                        <!-- {% for grower in growers %}
                            <option value="{{ grower.pk }}">{{ grower.code }}</option>
                        {% endfor %} -->
                        {% for grower in growers %}
                            <option value="{{ grower.pk }}" data-grower-code="{{ grower.code }}">{{ grower.code }} - {{ grower.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Year:</label>
                    <input type="text" id="lotYearInput" placeholder="two digit year" maxlength="2" required>
                </div>
                <div class="form-group">
                    <label>Harvest:</label>
                    <input type="text" id="lotHarvestInput" placeholder="A, B, C..." maxlength="1">
                </div>
                
                <div class="print-actions">
                    <button type="button" class="print-action-btn cancel-btn" onclick="hideAddLotPopup()">Cancel</button>
                    <button type="submit" class="print-action-btn print-btn">Add Lot</button>
                </div>
            </form>
        </div>
    </div>

    <!-- No Lot Warning Popup -->
    <div class="print-popup-overlay" id="noLotWarning">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Cannot Print</h3>
                <button class="print-popup-close" onclick="hideNoLotWarning()">×</button>
            </div>
            <p style="text-align: center; margin-bottom: 20px; color: #dc3545;">
                No lot detected for this product.<br>
                <strong>Please assign a lot before printing.</strong>
            </p>
            <div class="print-actions">
                <button class="print-action-btn cancel-btn" onclick="hideNoLotWarning()">OK</button>
            </div>
        </div>
    </div>

    <!-- Retired Lot Warning Popup -->
    <div class="print-popup-overlay" id="retiredLotWarning">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Cannot Print</h3>
                <button class="print-popup-close" onclick="hideRetiredLotWarning()">×</button>
            </div>
            <p style="text-align: center; margin-bottom: 20px;">This product is assigned to a retired lot.</p>
            <div class="print-actions">
                <button class="print-action-btn cancel-btn" onclick="hideRetiredLotWarning()">OK</button>
            </div>
        </div>
    </div>

    <!-- Product Actions Popup -->
    <div class="print-popup-overlay" id="productActionsPopup">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Product Actions</h3>
                <button class="print-popup-close" onclick="hideProductActionsPopup()">×</button>
            </div>
            
            <div class="lot-actions">
                <button class="lot-action-btn" onclick="changeProductLot(currentProductId)">Change Lot</button>
                <button class="lot-action-btn" onclick="editProduct(currentProductId)">Edit Product</button>
                <button class="lot-action-btn" onclick="viewProductPackingHistory(currentProductId)">View Packing History</button>
            </div>
        </div>
    </div>


    <!-- Edit Product Popup -->
    <div id="editProductPopup" class="modal-overlay">
        <div class="modal">
            <button class="close-modal" onclick="hideEditProductPopup()">&times;</button>
            <div class="modal-header">
                <h2 class="modal-title">Edit Product</h2>
            </div>

            <div id="editProductSuccessMessage" class="success-message" style="display: none;">
                Product updated successfully! 
            </div>

            <form id="editProductForm" onsubmit="submitEditProduct(event)">
                {% csrf_token %}
                <div class="form-grid">
                    <div class="form-group">
                        <label for="editProductVariety">Variety</label>
                        <input type="text" id="editProductVariety" name="variety" class="field-medium" readonly>
                    </div>

                    <div class="form-group">
                        <label for="editProductSkuSuffix">SKU Suffix *</label>
                        <select id="editProductSkuSuffix" name="sku_suffix" class="field-medium" required>
                            {% for suffix in sku_suffixes %}
                                <option value="{{ suffix }}">{{ suffix }}</option>
                            {% endfor %}
                        </select>
                        <div class="error-message" id="edit_sku_suffix_error"></div>
                    </div>

                    <div class="form-group">
                        <label for="editProductPkgSize">Package Size</label>
                        <select id="editProductPkgSize" name="pkg_size" class="field-narrow">
                            {% for size in pkg_sizes %}
                                <option value="{{ size }}">{{ size }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="editProductAltSku">Alternative SKU</label>
                        <input type="text" id="editProductAltSku" name="alt_sku" class="field-medium">
                    </div>

                    <div class="form-group">
                        <label for="editProductLineitemName">Line Item Name</label>
                        <input type="text" id="editProductLineitemName" name="lineitem_name" class="field-wide">
                    </div>

                    <div class="form-group">
                        <label for="editProductRackLocation">Rack Location</label>
                        <input type="text" id="editProductRackLocation" name="rack_location" class="field-medium">
                    </div>

                    <div class="form-group">
                        <label for="editProductEnvType">Envelope Type</label>
                        <select id="editProductEnvType" name="env_type" class="field-medium">
                            {% for env in env_types %}
                                <option value="{{ env }}">{{ env }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="editProductEnvMultiplier">Envelope Multiplier</label>
                        <input type="number" id="editProductEnvMultiplier" name="env_multiplier" value="1" class="field-narrow">
                    </div>

                    <div class="form-group">
                        <label for="editProductScoopSize">Scoop Size</label>
                        <input type="text" id="editProductScoopSize" name="scoop_size" class="field-medium">
                    </div>

                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="editProductPrintBack" name="print_back">
                        <label for="editProductPrintBack">Print Back</label>
                    </div>

                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="editProductIsSubProduct" name="is_sub_product">
                        <label for="editProductIsSubProduct">Is Sub Product</label>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideEditProductPopup()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Product</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Product Packing History Popup -->
    <div class="modal-overlay" id="productPackingHistoryPopup">
        <div class="modal lot-history-modal">
            <button class="close-modal" onclick="hideProductPackingHistoryPopup()">&times;</button>
                    
            <div class="lot-history-content">
                <!-- Basic Info Section -->
                <div class="history-section">
                    <div class="history-section-header">
                        <h3>Product Information</h3>
                    </div>
                    <div class="history-section-content">
                        <div class="info-row">
                            <span class="info-label">Variety:</span>
                            <span class="info-value" id="productHistoryVarietyName">--</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Product SKU:</span>
                            <span class="info-value" id="productHistorySkuDisplay">--</span>
                        </div> 
                    </div>
                </div>

                <!-- Packing History Section -->
                <div class="history-section">
                    <div class="history-section-header">
                        <h3>Print History</h3>
                    </div>
                    <div class="history-section-content">
                        <div id="productPackingHistoryContent">
                            <div class="no-records">No print records found</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lot Actions Popup -->
    <div class="print-popup-overlay" id="lotActionsPopup">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Lot Actions</h3>
                <button class="print-popup-close" onclick="hideLotActionsPopup()">×</button>
            </div>
            
            <div class="lot-actions">
                <button class="lot-action-btn" onclick="editLotLowInv(currentLotId, currentLotLowInv)">Set Low Inventory</button>
                <button class="lot-action-btn" onclick="retireLot(currentLotId)">Retire Lot</button>
                <button class="lot-action-btn" onclick="recordStockSeed(currentLotId)">Record Stock Seed</button>
                <button class="lot-action-btn" onclick="recordInventory(currentLotId)">Record Inventory</button>
                <button class="lot-action-btn" onclick="recordGermination(currentLotId)">Record Germination</button>
                <button class="lot-action-btn" onclick="changeLotStatus(currentLotId)">Change Status</button>
                <button class="lot-action-btn" onclick="viewLotUsage(currentLotId)">View Usage</button>
                <button class="lot-action-btn" onclick="viewLotHistory(currentLotId)">View History</button>
                <button class="lot-action-btn delete-btn" onclick="deleteLot(currentLotId)">Delete Lot</button>
            </div>
        </div>
    </div>


    <!-- Lot Selection Popup -->
    <div class="print-popup-overlay" id="lotSelectionPopup">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Select Lot</h3>
                <button class="print-popup-close" onclick="hideLotSelectionPopup()">×</button>
            </div>
            
            <!-- Add checkbox for changing all products -->
            <div class="change-all-checkbox-container">
                <label class="change-all-checkbox-label">
                    <input type="checkbox" id="changeAllProductsCheckbox" class="change-all-checkbox">
                    <span class="checkbox-text">Change lot for all products in this variety?</span>
                </label>
            </div>
            
            <div id="availableLots" class="lot-options">
                <!-- Lots will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Low Inventory Popup -->
    <div class="print-popup-overlay" id="lowInvPopup">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Set Low Inventory</h3>
                <button class="print-popup-close" onclick="hideLowInvPopup()">×</button>
            </div>
            
            <div class="print-actions">
                <button class="print-action-btn" id="lowInvYes" onclick="setLotLowInv(true)">Yes</button>
                <button class="print-action-btn" id="lowInvNo" onclick="setLotLowInv(false)">No</button>
            </div>
        </div>
    </div>

    <!-- Retire Lot Popup -->
    <div class="print-popup-overlay" id="retireLotPopup">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title" id="retireLotTitle">Retire Lot</h3>
                <button class="print-popup-close" onclick="hideRetireLotPopup()">×</button>
            </div>
            
            <form id="retireLotForm" onsubmit="submitRetireLot(event)">
                <div class="form-group">
                    <label>Lbs Remaining:</label>
                    <input type="number" id="retireLbsInput" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Retirement Date:</label>
                    <input type="date" id="retireDateInput">
                </div>
                <div class="form-group">
                    <label>Notes:</label>
                    <textarea id="retireNotesInput" rows="4" placeholder="Enter applicable notes..."></textarea>
                </div>
                
                <div class="print-actions">
                    <button type="button" class="print-action-btn cancel-btn" onclick="hideRetireLotPopup()">Cancel</button>
                    <button type="submit" class="print-action-btn delete-confirm-btn">Retire Lot</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Record Stock Seed Popup -->
    <div class="print-popup-overlay" id="stockSeedPopup">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title" id="stockSeedTitle">Record Stock Seed</h3>
                <button class="print-popup-close" onclick="hideStockSeedPopup()">×</button>
            </div>
            
            <form id="stockSeedForm" onsubmit="submitStockSeed(event)">
                <div class="form-group">
                    <label>Quantity:</label>
                    <input type="text" id="stockSeedQtyInput" placeholder="e.g. 5 lbs, 200g, etc." required>
                </div>
                <div class="form-group">
                    <label>Notes:</label>
                    <textarea id="stockSeedNotesInput" rows="5" placeholder="Enter stock seed notes..."></textarea>
                </div>
                
                <div class="print-actions">
                    <button type="button" class="print-action-btn cancel-btn" onclick="hideStockSeedPopup()">Cancel</button>
                    <button type="submit" class="print-action-btn print-btn">Record Stock Seed</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Reprint Stock Seed Label Popup -->
    <div class="print-popup-overlay" id="reprintStockSeedPopup">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Stock Seed Already Recorded</h3>
                <button class="print-popup-close" onclick="hideReprintStockSeedPopup()">×</button>
            </div>
            
            <p style="text-align: center; margin-bottom: 25px; color: #333;">
                Stock seed has already been recorded for this lot.<br>
                <strong>Would you like to reprint the stock seed label?</strong>
            </p>
            
            <div class="print-actions">
                <button class="print-action-btn cancel-btn" onclick="hideReprintStockSeedPopup()">Cancel</button>
                <button class="print-action-btn print-btn" onclick="reprintStockSeedLabel()">Reprint Label</button>
            </div>
        </div>
    </div>

    <!-- Record Germination Popup -->
    <div class="print-popup-overlay" id="germinationPopup">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title" id="germinationTitle">Record Germination</h3>
                <button class="print-popup-close" onclick="hideGerminationPopup()">×</button>
            </div>
            
            <form id="germinationForm" onsubmit="submitGermination(event)">
                <div class="form-group">
                    <label>Germination Rate (%):</label>
                    <input type="number" id="germinationRateInput" min="0" max="100" required>
                </div>
                <div class="form-group">
                    <label>Test Date:</label>
                    <input type="date" id="germinationDateInput">
                </div>
                <div class="form-group">
                    <label>Notes:</label>
                    <textarea id="germinationNotesInput" rows="4" placeholder="Enter germination test notes..."></textarea>
                </div>
                
                <div class="print-actions">
                    <button type="button" class="print-action-btn cancel-btn" onclick="hideGerminationPopup()">Cancel</button>
                    <button type="submit" class="print-action-btn print-btn">Record Germination</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Record Inventory Popup -->
    <div class="print-popup-overlay" id="inventoryPopup">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title" id="inventoryTitle">Record Inventory</h3>
                <button class="print-popup-close" onclick="hideInventoryPopup()">×</button>
            </div>
            
            <form id="inventoryForm" onsubmit="submitInventory(event)">
                <div class="form-group">
                    <label>Weight (lbs):</label>
                    <input type="number" id="inventoryWeightInput" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Inventory Date:</label>
                    <input type="date" id="inventoryDateInput">
                </div>
                <div class="form-group">
                    <label>Notes:</label>
                    <textarea id="inventoryNotesInput" rows="4" placeholder="Enter inventory notes..."></textarea>
                </div>
                
                <div class="print-actions">
                    <button type="button" class="print-action-btn cancel-btn" onclick="hideInventoryPopup()">Cancel</button>
                    <button type="submit" class="print-action-btn print-btn">Record Inventory</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Overwrite Inventory Popup -->
    <div class="print-popup-overlay" id="addOverwriteInventoryPopup">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Recent Inventory Exists</h3>
                <button class="print-popup-close" onclick="hideAddOverwriteInventoryPopup()">×</button>
            </div>
            
            <p style="text-align: center; margin-bottom: 20px;">
                Last inventory: <strong id="lastInventoryDisplay"></strong><br>
                Would you like to add to it or overwrite it?
            </p>
            
            <form id="addOverwriteInventoryForm" onsubmit="submitAddOverwriteInventory(event)">
                <div class="form-group">
                    <label>Weight (lbs):</label>
                    <input type="number" id="addOverwriteWeightInput" step="0.01" min="0" required>
                </div>
                
                <div class="print-actions" style="display: flex; gap: 8px;">
                    <button type="button" class="print-action-btn cancel-btn" onclick="hideAddOverwriteInventoryPopup()">Cancel</button>
                    <button type="submit" name="action" value="add" class="print-action-btn print-btn" style="flex: 1;">Add to Existing</button>
                    <button type="submit" name="action" value="overwrite" class="print-action-btn print-btn" style="flex: 1; background: #ff9800;">Overwrite</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Lot History Popup -->
    <div class="modal-overlay" id="lotHistoryPopup">
        <div class="modal lot-history-modal">
            <button class="close-modal" onclick="hideLotHistoryPopup()">&times;</button>
            
            <div class="lot-history-content">
                <!-- Basic Info Section -->
                <div class="history-section">
                    <div class="history-section-header">
                        <h3>Lot Information</h3>
                    </div>
                    <div class="history-section-content">
                        <div class="info-row">
                            <span class="info-label">Variety:</span>
                            <span class="info-value" id="historyVarietyName">--</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Lot ID:</span>
                            <span class="info-value" id="historySkuDisplay">--</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Low Inventory:</span>
                            <span class="info-value lot-status-indicator" id="historyLowInventory">--</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Retired:</span>
                            <span class="info-value lot-status-indicator" id="historyRetiredStatus">--</span>
                        </div>
                        <div id="retiredDetailsSection" style="display: none;">
                            <div class="info-row">
                                <span class="info-label">Retired Date:</span>
                                <span class="info-value" id="historyRetiredDate">--</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Lbs Remaining:</span>
                                <span class="info-value" id="historyRetiredLbs">--</span>
                            </div>
                            <div class="info-row" id="retiredNotesRow" style="display: none;">
                                <span class="info-label">Retirement Notes:</span>
                                <span class="info-value" id="historyRetiredNotes">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stock Seed Section -->
                <div class="history-section" id="stockSeedSection">
                    <div class="history-section-header">
                        <h3>Stock Seed Records</h3>
                    </div>
                    <div class="history-section-content">
                        <div id="stockSeedContent">
                            <div class="no-records">No stock seed records found</div>
                        </div>
                    </div>
                </div>

                <!-- Inventory Section -->
                <div class="history-section" id="inventorySection">
                    <div class="history-section-header">
                        <h3>Inventory Records</h3>
                    </div>
                    <div class="history-section-content">
                        <div id="inventoryContent">
                            <div class="no-records">No inventory records found</div>
                        </div>
                    </div>
                </div>

                <!-- Germination Section -->
                <div class="history-section" id="germinationSection">
                    <div class="history-section-header">
                        <h3>Germination Records</h3>
                    </div>
                    <div class="history-section-content">
                        <div id="germinationContent">
                            <div class="no-records">No germination records found</div>
                        </div>
                    </div>
                </div>

                <!-- Packing History Section -->
                <div class="history-section" id="packingHistorySection">
                    <div class="history-section-header">
                        <h3>Packing History</h3>
                    </div>
                    <div class="history-section-content">
                        <div id="packingHistoryContent">
                            <div class="no-records">No packing records found</div>
                        </div>
                    </div>
                </div>

                <!-- Notes Section -->
                <div class="history-section" id="notesSection">
                    <div class="history-section-header">
                        <h3>General Notes</h3>
                    </div>
                    <div class="history-section-content">
                        <div id="notesContent">
                            <div class="no-records">No notes found</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Popup -->
    <div class="print-popup-overlay" id="deleteConfirmPopup">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Delete Lot</h3>
                <button class="print-popup-close" onclick="hideDeleteConfirm()">×</button>
            </div>
            
            <p style="text-align: center; margin-bottom: 25px; color: #dc3545;">
                Are you sure you want to delete this lot?<br>
                <strong>This action cannot be undone.</strong>
            </p>
            
            <div class="print-actions">
                <button class="print-action-btn cancel-btn" onclick="hideDeleteConfirm()">Cancel</button>
                <button class="print-action-btn delete-confirm-btn" onclick="confirmDeleteLot()">Delete</button>
            </div>
        </div>
    </div>

    
    <!-- Edit Front Labels Popup -->
    <div class="print-popup-overlay" id="editFrontLabelsPopup">
        <div class="print-popup" style="max-width: 700px;">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Edit Front Label</h3>
                <button class="print-popup-close" onclick="hideEditFrontLabelsPopup()">×</button>
            </div>
            
            <form id="editFrontLabelsForm" onsubmit="submitEditFrontLabels(event)">
                <div class="label-edit-section">
                    <div class="form-group">
                        <label>Line 1:</label>
                        <input type="text" id="editFrontLine1" value="{% if variety %}{{ variety.desc_line1 }}{% endif %}">
                    </div>
                    <div class="form-group">
                        <label>Line 2:</label>
                        <input type="text" id="editFrontLine2" value="{% if variety %}{{ variety.desc_line2 }}{% endif %}">
                    </div>
                    <div class="form-group">
                        <label>Line 3:</label>
                        <input type="text" id="editFrontLine3" value="{% if variety %}{{ variety.desc_line3 }}{% endif %}">
                    </div>
                </div>
                
                <div class="print-actions">
                    <button type="button" class="print-action-btn cancel-btn" onclick="hideEditFrontLabelsPopup()">Cancel</button>
                    <button type="submit" class="print-action-btn print-btn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Back Labels Popup -->
    <div class="print-popup-overlay" id="editBackLabelsPopup">
        <div class="print-popup" style="max-width: 700px;">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Edit Back Label</h3>
                <button class="print-popup-close" onclick="hideEditBackLabelsPopup()">×</button>
            </div>
            
            <form id="editBackLabelsForm" onsubmit="submitEditBackLabels(event)">
                <div class="label-edit-section">
                    <div class="form-group">
                        <label>Line 1:</label>
                        <input type="text" id="editBackLine1" value="{% if variety %}{{ variety.back1 }}{% endif %}">
                    </div>
                    <div class="form-group">
                        <label>Line 2:</label>
                        <input type="text" id="editBackLine2" value="{% if variety %}{{ variety.back2 }}{% endif %}">
                    </div>
                    <div class="form-group">
                        <label>Line 3:</label>
                        <input type="text" id="editBackLine3" value="{% if variety %}{{ variety.back3 }}{% endif %}">
                    </div>
                    <div class="form-group">
                        <label>Line 4:</label>
                        <input type="text" id="editBackLine4" value="{% if variety %}{{ variety.back4 }}{% endif %}">
                    </div>
                    <div class="form-group">
                        <label>Line 5:</label>
                        <input type="text" id="editBackLine5" value="{% if variety %}{{ variety.back5 }}{% endif %}">
                    </div>
                    <div class="form-group">
                        <label>Line 6:</label>
                        <input type="text" id="editBackLine6" value="{% if variety %}{{ variety.back6 }}{% endif %}">
                    </div>
                    <div class="form-group">
                        <label>Line 7:</label>
                        <input type="text" id="editBackLine7" value="{% if variety %}{{ variety.back7 }}{% endif %}">
                    </div>
                </div>
                
                <div class="print-actions">
                    <button type="button" class="print-action-btn cancel-btn" onclick="hideEditBackLabelsPopup()">Cancel</button>
                    <button type="submit" class="print-action-btn print-btn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Change Lot Status Popup -->
    <div class="print-popup-overlay" id="changeStatusPopup">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title" id="changeStatusTitle">Change Lot Status</h3>
                <button class="print-popup-close" onclick="hideChangeStatusPopup()">×</button>
            </div>
            
            <div class="print-actions">
                <button class="print-action-btn" id="pendingStatusBtn" onclick="setLotStatus('pending')">Pending</button>
                <button class="print-action-btn" id="activeStatusBtn" onclick="setLotStatus('active')">Active</button>
            </div>
        </div>
    </div>

    <!-- Add Product Popup -->
    <div id="addProductPopup" class="modal-overlay">
        <div class="modal">
            <button class="close-modal" onclick="hideAddProductPopup()">&times;</button>
            <div class="modal-header">
                <h2 class="modal-title">Add Product</h2>
            </div>

            <div id="productSuccessMessage" class="success-message" style="display: none;">
                Product created successfully! 
            </div>

            <form id="addProductForm" onsubmit="submitAddProduct(event)">
                {% csrf_token %}
                <div class="form-grid">
                    <div class="form-group">
                        <label for="product_variety">Variety</label>
                        <input type="text" id="product_variety" name="variety" value="{% if variety %}{{ variety.sku_prefix }}{% endif %}" class="field-medium" readonly>
                    </div>

                    <div class="form-group">
                        <label for="productSkuSuffix">SKU Suffix *</label>
                        <select id="productSkuSuffix" name="sku_suffix" class="field-medium" required>
                            <!-- <option value="">Select SKU suffix</option> -->
                            {% for suffix in sku_suffixes %}
                                <option value="{{ suffix }}">{{ suffix }}</option>
                            {% endfor %}
                        </select>
                        <div class="error-message" id="sku_suffix_error"></div>
                    </div>

                    <div class="form-group">
                        <label for="productPkgSize">Package Size</label>
                        <select id="productPkgSize" name="pkg_size" class="field-narrow">
                            <!-- <option value="">Package Size</option> -->
                            {% for size in pkg_sizes %}
                                <option value="{{ size }}">{{ size }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="productAltSku">Alternative SKU</label>
                        <input type="text" id="productAltSku" name="alt_sku" class="field-medium">
                    </div>

                    <div class="form-group">
                        <label for="productLineitemName">Line Item Name</label>
                        <input type="text" id="productLineitemName" name="lineitem_name" class="field-wide">
                    </div>

                    <div class="form-group">
                        <label for="productRackLocation">Rack Location</label>
                        <input type="text" id="productRackLocation" name="rack_location" class="field-medium">
                    </div>

                    <div class="form-group">
                        <label for="productEnvType">Envelope Type</label>
                        <select id="productEnvType" name="env_type" class="field-medium">
                            <!-- <option value="">Envelope Type</option> -->
                            {% for env in env_types %}
                                <option value="{{ env }}">{{ env }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="productEnvMultiplier">Envelope Multiplier</label>
                        <!-- <input type="number" id="productEnvMultiplier" name="env_multiplier"> -->
                         <input type="number" id="productEnvMultiplier" name="env_multiplier" value="1" class="field-narrow">
                    </div>

                    <div class="form-group">
                        <label for="productScoopSize">Scoop Size</label>
                        <input type="text" id="productScoopSize" name="scoop_size" class="field-medium">
                    </div>

                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="productPrintBack" name="print_back">
                        <label for="productPrintBack">Print Back</label>
                    </div>

                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="productIsSubProduct" name="is_sub_product">
                        <label for="productIsSubProduct">Is Sub Product</label>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideAddProductPopup()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Product</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Packing Record Popup -->
    <div class="print-popup-overlay" id="editPackingRecordPopup">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title" id="editPackingRecordTitle">Edit Packing Record</h3>
                <button class="print-popup-close" onclick="hideEditPackingRecordPopup()">×</button>
            </div>
            
            <form id="editPackingRecordForm" onsubmit="submitEditPackingRecord(event)">
                <div class="form-group">
                    <label>Current Quantity:</label>
                    <input type="number" id="currentPackingQty" readonly style="background: #f8f9fa; color: #666;">
                </div>
                <div class="form-group">
                    <label>Deduct Amount:</label>
                    <input type="number" id="deductPackingQty" min="1" required placeholder="Amount to deduct">
                </div>
                
                <div class="print-actions">
                    <button type="button" class="print-action-btn cancel-btn" onclick="hideEditPackingRecordPopup()">Cancel</button>
                    <button type="submit" class="print-action-btn print-btn">Submit</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Packing Record Popup -->
    <div class="print-popup-overlay" id="deletePackingRecordPopup">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Delete Packing Record</h3>
                <button class="print-popup-close" onclick="hideDeletePackingRecordPopup()">×</button>
            </div>
            
            <p style="text-align: center; margin-bottom: 25px; color: #dc3545;">
                Are you sure you want to delete this packing record?<br>
                <strong>This action cannot be undone.</strong>
            </p>
            
            <div class="print-actions">
                <button class="print-action-btn cancel-btn" onclick="hideDeletePackingRecordPopup()">Cancel</button>
                <button class="print-action-btn delete-confirm-btn" onclick="confirmDeletePackingRecord()">Yes, Delete</button>
            </div>
        </div>
    </div>

    <!-- For Year Mismatch Warning Popup -->
    <div class="print-popup-overlay" id="forYearMismatchWarning">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Cannot Print</h3>
                <button class="print-popup-close" onclick="hideForYearMismatchWarning()">×</button>
            </div>
            <p style="text-align: center; margin-bottom: 20px; color: #dc3545;">
                <strong>Year Mismatch Detected</strong><br>
                <span id="forYearMismatchMessage">The lot's year doesn't match the current printing year.</span><br>
                Please check the lot assignment.
            </p>
            <div class="print-actions">
                <button class="print-action-btn cancel-btn" onclick="hideForYearMismatchWarning()">OK</button>
            </div>
        </div>
    </div>


    <script>
        const varietyDataString = '{{ all_vars_json|escapejs }}';
        const packedForYear = '{{ packed_for_year }}'; // e.g., "26" or "25"
        const isTransition = JSON.parse('{{ transition|yesno:"true,false"|lower }}');
        const lotsExtraData = JSON.parse('{{ lots_extra_data|escapejs }}');
        let allVarieties = JSON.parse(varietyDataString);
        const lotsDataString = '{{ lots_json|escapejs }}';
        let allLotsData = JSON.parse(lotsDataString);
        let availableLots = JSON.parse(lotsDataString);
        let currentLotId = null;
        let currentLotLowInv = false;
        let lotToDelete = null;
        let currentProductName = null;
        let currentNotePopup = null;
        let currentPackingRecordId = null;
        let lastInventoryId = null;
        let inventoryAction = null;
        // Filter out retired lots
        availableLots = availableLots.filter(lot => !lot.is_retired);
        let currentProductId = null;
        let currentEditProductId = null;
        let selectedPrintOption = 'front_single';

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-dismiss messages after 4 seconds
            const messages = document.querySelectorAll('.message');
            messages.forEach(function(message) {
                setTimeout(function() {
                    message.style.animation = 'slideOutRight 0.3s ease-out forwards';
                    setTimeout(function() {
                        if (message.parentElement) {
                            message.remove();
                        }
                    }, 300);
                }, 4000); // 4 seconds delay
            });
            setupSearch();
            setupPrintHandlers();
            reorderGrowerDropdown(); 
        });

        // Search setup
        function setupSearch() {
            const searchInput = document.getElementById('varietySearch');
            const searchDropdown = document.getElementById('searchDropdown');

            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                // console.log('Searching for:', query);
                
                if (query.length < 2) {
                    searchDropdown.classList.remove('show');
                    return;
                }

                // Only search through the common_spelling keys
                const matches = [];
                
                for (const [skuPrefix, data] of Object.entries(allVarieties)) {
                    const matchesCommonSpelling = data.common_spelling && data.common_spelling.toLowerCase().includes(query);
                    
                    if (matchesCommonSpelling) {
                        matches.push([skuPrefix, data]);
                    }
                }
                // console.log('Found matches:', matches.length);

                if (matches.length > 0) {

                    searchDropdown.innerHTML = matches.slice(0, 10).map(([skuPrefix, data]) => `
                        <div class="dropdown-item" onclick="selectVariety('${skuPrefix}')">
                            <div class="dropdown-variety-name">${data.var_name || data.common_spelling}</div>
                            <div class="dropdown-variety-type">${data.veg_type || ''}</div>
                        </div>
                    `).join('');
                    searchDropdown.classList.add('show');
                } else {
                    searchDropdown.innerHTML = '<div class="dropdown-item"><div class="dropdown-variety-name">No matches found</div></div>';
                    searchDropdown.classList.add('show');
                }
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !searchDropdown.contains(e.target)) {
                    searchDropdown.classList.remove('show');
                }
            });
        }

        // Select variety
        function selectVariety(sku) {
            console.log('selectVariety called with sku:', sku); // Debug line
            
            const form = document.createElement('form');
            form.method = 'POST';
            form.style.display = 'none';
            
            const csrfToken = getCookie('csrftoken');
            console.log('CSRF token:', csrfToken); // Debug line
            
            if (csrfToken) {
                form.innerHTML += `<input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">`;
            }
            
            form.innerHTML += `
                <input type="hidden" name="variety_sku" value="${sku}">
                <input type="hidden" name="action" value="select_variety">
            `;
            
            document.body.appendChild(form);
            console.log('Form about to submit:', form); // Debug line
            form.submit();
        }



        function showPrintPopup(productId, productName) {
            console.log('showPrintPopup called for:', productId, productName);
            
            // First check if Flask app is running
            checkFlaskConnection()
                .then(isFlaskRunning => {
                    console.log('Flask running status:', isFlaskRunning);
                    if (!isFlaskRunning) {
                        showMessage('Local Flask printing app not running', 'error');
                        return;
                    }
                    
                    // Flask is running, proceed with normal print popup logic
                    console.log('Proceeding with print popup checks...');
                    proceedWithPrintPopupChecks(productId, productName);
                })
                .catch(error => {
                    console.error('Error checking Flask connection:', error);
                    showMessage('Local Flask printing app not running', 'error');
                });
        }

        function checkFlaskConnection() {
            console.log('Checking Flask connection...');
            return new Promise((resolve) => {
                // Set a short timeout for the health check
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    console.log('Flask health check timed out');
                    controller.abort();
                }, 2000); // 2 second timeout
                
                fetch('http://localhost:5000/health', {
                    method: 'GET',
                    signal: controller.signal
                })
                .then(response => {
                    clearTimeout(timeoutId);
                    console.log('Flask health check response:', response.status, response.ok);
                    // Check if the response is actually successful
                    if (response.ok) {
                        resolve(true);
                    } else {
                        resolve(false);
                    }
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    console.log('Flask health check failed:', error.message);
                    resolve(false);
                });
            });
        }


       function proceedWithPrintPopupChecks(productId, productName) {
            console.log('proceedWithPrintPopupChecks called for:', productId);
            
            try {
                // Find the product row
                const productRow = document.querySelector(`tr[data-product-id="${productId}"]`);
                
                if (!productRow) {
                    console.error('Could not find product row for ID:', productId);
                    showMessage('Could not find product information', 'error');
                    return;
                }
                
                // Get lot information from the display
                const lotCell = productRow.cells[1]; // Lot column is at index 1
                const lotText = lotCell.textContent.trim().replace(/\s+/g, '');
                
                console.log('Lot text from cell:', lotText);
                
                // Check 1: No lot assigned
                if (lotText === '--' || lotText === '') {
                    console.log('No lot assigned, showing warning');
                    document.getElementById('noLotWarning').classList.add('show');
                    return;
                }

                // Find the matching lot in our data
                const matchingLot = allLotsData.find(lot => {
                    const lotDisplay = `${lot.grower}${lot.year}${lot.harvest}`;
                    return lotDisplay === lotText;
                });
                
                if (!matchingLot) {
                    console.log('Could not find matching lot data');
                    showMessage('Could not find lot information', 'error');
                    return;
                }
                
                // Check 2: Retired lot (blocks all printing)
                if (matchingLot.is_retired) {
                    console.log('Lot is retired, showing warning');
                    document.getElementById('retiredLotWarning').classList.add('show');
                    return;
                }
                
                // Check 3: Year mismatch checking (NEW LOGIC)
                const lotGermForYear = productRow.dataset.lotForYear; // Get lot's most recent germ for_year
                
                console.log('Year check - Packed for year:', packedForYear, 'Lot germ for_year:', lotGermForYear, 'Transition:', isTransition);
                
                // Check for front label printing options
                if (selectedPrintOption && shouldCheckForYear(selectedPrintOption)) {
                    if (lotGermForYear && packedForYear) {
                        const lotYear = parseInt(lotGermForYear);
                        const packedYear = parseInt(packedForYear);
                        
                        if (isTransition) {
                            // Transition mode: lot year must be >= packed year
                            if (lotYear < packedYear) {
                                console.log('Transition mode: Lot year < packed year, showing warning');
                                showForYearMismatchWarning(packedForYear, lotGermForYear, lotText);
                                return;
                            }
                        } else {
                            // Non-transition mode: lot year must equal packed year
                            if (lotYear !== packedYear) {
                                console.log('Non-transition mode: Lot year != packed year, showing warning');
                                showForYearMismatchWarning(packedForYear, lotGermForYear, lotText);
                                return;
                            }
                        }
                    } else {
                        console.log('Missing year data for comparison');
                        showMessage('Missing year information for comparison', 'error');
                        return;
                    }
                }
                
                // Check 4: Pending status (blocks all printing)
                const lotStatus = getLotStatus(lotText);
                if (lotStatus && lotStatus.toLowerCase() === 'pending') {
                    console.log('Lot status is pending, showing warning');
                    document.getElementById('pendingStatusWarning').classList.add('show');
                    return;
                }
                
                // Check 5: Low inventory (asks for confirmation)
                if (matchingLot.low_inv === true || matchingLot.low_inv === 'true') {
                    console.log('Low inventory, showing confirmation');
                    currentProductId = productId;
                    currentProductName = productName;
                    document.getElementById('lowInventoryWarning').classList.add('show');
                    return;
                }
                

                const lastPrintDate = productRow.dataset.lastPrintDate;
                if (lastPrintDate && lastPrintDate !== '--' && isWithinLastWeek(lastPrintDate)) {
                    console.log('Recent print detected:', lastPrintDate);
                    currentProductId = productId;
                    currentProductName = productName;
                    document.getElementById('lastPrintDateDisplay').textContent = lastPrintDate;
                    document.getElementById('recentPrintWarning').classList.add('show');
                    return;
                }

                // All checks passed - proceed with printing
                console.log('All checks passed, proceeding with print popup');
                proceedWithPrintPopup(productId, productName);
                
            } catch (error) {
                console.error('Error in proceedWithPrintPopupChecks:', error);
                showMessage('Error processing print request', 'error');
            }
        }



        // Check if a date is within the last 7 days
        function isWithinLastWeek(dateString) {
            if (dateString === '--') return false;
            
            try {
                const printDate = new Date(dateString);
                const today = new Date();
                const oneWeekAgo = new Date(today.getTime() - (7 * 24 * 60 * 60 * 1000));
                
                return printDate >= oneWeekAgo && printDate <= today;
            } catch (error) {
                console.log('Error parsing date:', dateString);
                return false;
            }
        }

        function hideRecentPrintWarning() {
            document.getElementById('recentPrintWarning').classList.remove('show');
            currentProductId = null;
            currentProductName = null;
        }

        function continueRecentPrint() {
            const productId = currentProductId;
            const productName = currentProductName;
            hideRecentPrintWarning();
            proceedWithPrintPopup(productId, productName);
        }
        
        // Helper function to determine if we should check for_year for this print option
        function shouldCheckForYear(printOption) {
            const frontLabelOptions = [
                'front_single',
                'front_sheet', 
                'front_back_single',
                'front_back_sheet'
            ];
            
            return frontLabelOptions.includes(printOption);
        }

        // Function to show the for_year mismatch warning
        function showForYearMismatchWarning(currentYear, lotYear, lotCode) {
            const message = `Current year: 20${currentYear} | Lot ${lotCode} year: 20${lotYear}`;
            document.getElementById('forYearMismatchMessage').textContent = message;
            document.getElementById('forYearMismatchWarning').classList.add('show');
        }

        // Function to hide the for_year mismatch warning
        function hideForYearMismatchWarning() {
            document.getElementById('forYearMismatchWarning').classList.remove('show');
        }

        function proceedWithPrintPopup(productId, productName) {
            currentProductId = productId;
            document.querySelector('.print-popup-title').innerHTML = `Print labels for<br>${productName}`;
            document.getElementById('printQuantity').value = 1;
            
            document.querySelectorAll('.print-option-btn').forEach(btn => btn.classList.remove('selected'));
            document.querySelector('[data-option="front_single"]').classList.add('selected');
            selectedPrintOption = 'front_single';
            
            // Set up the packed for year input/dropdown
            setupPackedForYearControl(productId);
            
            document.getElementById('printPopupOverlay').classList.add('show');
        }


        function setupPackedForYearControl(productId) {
            const productRow = document.querySelector(`tr[data-product-id="${productId}"]`);
            const lotGermForYear = productRow ? productRow.dataset.lotForYear : null;
            
            // Get the lot code to find extra data
            const lotCode = productRow ? productRow.dataset.lotCode : null;
            
            // Find if this is a next-year-only lot
            const matchingLot = allLotsData.find(lot => {
                const lotDisplay = `${lot.grower}${lot.year}${lot.harvest}`;
                return lotDisplay === lotCode;
            });
            
            const lotExtraData = lotsExtraData.find(extra => extra.id === matchingLot?.id);
            const isNextYearOnly = lotExtraData?.is_next_year_only || false;
            
            const inputElement = document.getElementById('packedForYearInput');
            const selectElement = document.getElementById('packedForYearSelect');
            
            selectElement.innerHTML = '';
            
            if (isNextYearOnly) {
                // Special case: next year only lot - force next year
                const nextYear = parseInt(packedForYear) + 1;
                inputElement.value = `20${nextYear}`;
                inputElement.style.display = 'inline-block';
                selectElement.style.display = 'none';
                console.log('Next year only lot detected - forcing year', nextYear);
            } else if (!isTransition) {
                // Non-transition: show current packed year
                inputElement.value = `20${packedForYear}`;
                inputElement.style.display = 'inline-block';
                selectElement.style.display = 'none';
            } else {
                // Transition mode - existing logic
                const lotYear = lotGermForYear ? parseInt(lotGermForYear) : null;
                const packedYear = parseInt(packedForYear);
                
                if (lotYear && lotYear > packedYear) {
                    selectElement.innerHTML = `
                        <option value="${packedYear}">20${packedYear}</option>
                        <option value="${packedYear + 1}">20${packedYear + 1}</option>
                    `;
                    selectElement.value = packedYear;
                    selectElement.style.display = 'inline-block';
                    inputElement.style.display = 'none';
                } else {
                    inputElement.value = `20${packedForYear}`;
                    inputElement.style.display = 'inline-block';
                    selectElement.style.display = 'none';
                }
            }
        }


        function showProductActionsPopup(productId) {
            currentProductId = productId;
            document.getElementById('productActionsPopup').classList.add('show');
        }

        function hideProductActionsPopup() {
            document.getElementById('productActionsPopup').classList.remove('show');
            currentProductId = null;
        }

        function changeProductLot(productId) {
            hideProductActionsPopup();
            editProductLot(productId); // Your existing function
        }

        function editProduct(productId) {
            hideProductActionsPopup();
            
            currentProductId = productId || currentProductId;
            // Get product data from the row
            const productRow = document.querySelector(`tr[data-product-id="${productId}"]`);
            
            if (!productRow) {
                showMessage('Could not find product data', 'error');
                return;
            }
            
            // Pre-fill all the form fields
            document.getElementById('editProductVariety').value = productRow.dataset.varietyName || '';
            document.getElementById('editProductSkuSuffix').value = productRow.dataset.skuSuffix || '';
            document.getElementById('editProductPkgSize').value = productRow.dataset.pkgSize || '';
            document.getElementById('editProductAltSku').value = productRow.dataset.altSku || '';
            document.getElementById('editProductLineitemName').value = productRow.dataset.lineitemName || '';
            document.getElementById('editProductRackLocation').value = productRow.dataset.rackLocation || '';
            document.getElementById('editProductEnvType').value = productRow.dataset.envType || '';
            document.getElementById('editProductEnvMultiplier').value = productRow.dataset.envMultiplier || '1';
            document.getElementById('editProductScoopSize').value = productRow.dataset.scoopSize || '';
            
            // Handle checkboxes - convert string to boolean
            document.getElementById('editProductPrintBack').checked = productRow.dataset.printBack === 'true';
            document.getElementById('editProductIsSubProduct').checked = productRow.dataset.isSubProduct === 'true';
            
            // Show the popup
            document.getElementById('editProductPopup').classList.add('show');
            document.body.classList.add('modal-open');
        }

        function hideEditProductPopup() {
            document.getElementById('editProductPopup').classList.remove('show');
            document.body.classList.remove('modal-open');
        }

        function submitEditProduct(event) {
            event.preventDefault();
            
            const formData = new FormData();
            formData.append('product_id', currentProductId);
            formData.append('sku_suffix', document.getElementById('editProductSkuSuffix').value);
            formData.append('pkg_size', document.getElementById('editProductPkgSize').value);
            formData.append('env_type', document.getElementById('editProductEnvType').value);
            formData.append('alt_sku', document.getElementById('editProductAltSku').value);
            formData.append('lineitem_name', document.getElementById('editProductLineitemName').value);
            formData.append('rack_location', document.getElementById('editProductRackLocation').value);
            formData.append('env_multiplier', document.getElementById('editProductEnvMultiplier').value);
            formData.append('scoop_size', document.getElementById('editProductScoopSize').value);
            
            // Handle checkboxes - only append if checked
            if (document.getElementById('editProductPrintBack').checked) {
                formData.append('print_back', 'on');
            }
            if (document.getElementById('editProductIsSubProduct').checked) {
                formData.append('is_sub_product', 'on');
            }
            
            formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
            
            fetch('/office/edit-product/', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the DOM data attributes with new values
                    const productRow = document.querySelector(`tr[data-product-id="${currentProductId}"]`);
                    if (productRow) {
                        productRow.dataset.skuSuffix = document.getElementById('editProductSkuSuffix').value;
                        productRow.dataset.pkgSize = document.getElementById('editProductPkgSize').value;
                        productRow.dataset.envType = document.getElementById('editProductEnvType').value;
                        productRow.dataset.altSku = document.getElementById('editProductAltSku').value;
                        productRow.dataset.lineitemName = document.getElementById('editProductLineitemName').value;
                        productRow.dataset.rackLocation = document.getElementById('editProductRackLocation').value;
                        productRow.dataset.envMultiplier = document.getElementById('editProductEnvMultiplier').value;
                        productRow.dataset.scoopSize = document.getElementById('editProductScoopSize').value;
                        productRow.dataset.printBack = document.getElementById('editProductPrintBack').checked.toString();
                        productRow.dataset.isSubProduct = document.getElementById('editProductIsSubProduct').checked.toString();
                        
                        // Also update the visible SKU suffix in the table cell
                        const skuCell = productRow.querySelector('.product-sku');
                        if (skuCell) {
                            skuCell.textContent = document.getElementById('editProductSkuSuffix').value || '--';
                        }
                    }
                    
                    showMessage('Product updated successfully', 'success');
                    setTimeout(() => {
                        window.location.href = window.location.pathname;
                    }, 2000);
                } else {
                    showMessage('Error updating product: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Network error occurred', 'error');
            });
            
            hideEditProductPopup();
        }


        function viewProductPackingHistory(productId) {
            hideProductActionsPopup();
            
            // Get product info from the row
            const productRow = document.querySelector(`tr[data-product-id="${productId}"]`);
            if (!productRow) {
                showMessage('Could not find product information', 'error');
                return;
            }
            
            // Set title
            const varietyName = productRow.dataset.varietyName || 'Unknown';
            const skuSuffix = productRow.dataset.skuSuffix || 'Unknown';
            
            // Show popup immediately
            document.getElementById('productPackingHistoryPopup').classList.add('show');
            document.body.classList.add('modal-open');
            
            // Fetch product packing history data
            fetch('/office/get-product-packing-history/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    product_id: productId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    populateProductPackingHistory(data.data);
                } else {
                    showMessage('Error loading packing history: ' + (data.error || 'Unknown error'), 'error');
                    hideProductPackingHistoryPopup();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Network error occurred', 'error');
                hideProductPackingHistoryPopup();
            });
        }

        function hideProductPackingHistoryPopup() {
            hideNotePopup(); // Close any open note popups
            document.getElementById('productPackingHistoryPopup').classList.remove('show');
            document.body.classList.remove('modal-open');
        }

        function populateProductPackingHistory(data) {
            // Basic product info
            document.getElementById('productHistoryVarietyName').textContent = data.variety_name;
            document.getElementById('productHistorySkuDisplay').textContent = data.product_sku;
            
            // Populate print history
            populateProductPackingHistoryRecords(data.packing_history);
        }

        // function populateProductPackingHistoryRecords(packingHistory) {
        //     const container = document.getElementById('productPackingHistoryContent');
            
        //     if (!packingHistory || packingHistory.length === 0) {
        //         container.innerHTML = '<div class="no-records">No print records found</div>';
        //         return;
        //     }
            
        //     // Group by for_year and sort
        //     const groupedByYear = {};
            
        //     packingHistory.forEach(pack => {
        //         const year = pack.for_year || 'Unknown';
        //         if (!groupedByYear[year]) {
        //             groupedByYear[year] = [];
        //         }
        //         groupedByYear[year].push(pack);
        //     });
            
        //     // Sort years (newest first) and sort records within each year by date (newest first)
        //     const sortedYears = Object.keys(groupedByYear).sort((a, b) => {
        //         if (a === 'Unknown') return 1;
        //         if (b === 'Unknown') return -1;
        //         return b.localeCompare(a);
        //     });
            
        //     let html = '';
            
        //     sortedYears.forEach(year => {
        //         // Sort records within year by date (newest first)
        //         const sortedRecords = groupedByYear[year].sort((a, b) => 
        //             new Date(b.date) - new Date(a.date)
        //         );
                
        //         // Add year header
        //         const displayYear = year.length === 2 ? `20${year}` : year;
        //         html += `
        //             <div class="packing-year-header">
        //                 <h4>Printed for ${displayYear}:</h4>
        //             </div>
        //         `;
                
        //         // Add records for this year
        //         sortedRecords.forEach(pack => {
        //             html += `
        //                 <div class="record-item" style="margin-left: 15px;">
        //                     <div class="record-main-info" style="justify-content: space-between;">
        //                         <div style="display: flex; align-items: center; gap: 40px;">
        //                             <span class="record-date" style="min-width: 80px;">${pack.date}</span>
        //                             <div class="record-detail">
        //                                 <span class="record-detail-label">Qty:</span>
        //                                 <span class="record-detail-value">${pack.qty}</span>
        //                             </div>
        //                         </div>
        //                         <div class="record-detail">
        //                             <span class="record-detail-label">Lot:</span>
        //                             <span class="record-detail-value">${pack.lot_code}</span>
        //                         </div>
        //                     </div>
        //                 </div>
        //             `;
        //         });
                
        //         // Add spacing between year groups
        //         if (year !== sortedYears[sortedYears.length - 1]) {
        //             html += '<div class="year-group-spacing"></div>';
        //         }
        //     });
            
        //     container.innerHTML = html;
        // }
        function populateProductPackingHistoryRecords(packingHistory) {
            const container = document.getElementById('productPackingHistoryContent');
            
            if (!packingHistory || packingHistory.length === 0) {
                container.innerHTML = '<div class="no-records">No print records found</div>';
                return;
            }
            
            // Group by for_year and sort
            const groupedByYear = {};
            
            packingHistory.forEach(pack => {
                const year = pack.for_year || 'Unknown';
                if (!groupedByYear[year]) {
                    groupedByYear[year] = [];
                }
                groupedByYear[year].push(pack);
            });
            
            // Sort years (newest first) and sort records within each year by date (newest first)
            const sortedYears = Object.keys(groupedByYear).sort((a, b) => {
                if (a === 'Unknown') return 1;
                if (b === 'Unknown') return -1;
                return b.localeCompare(a);
            });
            
            let html = '';
            
            sortedYears.forEach(year => {
                // Sort records within year by date (newest first)
                const sortedRecords = groupedByYear[year].sort((a, b) => 
                    new Date(b.date) - new Date(a.date)
                );
                
                // Add year header
                const displayYear = year.length === 2 ? `20${year}` : year;
                html += `
                    <div class="packing-year-header">
                        <h4>Printed for ${displayYear}:</h4>
                    </div>
                `;
                
                // Add records for this year
                sortedRecords.forEach(pack => {
                    html += `
                        <div class="record-item" style="margin-left: 15px;">
                            <div class="record-main-info" style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                                <div style="display: flex; align-items: center; gap: 20px; flex: 1; min-width: 0;">
                                    <span class="record-date" style="min-width: 80px; flex-shrink: 0;">${pack.date}</span>
                                    <div class="record-detail" style="flex-shrink: 0;">
                                        <span class="record-detail-label">Qty:</span>
                                        <span class="record-detail-value">${pack.qty}</span>
                                    </div>
                                    <div class="record-detail" style="flex-shrink: 0;">
                                        <span class="record-detail-label">Lot:</span>
                                        <span class="record-detail-value">${pack.lot_code}</span>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 4px; flex-shrink: 0; margin-left: 20px;">
                                    <span class="edit-icon" onclick="showEditPackingRecordPopup(${pack.id}, ${pack.qty}, '${pack.date}', '${pack.lot_code}')">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                        </svg>
                                    </span>
                                    <span class="edit-icon" style="color: #dc3545;" onclick="showDeletePackingRecordPopup(${pack.id}, '${pack.date}', '${pack.lot_code}', ${pack.qty})">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="3,6 5,6 21,6"></polyline>
                                            <path d="M19,6V20a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6m3,0V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"></path>
                                            <line x1="10" y1="11" x2="10" y2="17"></line>
                                            <line x1="14" y1="11" x2="14" y2="17"></line>
                                        </svg>
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                // Add spacing between year groups
                if (year !== sortedYears[sortedYears.length - 1]) {
                    html += '<div class="year-group-spacing"></div>';
                }
            });
            
            container.innerHTML = html;
        }




        // Edit Packing Record Functions
        function showEditPackingRecordPopup(recordId, currentQty, date, lotCode) {
            currentPackingRecordId = recordId;
            
            document.getElementById('editPackingRecordTitle').textContent = `Edit Record: ${date} (${lotCode})`;
            document.getElementById('currentPackingQty').value = currentQty;
            document.getElementById('deductPackingQty').value = '';
            document.getElementById('deductPackingQty').max = currentQty - 1; // Can't deduct more than current - 1
            
            document.getElementById('editPackingRecordPopup').classList.add('show');
        }

        function hideEditPackingRecordPopup() {
            document.getElementById('editPackingRecordPopup').classList.remove('show');
            document.getElementById('editPackingRecordForm').reset();
            currentPackingRecordId = null;
        }

        function submitEditPackingRecord(event) {
            event.preventDefault();
            
            const currentQty = parseInt(document.getElementById('currentPackingQty').value);
            const deductAmount = parseInt(document.getElementById('deductPackingQty').value);
            const newQty = currentQty - deductAmount;
            
            if (newQty <= 0) {
                showMessage('Cannot reduce quantity to zero or below. Use delete instead.', 'error');
                return;
            }
            
            fetch('/office/edit-packing-record/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    record_id: currentPackingRecordId,
                    new_qty: newQty
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('Packing record updated successfully', 'success');
                    // Close both popups to force user to reopen and see changes
                    hideEditPackingRecordPopup();
                    hideProductPackingHistoryPopup();
                } else {
                    showMessage('Error updating record: ' + (data.error || 'Unknown error'), 'error');
                    hideEditPackingRecordPopup();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Network error occurred', 'error');
                hideEditPackingRecordPopup();
            });
        }

        // Delete Packing Record Functions
        function showDeletePackingRecordPopup(recordId, date, lotCode, qty) {
            currentPackingRecordId = recordId;
            
            // Update the confirmation message with specific details
            const confirmationText = document.querySelector('#deletePackingRecordPopup p');
            confirmationText.innerHTML = `
                Are you sure you want to delete this packing record?<br>
                <strong>Date:</strong> ${date} | <strong>Lot:</strong> ${lotCode} | <strong>Qty:</strong> ${qty}<br>
                <strong>This action cannot be undone.</strong>
            `;
            
            document.getElementById('deletePackingRecordPopup').classList.add('show');
        }

        function hideDeletePackingRecordPopup() {
            document.getElementById('deletePackingRecordPopup').classList.remove('show');
            currentPackingRecordId = null;
        }

        function confirmDeletePackingRecord() {
            if (!currentPackingRecordId) {
                showMessage('No record selected', 'error');
                return;
            }
            
            fetch('/office/delete-packing-record/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    record_id: currentPackingRecordId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('Packing record deleted successfully', 'success');
                    // Close both popups to force user to reopen and see changes
                    hideDeletePackingRecordPopup();
                    hideProductPackingHistoryPopup();
                } else {
                    showMessage('Error deleting record: ' + (data.error || 'Unknown error'), 'error');
                    hideDeletePackingRecordPopup();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Network error occurred', 'error');
                hideDeletePackingRecordPopup();
            });
        }





        function getLotStatus(lotCode) {
            console.log('getLotStatus called with lotCode:', lotCode);
            
            try {
                // Find the lot status from the lots table
                const lotRows = document.querySelectorAll('.lots-table tbody tr');
                console.log('Found lot rows:', lotRows.length);
                
                if (lotRows.length === 0) {
                    console.log('No lot rows found in table');
                    return null;
                }
                
                for (const row of lotRows) {
                    console.log('Checking row:', row);
                    const rowLotCode = row.cells[0].textContent.trim().replace(/\s+/g, '');
                    console.log('Row lot code:', rowLotCode, 'comparing to:', lotCode);
                    
                    if (rowLotCode === lotCode) {
                        console.log('Found matching row, getting status from cells[3]');
                        // Status is in the 4th column (index 3)
                        const status = row.cells[3].textContent.trim();
                        console.log('Status found:', status);
                        return status;
                    }
                }
                
                console.log('No matching lot code found in table');
                return null;
                
            } catch (error) {
                console.error('Error in getLotStatus:', error);
                throw error; // Re-throw so the calling function can catch it
            }
        }


        function hidePendingStatusWarning() {
            document.getElementById('pendingStatusWarning').classList.remove('show');
        }


        // Photo popup functions
        function showPhotoPopup() {
            document.getElementById('photoPopupOverlay').classList.add('show');
        }

        function hidePhotoPopup() {
            document.getElementById('photoPopupOverlay').classList.remove('show');
        }

        function hidePrintPopup() {
            document.getElementById('printPopupOverlay').classList.remove('show');
            
            // Reset button states when popup closes
            const printBtn = document.querySelector('.print-btn');
            const cancelBtn = document.querySelector('.cancel-btn');
            const popup = document.querySelector('.print-popup');
            
            if (printBtn && cancelBtn && popup) {
                printBtn.disabled = false;
                cancelBtn.disabled = false;
                printBtn.classList.remove('loading');
                popup.classList.remove('loading');
                printBtn.textContent = 'Print';
            }
            
            currentProductId = null;
        }

        function hideLowInventoryWarning() {
            document.getElementById('lowInventoryWarning').classList.remove('show');
            currentProductId = null;
            currentProductName = null;
        }

        function continuePrintDespiteLowInv() {
            const productId = currentProductId;
            const productName = currentProductName;
            hideLowInventoryWarning();
            // console.log('Continuing print despite low inventory for:', productName);
            proceedWithPrintPopup(productId, productName);
        }

       
        function submitPrintJob() {
            const quantity = document.getElementById('printQuantity').value;
            
            if (!currentProductId || !quantity || quantity < 1) {
                showMessage('Please enter a valid quantity', 'error');
                return;
            }

            // Disable buttons and show loading state immediately
            const printBtn = document.querySelector('.print-btn');
            const cancelBtn = document.querySelector('.cancel-btn');
            const popup = document.querySelector('.print-popup');
            
            printBtn.disabled = true;
            cancelBtn.disabled = true;
            printBtn.classList.add('loading');
            popup.classList.add('loading');
            
            // Change button text to indicate loading
            const originalPrintText = printBtn.textContent;
            printBtn.textContent = 'Printing...';

            try {
                // Collect all data from the page
                const printData = collectPrintData(currentProductId, quantity);
                
                if (!printData) {
                    showMessage('Could not collect print data', 'error');
                    resetPrintButtons(printBtn, cancelBtn, popup, originalPrintText);
                    return;
                }

                // Determine Flask endpoints based on print option
                const endpoints = getFlaskEndpoints(selectedPrintOption);
                
                if (endpoints.length === 0) {
                    showMessage('Invalid print option selected', 'error');
                    resetPrintButtons(printBtn, cancelBtn, popup, originalPrintText);
                    return;
                }

                console.log('Sending to Flask:', printData);

                // Step 1: Send to Flask for printing - SEQUENTIALLY to maintain order
                let printPromise = Promise.resolve();
                
                endpoints.forEach(endpoint => {
                    printPromise = printPromise.then(() => 
                        fetch(`http://localhost:5000${endpoint}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(printData)
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`Flask endpoint ${endpoint} failed`);
                            }
                            return response;
                        })
                    );
                });

                printPromise
                    .then(() => {
                        // Step 2: Record print job in Django after all printing is complete
                        return fetch('/office/print-product-labels/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCookie('csrftoken')
                            },
                            body: JSON.stringify({
                                product_id: currentProductId,
                                print_type: selectedPrintOption,
                                quantity: quantity,
                                packed_for_year: printData.for_year
                            })
                        });
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showMessage(`Successfully printed ${quantity} ${selectedPrintOption.replace('_', ' ')} label(s)`, 'success');
                            hidePrintPopup(); // This will reset the buttons when popup closes
                            // Refresh page after 2 seconds to show updated print count
                            setTimeout(() => {
                                window.location.href = window.location.pathname;
                            }, 2000);
                        } else {
                            showMessage('Print sent but failed to record: ' + (data.error || 'Unknown error'), 'error');
                            hidePrintPopup(); // This will reset the buttons when popup closes
                        }
                    })
                    .catch(error => {
                        console.error('Print job error:', error);
                        console.log('This is the data that would be sent to Flask:', printData);
                        showMessage('Printing failed: ' + error.message, 'error');
                        resetPrintButtons(printBtn, cancelBtn, popup, originalPrintText);
                    });

            } catch (error) {
                console.error('Data collection error:', error);
                console.log('This is the data that would be sent to Flask: [Data collection failed]');
                showMessage('Failed to collect print data', 'error');
                resetPrintButtons(printBtn, cancelBtn, popup, originalPrintText);
            }
        }
        // function submitPrintJob() {
        //     const quantity = document.getElementById('printQuantity').value;
            
        //     if (!currentProductId || !quantity || quantity < 1) {
        //         showMessage('Please enter a valid quantity', 'error');
        //         return;
        //     }

        //     // Disable buttons and show loading state immediately
        //     const printBtn = document.querySelector('.print-btn');
        //     const cancelBtn = document.querySelector('.cancel-btn');
        //     const popup = document.querySelector('.print-popup');
            
        //     printBtn.disabled = true;
        //     cancelBtn.disabled = true;
        //     printBtn.classList.add('loading');
        //     popup.classList.add('loading');
            
        //     // Change button text to indicate loading
        //     const originalPrintText = printBtn.textContent;
        //     printBtn.textContent = 'Printing...';

        //     try {
        //         // Collect all data from the page
        //         const printData = collectPrintData(currentProductId, quantity);
                
        //         if (!printData) {
        //             showMessage('Could not collect print data', 'error');
        //             resetPrintButtons(printBtn, cancelBtn, popup, originalPrintText);
        //             return;
        //         }

        //         // Determine Flask endpoints based on print option
        //         const endpoints = getFlaskEndpoints(selectedPrintOption);
                
        //         if (endpoints.length === 0) {
        //             showMessage('Invalid print option selected', 'error');
        //             resetPrintButtons(printBtn, cancelBtn, popup, originalPrintText);
        //             return;
        //         }

        //         console.log('Sending to Flask:', printData);

        //         // Step 1: Send to Flask for printing
        //         Promise.all(endpoints.map(endpoint => 
        //             fetch(`http://localhost:5000${endpoint}`, {
        //                 method: 'POST',
        //                 headers: { 'Content-Type': 'application/json' },
        //                 body: JSON.stringify(printData)
        //             })
        //         ))
        //         .then(responses => {
        //             const allSuccessful = responses.every(response => response.ok);
                    
        //             if (allSuccessful) {
        //                 // Step 2: Record print job in Django (include selected year)
        //                 return fetch('/office/print-product-labels/', {
        //                     method: 'POST',
        //                     headers: {
        //                         'Content-Type': 'application/json',
        //                         'X-CSRFToken': getCookie('csrftoken')
        //                     },
        //                     body: JSON.stringify({
        //                         product_id: currentProductId,
        //                         print_type: selectedPrintOption,
        //                         quantity: quantity,
        //                         packed_for_year: printData.for_year
        //                     })
        //                 });
        //             } else {
        //                 throw new Error('Flask printing failed');
        //             }
        //         })
        //         .then(response => response.json())
        //         .then(data => {
        //             if (data.success) {
        //                 showMessage(`Successfully printed ${quantity} ${selectedPrintOption.replace('_', ' ')} label(s)`, 'success');
        //                 hidePrintPopup(); // This will reset the buttons when popup closes
        //                 // Refresh page after 2 seconds to show updated print count
        //                 setTimeout(() => {
        //                     window.location.href = window.location.pathname;
        //                 }, 2000);
        //             } else {
        //                 showMessage('Print sent but failed to record: ' + (data.error || 'Unknown error'), 'error');
        //                 hidePrintPopup(); // This will reset the buttons when popup closes
        //             }
        //         })
        //         .catch(error => {
        //             console.error('Print job error:', error);
        //             console.log('This is the data that would be sent to Flask:', printData);
        //             showMessage('Printing failed: ' + error.message, 'error');
        //             resetPrintButtons(printBtn, cancelBtn, popup, originalPrintText);
        //         });

        //     } catch (error) {
        //         console.error('Data collection error:', error);
        //         console.log('This is the data that would be sent to Flask: [Data collection failed]');
        //         showMessage('Failed to collect print data', 'error');
        //         resetPrintButtons(printBtn, cancelBtn, popup, originalPrintText);
        //     }
        // }

        // Helper function to reset button states
        function resetPrintButtons(printBtn, cancelBtn, popup, originalText) {
            printBtn.disabled = false;
            cancelBtn.disabled = false;
            printBtn.classList.remove('loading');
            popup.classList.remove('loading');
            printBtn.textContent = originalText;
        }



        function collectPrintData(productId, quantity) {
            const productRow = document.querySelector(`tr[data-product-id="${productId}"]`);
            if (!productRow) return null;
            
            // Get the selected year from either input or dropdown
            let selectedYear;
            const inputElement = document.getElementById('packedForYearInput');
            const selectElement = document.getElementById('packedForYearSelect');
            
            if (inputElement.style.display !== 'none') {
                // Using input - extract 2-digit year from "20XX" format
                selectedYear = inputElement.value.slice(-2);
            } else {
                // Using dropdown - convert selected value to 2-digit string
                const selectedValue = parseInt(selectElement.value);
                selectedYear = selectedValue.toString().padStart(2, '0');
            }
            
            return {
                quantity: parseInt(quantity),
                variety_name: productRow.dataset.varietyName,
                crop: productRow.dataset.crop,
                days: productRow.dataset.days,
                sku_suffix: productRow.dataset.skuSuffix,
                pkg_size: productRow.dataset.pkgSize,
                env_type: productRow.dataset.envType,
                lot_code: productRow.dataset.lotCode,
                germination: productRow.dataset.germination,
                for_year: selectedYear, // Use the selected year instead of fixed value
                rad_type: productRow.dataset.radType,
                desc1: productRow.dataset.desc1,
                desc2: productRow.dataset.desc2,
                desc3: productRow.dataset.desc3,
                back1: productRow.dataset.back1,
                back2: productRow.dataset.back2,
                back3: productRow.dataset.back3,
                back4: productRow.dataset.back4,
                back5: productRow.dataset.back5,
                back6: productRow.dataset.back6,
                back7: productRow.dataset.back7
            };
        }


        function getFlaskEndpoints(printOption) {
            const endpointMap = {
                'front_single': ['/print-single-front'],
                'front_sheet': ['/print-sheet-front'],
                'back_single': ['/print-single-back'],
                'back_sheet': ['/print-sheet-back'],
                'front_back_single': ['/print-single-back', '/print-single-front'],
                'front_back_sheet': ['/print-sheet-front', '/print-sheet-back']

            };
            
            return endpointMap[printOption] || [];
        }


        function showMessage(text, type = 'success') {
            // Create message container if it doesn't exist
            let container = document.querySelector('.messages-container');
            if (!container) {
                container = document.createElement('div');
                container.className = 'messages-container';
                document.body.appendChild(container);
            }
            
            // Create message element
            const message = document.createElement('div');
            message.className = `message message-${type}`;
            message.innerHTML = `
                <span class="message-text">${text}</span>
                <button class="message-close" onclick="this.parentElement.remove()">×</button>
            `;
            
            container.appendChild(message);
            
            // Auto-dismiss after 4 seconds
            setTimeout(function() {
                if (message.parentElement) {
                    message.style.animation = 'slideOutRight 0.3s ease-out forwards';
                    setTimeout(function() {
                        if (message.parentElement) {
                            message.remove();
                        }
                    }, 300);
                }
            }, 4000);
        }


        // Front Labels Functions
        function showEditFrontLabelsPopup() {
            document.getElementById('editFrontLabelsPopup').classList.add('show');
        }

        function hideEditFrontLabelsPopup() {
            document.getElementById('editFrontLabelsPopup').classList.remove('show');
        }

        function submitEditFrontLabels(event) {
            event.preventDefault();
            
            const labelData = {
                variety_sku: '{{ variety.sku_prefix }}',
                desc_line1: document.getElementById('editFrontLine1').value,
                desc_line2: document.getElementById('editFrontLine2').value,
                desc_line3: document.getElementById('editFrontLine3').value
            };
            
            fetch('/office/edit-front-labels/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(labelData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => Promise.reject(err));
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showMessage('Front labels updated successfully', 'success');
                    setTimeout(() => {
                        window.location.href = window.location.pathname;
                    }, 2000);
                } else {
                    showMessage('Error updating front labels: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                if (error.error) {
                    showMessage('Error updating front labels: ' + error.error, 'error');
                } else {
                    console.error('Error:', error);
                    showMessage('Network error occurred', 'error');
                }
            });
            
            hideEditFrontLabelsPopup();
        }

        // Back Labels Functions
        function showEditBackLabelsPopup() {
            document.getElementById('editBackLabelsPopup').classList.add('show');
        }

        function hideEditBackLabelsPopup() {
            document.getElementById('editBackLabelsPopup').classList.remove('show');
        }

        function submitEditBackLabels(event) {
            event.preventDefault();
            
            const labelData = {
                variety_sku: '{{ variety.sku_prefix }}',
                back1: document.getElementById('editBackLine1').value,
                back2: document.getElementById('editBackLine2').value,
                back3: document.getElementById('editBackLine3').value,
                back4: document.getElementById('editBackLine4').value,
                back5: document.getElementById('editBackLine5').value,
                back6: document.getElementById('editBackLine6').value,
                back7: document.getElementById('editBackLine7').value
            };
            
            fetch('/office/edit-back-labels/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(labelData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => Promise.reject(err));
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showMessage('Back labels updated successfully', 'success');
                    setTimeout(() => {
                        window.location.href = window.location.pathname;
                    }, 2000);
                } else {
                    showMessage('Error updating back labels: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                if (error.error) {
                    showMessage('Error updating back labels: ' + error.error, 'error');
                } else {
                    console.error('Error:', error);
                    showMessage('Network error occurred', 'error');
                }
            });
            
            hideEditBackLabelsPopup();
        }
        
        function reorderGrowerDropdown() {
            const select = document.getElementById('lotGrowerSelect');
            if (!select) return;
            
            // Get all option elements except the first one (Select grower)
            const options = Array.from(select.options).slice(1);
            
            // Sort: UO first, then alphabetically
            options.sort((a, b) => {
                if (a.text === 'UO') return -1;
                if (b.text === 'UO') return 1;
                return a.text.localeCompare(b.text);
            });
            
            // Clear existing options except the first
            while (select.options.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            // Add back the sorted options
            options.forEach(option => {
                select.appendChild(option);
            });
        }
        // Print option handlers
        function setupPrintHandlers() {
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('print-option-btn')) {
                    document.querySelectorAll('.print-option-btn').forEach(btn => btn.classList.remove('selected'));
                    e.target.classList.add('selected');
                    selectedPrintOption = e.target.dataset.option;
                }
            });

            document.getElementById('printPopupOverlay').addEventListener('click', function(e) {
                if (e.target === this) {
                    hidePrintPopup();
                }
            });

            // Photo popup click outside to close
            document.getElementById('photoPopupOverlay').addEventListener('click', function(e) {
                if (e.target === this) {
                    hidePhotoPopup();
                }
            });

            // Lot selection popup click outside to close
            document.getElementById('lotSelectionPopup').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideLotSelectionPopup();
                }
            });

            // Lot actions popup click outside to close
            document.getElementById('lotActionsPopup').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideLotActionsPopup();
                }
            });

            // Low inventory popup click outside to close
            document.getElementById('lowInvPopup').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideLowInvPopup();
                }
            });

            // Delete confirmation popup click outside to close
            document.getElementById('deleteConfirmPopup').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideDeleteConfirm();
                }
            });

            // Add lot popup click outside to close
            document.getElementById('addLotPopup').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideAddLotPopup();
                }
            });

            // Low inventory warning popup click outside to close
            document.getElementById('lowInventoryWarning').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideLowInventoryWarning();
                }
            });

            // No lot warning popup click outside to close
            document.getElementById('noLotWarning').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideNoLotWarning();
                }
            });

            // Retire lot popup click outside to close
            document.getElementById('retireLotPopup').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideRetireLotPopup();
                }
            });

            // Stock seed popup click outside to close
            document.getElementById('stockSeedPopup').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideStockSeedPopup();
                }
            });

            // Germination popup click outside to close
            document.getElementById('germinationPopup').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideGerminationPopup();
                }
            });

            // Front labels popup click outside to close
            document.getElementById('editFrontLabelsPopup').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideEditFrontLabelsPopup();
                }
            });

            // Back labels popup click outside to close
            document.getElementById('editBackLabelsPopup').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideEditBackLabelsPopup();
                }
            });
            // Change status popup click outside to close
            document.getElementById('changeStatusPopup').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideChangeStatusPopup();
                }
            });

            // Pending status warning popup click outside to close
            document.getElementById('pendingStatusWarning').addEventListener('click', function(e) {
                if (e.target === this) {
                    hidePendingStatusWarning();
                }
            });

            // Add product popup click outside to close
            document.getElementById('addProductPopup').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideAddProductPopup();
                }
            });

            document.getElementById('lotHistoryPopup').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideLotHistoryPopup();
                }
            });

            document.getElementById('forYearMismatchWarning').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideForYearMismatchWarning();
                }
            });

            // Recent print warning popup click outside to close
            document.getElementById('recentPrintWarning').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideRecentPrintWarning();
                }
            });

            // Add this with your other popup event listeners
            document.getElementById('productPackingHistoryPopup').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideProductPackingHistoryPopup();
                }
            });

            document.getElementById('editPackingRecordPopup').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideEditPackingRecordPopup();
                }
            });

            // Delete packing record popup click outside to close
            document.getElementById('deletePackingRecordPopup').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideDeletePackingRecordPopup();
                }
            });

            document.getElementById('reprintStockSeedPopup').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideReprintStockSeedPopup();
                }
            });

            // Inventory popup click outside to close
            document.getElementById('inventoryPopup').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideInventoryPopup();
                }
            });

            // Add/Overwrite Inventory popup click outside to close
            document.getElementById('addOverwriteInventoryPopup').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideAddOverwriteInventoryPopup();
                }
            });

        }
        



        // Updated Lot History Functions
        function viewLotHistory(lotId) {
            hideLotActionsPopup();
            
            // Show popup immediately
            document.getElementById('lotHistoryPopup').classList.add('show');
            document.body.classList.add('modal-open');
            
            // Fetch lot history data
            fetch('/office/get-lot-history/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    lot_id: lotId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    populateLotHistoryPopup(data.data);
                } else {
                    showMessage('Error loading lot history: ' + (data.error || 'Unknown error'), 'error');
                    hideLotHistoryPopup();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Network error occurred', 'error');
                hideLotHistoryPopup();
            });
        }

        function populateLotHistoryPopup(data) {
            // Basic info
            document.getElementById('historyVarietyName').textContent = data.variety_name;
            document.getElementById('historySkuDisplay').textContent = data.sku_display;
            
            // Low inventory status
            const lowInvElement = document.getElementById('historyLowInventory');
            lowInvElement.textContent = data.low_inventory ? 'Yes' : 'No';
            lowInvElement.className = `info-value lot-status-indicator ${data.low_inventory}`;
            
            // Retired status - always show
            const retiredElement = document.getElementById('historyRetiredStatus');
            const retiredDetailsSection = document.getElementById('retiredDetailsSection');
            
            if (data.is_retired) {
                retiredElement.textContent = 'Yes';
                retiredElement.className = 'info-value lot-status-indicator retired';
                retiredDetailsSection.style.display = 'block';
                
                if (data.retired_info) {
                    document.getElementById('historyRetiredDate').textContent = data.retired_info.date;
                    document.getElementById('historyRetiredLbs').textContent = `${data.retired_info.lbs_remaining} lbs`;
                    
                    const retiredNotesRow = document.getElementById('retiredNotesRow');
                    if (data.retired_info.notes) {
                        document.getElementById('historyRetiredNotes').textContent = data.retired_info.notes;
                        retiredNotesRow.style.display = 'flex';
                    } else {
                        retiredNotesRow.style.display = 'none';
                    }
                }
            } else {
                retiredElement.textContent = 'No';
                retiredElement.className = 'info-value lot-status-indicator false';
                retiredDetailsSection.style.display = 'none';
            }
            
            // Stock seed records
            populateStockSeedRecords(data.stock_seeds);
            
            // Inventory records
            populateInventoryRecords(data.inventory_records);
            
            // Germination records
            populateGerminationRecords(data.germination_records);
            
            // Packing history records
            populatePackingHistoryRecords(data.packing_history);
            
            // Notes
            populateNotesRecords(data.notes);
        }

        function populateStockSeedRecords(stockSeeds) {
            const container = document.getElementById('stockSeedContent');
            
            if (stockSeeds.length === 0) {
                container.innerHTML = '<div class="no-records">No stock seed records found</div>';
                return;
            }
            
            container.innerHTML = stockSeeds.map(stock => `
                <div class="stock-record-item">
                    <div class="stock-record-main">
                        <span class="record-date">${stock.date}</span>
                        <div class="record-detail">
                            <span class="record-detail-label">Qty:</span>
                            <span class="record-detail-value">${stock.qty}</span>
                        </div>
                    </div>
                    ${stock.notes ? `<div class="record-notes">${stock.notes}</div>` : ''}
                </div>
            `).join('');
        }


        function populateInventoryRecords(inventoryRecords) {
            const container = document.getElementById('inventoryContent');
            
            if (inventoryRecords.length === 0) {
                container.innerHTML = '<div class="no-records">No inventory records found</div>';
                return;
            }
            
            container.innerHTML = inventoryRecords.map((inv, index) => {
                const hasNote = inv.notes ? 'has-note' : '';
                const clickHandler = inv.notes ? `onclick="showNotePopup(event, ${index}, 'inv')"` : '';
                
                return `
                    <div class="record-item ${hasNote}" ${clickHandler} data-note-content="${inv.notes ? inv.notes.replace(/"/g, '&quot;') : ''}">
                        <div class="record-main-info">
                            <span class="record-date">${inv.date}</span>
                            <div class="record-detail">
                                <span class="record-detail-label">Weight:</span>
                                <span class="record-detail-value">${inv.weight} lbs</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
 

        function populateGerminationRecords(germinationRecords) {
            const container = document.getElementById('germinationContent');
            
            if (germinationRecords.length === 0) {
                container.innerHTML = '<div class="no-records">No germination records found</div>';
                return;
            }
            
            container.innerHTML = germinationRecords.map((germ, index) => {
                const hasNote = germ.notes ? 'has-note' : '';
                const clickHandler = germ.notes ? `onclick="showNotePopup(event, ${index}, 'germ')"` : '';
                
                return `
                    <div class="record-item ${hasNote}" ${clickHandler} data-note-content="${germ.notes ? germ.notes.replace(/"/g, '&quot;') : ''}">
                        <div class="record-main-info">
                            <span class="record-date">${germ.test_date}</span>
                            <div class="record-detail">
                                <span class="record-detail-label">Rate:</span>
                                <span class="record-detail-value">${germ.germination_rate}%</span>
                            </div>
                            <div class="record-detail">
                                <span class="record-detail-label">Year:</span>
                                <span class="record-detail-value">${germ.for_year}</span>
                            </div>
                        </div>
                        <span class="record-status ${germ.status}">${germ.status}</span>
                    </div>
                `;
            }).join('');
        }

        function showNotePopup(event, index, type) {
            event.stopPropagation();
            
            // Hide any existing popup
            hideNotePopup();
            
            // Get the note content from the data attribute
            const recordItem = event.target.closest('.record-item');
            const noteContent = recordItem.dataset.noteContent;
            
            if (!noteContent) return;
            
            // Create popup element
            const popup = document.createElement('div');
            popup.className = 'note-popup show';
            popup.innerHTML = `
                <button class="note-popup-close" onclick="hideNotePopup()">&times;</button>
                <div class="note-popup-content">${noteContent}</div>
            `;
            
            // Position popup near the clicked row
            const rect = event.target.getBoundingClientRect();
            popup.style.left = `${rect.left - 150}px`; // Center popup relative to click
            popup.style.top = `${rect.bottom + 10}px`;
            
            // Ensure popup stays within viewport
            document.body.appendChild(popup);
            const popupRect = popup.getBoundingClientRect();
            
            if (popupRect.right > window.innerWidth) {
                popup.style.left = `${window.innerWidth - popupRect.width - 20}px`;
            }
            if (popupRect.left < 0) {
                popup.style.left = '20px';
            }
            if (popupRect.bottom > window.innerHeight) {
                popup.style.top = `${rect.top - popupRect.height - 10}px`;
            }
            
            currentNotePopup = popup;
            
            // Close popup when clicking outside
            setTimeout(() => {
                document.addEventListener('click', handleOutsideClick);
            }, 100);
        }

        function hideNotePopup() {
            if (currentNotePopup) {
                currentNotePopup.remove();
                currentNotePopup = null;
                document.removeEventListener('click', handleOutsideClick);
            }
        }

        function handleOutsideClick(event) {
            if (currentNotePopup && !currentNotePopup.contains(event.target)) {
                hideNotePopup();
            }
        }

        function hideLotHistoryPopup() {
            hideNotePopup(); // Add this line
            document.getElementById('lotHistoryPopup').classList.remove('show');
            document.body.classList.remove('modal-open');
        }


        function populatePackingHistoryRecords(packingHistory) {
            const container = document.getElementById('packingHistoryContent');
            
            if (packingHistory.length === 0) {
                container.innerHTML = '<div class="no-records">No packing records found</div>';
                return;
            }
            
            // Group by for_year and sort
            const groupedByYear = {};
            
            packingHistory.forEach(pack => {
                const year = pack.for_year || 'Unknown';
                if (!groupedByYear[year]) {
                    groupedByYear[year] = [];
                }
                groupedByYear[year].push(pack);
            });
            
            // Sort years (newest first) and sort records within each year by date (newest first)
            const sortedYears = Object.keys(groupedByYear).sort((a, b) => {
                if (a === 'Unknown') return 1;
                if (b === 'Unknown') return -1;
                return b.localeCompare(a); // Descending order
            });
            
            let html = '';
            
            sortedYears.forEach(year => {
                // Sort records within year by date (newest first)
                const sortedRecords = groupedByYear[year].sort((a, b) => 
                    new Date(b.date) - new Date(a.date)
                );
                
                // Add year header
                const displayYear = year.length === 2 ? `20${year}` : year;
                html += `
                    <div class="packing-year-header">
                        <h4>Packed for ${displayYear}:</h4>
                    </div>
                `;
                
                // Add records for this year
                sortedRecords.forEach(pack => {
                    html += `
                        <div class="record-item">
                            <div class="record-main-info">
                                <span class="record-date">${pack.date}</span>
                                <div class="record-detail">
                                    <span class="record-detail-label">SKU:</span>
                                    <span class="record-detail-value">${pack.product_sku}</span>
                                </div>
                                <div class="record-detail">
                                    <span class="record-detail-label">Qty:</span>
                                    <span class="record-detail-value">${pack.qty}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                // Add spacing between year groups
                if (year !== sortedYears[sortedYears.length - 1]) {
                    html += '<div class="year-group-spacing"></div>';
                }
            });
            
            container.innerHTML = html;
        }


        function populateNotesRecords(notes) {
            const container = document.getElementById('notesContent');
            
            if (notes.length === 0) {
                container.innerHTML = '<div class="no-records">No notes found</div>';
                return;
            }
            
            container.innerHTML = notes.map(note => `
                <div class="note-item">
                    <div class="note-date">${note.date}</div>
                    <div class="note-text">${note.note}</div>
                </div>
            `).join('');
        }

        function hideLotHistoryPopup() {
            document.getElementById('lotHistoryPopup').classList.remove('show');
            document.body.classList.remove('modal-open');
        }

        function showAddLotPopup() {
            document.getElementById('addLotPopup').classList.add('show');
        }

        function hideAddLotPopup() {
            document.getElementById('addLotPopup').classList.remove('show');
            document.getElementById('addLotForm').reset();
        }


        function submitAddLot(event) {
            event.preventDefault();
            
            const growerSelect = document.getElementById('lotGrowerSelect');
            const growerId = growerSelect.value;
            const growerCode = growerSelect.options[growerSelect.selectedIndex].getAttribute('data-grower-code'); // Get from data attribute
            const year = document.getElementById('lotYearInput').value;
            const harvest = document.getElementById('lotHarvestInput').value;
            
            // Construct the new lot code using just the grower code
            const newLotCode = `${growerCode}${year}${harvest}`;
            
            // Check if this lot already exists in the table
            const existingLots = getExistingLotsFromTable();
            
            if (existingLots.includes(newLotCode)) {
                showMessage(`Lot "${newLotCode}" already exists for this variety`, 'error');
                return; // Stop submission
            }
            
            // If we get here, the lot doesn't exist, so proceed with submission
            fetch('/office/add-lot/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    variety_sku: '{{ variety.sku_prefix }}',
                    grower_id: growerId, // Still uses the grower.pk for database association
                    year: year,
                    harvest: harvest
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = window.location.pathname;
                    localStorage.removeItem('germination_inventory_data'); 
                } else {
                    showMessage('Error adding lot: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Network error occurred', 'error');
            });
            
            hideAddLotPopup();
        }


        function getExistingLotsFromTable() {
            const existingLots = [];
            const lotRows = document.querySelectorAll('.lots-table tbody tr');
            
            lotRows.forEach(row => {
                // Get the lot code from the first column, excluding the edit icon
                const lotCell = row.cells[0];
                const lotText = lotCell.textContent.trim().replace(/\s+/g, '');
                
                // Skip empty or placeholder rows
                if (lotText && lotText !== '--') {
                    existingLots.push(lotText);
                }
            });
            
            return existingLots;
        }

        // Edit product lot functions
        function editProductLot(productId) {
            showLotSelectionPopup(productId, availableLots);
        }

        function showLotSelectionPopup(productId, lots) {
            const popup = document.getElementById('lotSelectionPopup');
            const lotsContainer = document.getElementById('availableLots');
            
            // Clear previous lots
            lotsContainer.innerHTML = '';
            
            // Add lots as clickable buttons
            lots.forEach(lot => {
                const button = document.createElement('button');
                button.className = 'lot-option-btn';
                button.textContent = `${lot.grower}${lot.year}${lot.harvest}`;
                button.onclick = () => assignLotToProduct(productId, lot.id);
                lotsContainer.appendChild(button);
            });
            
            // Add "No Lot" option
            const noLotButton = document.createElement('button');
            noLotButton.className = 'lot-option-btn no-lot';
            noLotButton.textContent = 'No Lot Assigned';
            noLotButton.onclick = () => assignLotToProduct(productId, null);
            lotsContainer.appendChild(noLotButton);
            
            popup.classList.add('show');
        }


        function assignLotToProduct(productId, lotId) {
            // Check if the "change all products" checkbox is checked
            const changeAllCheckbox = document.getElementById('changeAllProductsCheckbox');
            const changeAllProducts = changeAllCheckbox ? changeAllCheckbox.checked : false;
            
            fetch('/office/assign-lot-to-product/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    product_id: productId,
                    lot_id: lotId,
                    change_all_products: changeAllProducts
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show appropriate success message
                    const message = changeAllProducts 
                        ? `Lot updated for all products in this variety`
                        : `Lot updated for selected product`;
                    showMessage(message, 'success');
                    
                    setTimeout(() => {
                        window.location.href = window.location.pathname;
                    }, 2000);
                } else {
                    showMessage('Error assigning lot: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Network error occurred', 'error');
            });
            
            hideLotSelectionPopup();
        }

        function hideLotSelectionPopup() {
            document.getElementById('lotSelectionPopup').classList.remove('show');
            // Reset the checkbox when closing the popup
            const changeAllCheckbox = document.getElementById('changeAllProductsCheckbox');
            if (changeAllCheckbox) {
                changeAllCheckbox.checked = false;
            }
        }

        function hideLotSelectionPopup() {
            document.getElementById('lotSelectionPopup').classList.remove('show');
        }

        function hideRetiredLotWarning() {
            document.getElementById('retiredLotWarning').classList.remove('show');
        }

        function hideNoLotWarning() {
            document.getElementById('noLotWarning').classList.remove('show');
        }

        function showLotActionsPopup(element) {
            currentLotId = element.getAttribute('data-lot-id');
            currentLotLowInv = element.getAttribute('data-low-inv') === 'true';
            document.getElementById('lotActionsPopup').classList.add('show');
        }

        function hideLotActionsPopup() {
            document.getElementById('lotActionsPopup').classList.remove('show');
            currentLotId = null;
        }

        function editLotLowInv(lotId, currentStatus) {
            hideLotActionsPopup();
            currentLotId = lotId;
            
            // Style buttons based on current status
            const yesBtn = document.getElementById('lowInvYes');
            const noBtn = document.getElementById('lowInvNo');
            
            if (currentStatus) {
                yesBtn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                yesBtn.style.color = 'white';
                noBtn.style.background = '#f1f3f4';
                noBtn.style.color = '#666';
            } else {
                noBtn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                noBtn.style.color = 'white';
                yesBtn.style.background = '#f1f3f4';
                yesBtn.style.color = '#666';
            }
            
            document.getElementById('lowInvPopup').classList.add('show');
        }

        function setLotLowInv(isLowInv) {
            fetch('/office/set-lot-low-inv/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    lot_id: currentLotId,
                    low_inv: isLowInv
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = window.location.pathname;
                } else {
                    alert('Error updating low inventory: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Network error occurred');
            });
            
            hideLowInvPopup();
        }
        

    

        function retireLot(lotId) {
            hideLotActionsPopup();
            
            currentLotId = lotId;

            // Find the lot data to display variety and lot info
            const lot = allLotsData.find(l => l.id == lotId);
            let title = "Retire Lot";
            
            if (lot) {
                // Get variety name from the page (assuming it's available)
                const varietyName = document.getElementById('varietyName').textContent.trim();
                const lotDisplay = `${lot.grower}${lot.year}${lot.harvest}`;
                title = `Retiring ${varietyName} ${lotDisplay}`;
            }
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('retireLotTitle').textContent = title;
            document.getElementById('retireLotPopup').classList.add('show');
        }

        function hideRetireLotPopup() {
            document.getElementById('retireLotPopup').classList.remove('show');
            document.getElementById('retireLotForm').reset();
        }

        function submitRetireLot(event) {
            event.preventDefault();
            
            const lbsRemaining = document.getElementById('retireLbsInput').value;
            const notes = document.getElementById('retireNotesInput').value;
            const retireDate = document.getElementById('retireDateInput').value;

            console.log('Form data:', { // ADD THIS
                lot_id: currentLotId,
                lbs_remaining: lbsRemaining,
                retire_date: retireDate,
                notes: notes
            });
            
            fetch('/office/retire-lot/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    lot_id: currentLotId,
                    lbs_remaining: lbsRemaining,
                    retire_date: retireDate,
                    notes: notes
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    localStorage.removeItem('germination_inventory_data'); // Clear the cached data directly
                    showMessage('Lot retired successfully', 'success');
                    setTimeout(() => {
                        window.location.href = window.location.pathname;
                    }, 3000);
                } else {
                    showMessage('Error retiring lot: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Network error occurred', 'error');
            });
            
            hideRetireLotPopup();
        }


        function recordStockSeed(lotId) {
            hideLotActionsPopup();
            currentLotId = lotId;
            
            // Find the lot row in the table and check the Stock column
            const lotRows = document.querySelectorAll('.lots-table tbody tr');
            let hasStockSeed = false;
            
            for (const row of lotRows) {
                const editIcon = row.querySelector('.edit-icon');
                if (editIcon && editIcon.dataset.lotId === lotId.toString()) {
                    // Stock is in the 6th column (index 5)
                    const stockText = row.cells[5].textContent.trim();
                    hasStockSeed = stockText === 'Yes';
                    break;
                }
            }
            
            if (hasStockSeed) {
                showReprintStockSeedPopup(lotId);
            } else {
                showRecordStockSeedPopup(lotId);
            }
        }



        function showRecordStockSeedPopup(lotId) {
            // Find the lot data to display variety and lot info
            const lot = allLotsData.find(l => l.id == lotId);
            let title = "Record Stock Seed";
            
            if (lot) {
                const varietyName = document.getElementById('varietyName').textContent.trim();
                const lotDisplay = `${lot.grower}${lot.year}${lot.harvest}`;
                title = `Record Stock Seed<br>${varietyName} ${lotDisplay}`;
            }
            
            document.getElementById('stockSeedTitle').innerHTML = title;
            document.getElementById('stockSeedPopup').classList.add('show');
        }

        function showReprintStockSeedPopup(lotId) {
            document.getElementById('reprintStockSeedPopup').classList.add('show');
        }

        function hideReprintStockSeedPopup() {
            document.getElementById('reprintStockSeedPopup').classList.remove('show');
            currentLotId = null;
        }

        function reprintStockSeedLabel() {
            const lotId = currentLotId; // Capture the value immediately
            console.log('Reprinting for lot ID:', lotId);
            
            if (!lotId) {
                showMessage('No lot selected', 'error');
                return;
            }
            
            // Hide popup immediately since we have the ID captured
            hideReprintStockSeedPopup();
            
            // First check if Flask app is running
            checkFlaskConnection()
                .then(isFlaskRunning => {
                    if (!isFlaskRunning) {
                        showMessage('Local Flask printing app not running', 'error');
                        return;
                    }
                    
                    console.log('About to send request to Django with lot_id:', lotId);
                    
                    // Fetch existing stock seed data from Django
                    fetch('/office/get-stock-seed-data/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({
                            lot_id: lotId // Use the captured value
                        })
                    })
                    .then(response => {
                        console.log('Django response received:', response);
                        return response.json();
                    })
                    .then(data => {
                        console.log('Django response data:', data);
                        if (data.success) {
                            // Send to Flask for printing
                            const printData = {
                                variety: data.variety_name,
                                veg_type: data.veg_type,
                                lot_number: data.lot_number,
                                quantity: data.quantity
                            };
                            
                            fetch('http://localhost:5000/print-stock-seed-label', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(printData)
                            })
                            .then(flaskResponse => {
                                if (flaskResponse.ok) {
                                    showMessage('Stock seed label sent to printer successfully', 'success');
                                } else {
                                    showMessage('Printing failed', 'error');
                                }
                            })
                            .catch(flaskError => {
                                console.error('Flask printing error:', flaskError);
                                showMessage('Printing failed', 'error');
                            });
                        } else {
                            showMessage('Error fetching stock seed data: ' + (data.error || 'Unknown error'), 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showMessage('Network error occurred', 'error');
                    });
                })
                .catch(error => {
                    console.error('Error checking Flask connection:', error);
                    showMessage('Local Flask printing app not running', 'error');
                });
        }









        function hideStockSeedPopup() {
            document.getElementById('stockSeedPopup').classList.remove('show');
            document.getElementById('stockSeedForm').reset();
        }

        function submitStockSeed(event) {
            event.preventDefault();
            
            const qty = document.getElementById('stockSeedQtyInput').value;
            const notes = document.getElementById('stockSeedNotesInput').value;
            
            // First check if Flask app is running
            console.log('Checking Flask connection for stock seed recording...');
            checkFlaskConnection()
                .then(isFlaskRunning => {
                    console.log('Flask running status for stock seed:', isFlaskRunning);
                    if (!isFlaskRunning) {
                        showMessage('Local Flask printing app not running - cannot print stock seed label', 'error');
                        return;
                    }
                    
                    // Flask is running, proceed with Django backend submission
                    console.log('Flask healthy, proceeding with stock seed recording...');
                    proceedWithStockSeedSubmission(qty, notes);
                })
                .catch(error => {
                    console.error('Error checking Flask connection for stock seed:', error);
                    showMessage('Local Flask printing app not running - cannot print stock seed label', 'error');
                });
        }

        function proceedWithStockSeedSubmission(qty, notes) {
            // Submit to Django backend first
            fetch('/office/record-stock-seed/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    lot_id: currentLotId,
                    qty: qty,
                    notes: notes
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Django submission successful, now send to Flask for printing
                    console.log('Stock seed recorded in Django, sending to Flask for printing...');
                    
                    const stockSeedPrintData = collectStockSeedPrintData(qty);
                    
                    if (!stockSeedPrintData) {
                        showMessage('Stock seed recorded but could not collect print data', 'error');
                        hideStockSeedPopup();
                        return;
                    }
                    
                    // Send to Flask for printing
                    fetch('http://localhost:5000/print-stock-seed-label', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(stockSeedPrintData)
                    })
                    .then(flaskResponse => {
                        if (flaskResponse.ok) {
                            showMessage('Stock seed recorded and label sent to printer successfully', 'success');
                        } else {
                            showMessage('Stock seed recorded but printing failed', 'error');
                        }
                        
                        setTimeout(() => {
                            window.location.href = window.location.pathname;
                        }, 2000);
                    })
                    .catch(flaskError => {
                        console.error('Flask printing error:', flaskError);
                        showMessage('Stock seed recorded but printing failed', 'error');
                        setTimeout(() => {
                            window.location.href = window.location.pathname;
                        }, 2000);
                    });
                    
                } else {
                    showMessage('Error recording stock seed: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Network error occurred', 'error');
            });
            
            hideStockSeedPopup();
        }

        function collectStockSeedPrintData(quantity) {
            try {
                // Get variety information
                const varietyName = document.getElementById('varietyName').textContent.trim();
                const vegType = document.getElementById('varietyType').textContent.trim();
                
                // Find the lot data using currentLotId
                const lotData = allLotsData.find(lot => lot.id == currentLotId);
                
                if (!lotData) {
                    console.error('Could not find lot data for ID:', currentLotId);
                    return null;
                }
                
                // Construct lot number from grower + year
                const lotNumber = `${lotData.grower}${lotData.year}`;
                
                return {
                    variety: varietyName,
                    veg_type: vegType,
                    lot_number: lotNumber,
                    quantity: quantity
                };
                
            } catch (error) {
                console.error('Error collecting stock seed print data:', error);
                return null;
            }
        }
       

        function recordInventory(lotId) {
            hideLotActionsPopup();
            currentLotId = lotId;
            
            // Find recent inventory data from pre-loaded data
            const lotExtraData = lotsExtraData.find(extra => extra.id === parseInt(lotId));
            
            if (lotExtraData && lotExtraData.recent_inventory) {
                // Show add/overwrite popup
                lastInventoryId = lotExtraData.recent_inventory.id;
                document.getElementById('lastInventoryDisplay').textContent = lotExtraData.recent_inventory.display;
                document.getElementById('addOverwriteInventoryPopup').classList.add('show');
            } else {
                // Show normal inventory popup
                showNormalInventoryPopup(lotId);
            }
        }

        function showNormalInventoryPopup(lotId) {
            lastInventoryId = null;
            inventoryAction = 'new';
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('inventoryDateInput').value = today;
            
            const lot = allLotsData.find(l => l.id == lotId);
            let title = "Record Inventory";
            
            if (lot) {
                const varietyName = document.getElementById('varietyName').textContent.trim();
                const lotDisplay = `${lot.grower}${lot.year}${lot.harvest}`;
                title = `Record Inventory<br>${varietyName} ${lotDisplay}`;
            }
            
            document.getElementById('inventoryTitle').innerHTML = title;
            document.getElementById('inventoryPopup').classList.add('show');
        }

        function hideAddOverwriteInventoryPopup() {
            document.getElementById('addOverwriteInventoryPopup').classList.remove('show');
            document.getElementById('addOverwriteInventoryForm').reset();
            lastInventoryId = null;
        }

        function submitAddOverwriteInventory(event) {
            event.preventDefault();
            
            const weight = document.getElementById('addOverwriteWeightInput').value;
            const action = event.submitter.value; // 'add' or 'overwrite'
            
            fetch('/office/update-inventory/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    inventory_id: lastInventoryId,
                    weight: weight,
                    action: action
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const actionText = action === 'add' ? 'added to' : 'overwritten';
                    showMessage(`Inventory ${actionText} successfully`, 'success');
                    setTimeout(() => {
                        window.location.href = window.location.pathname;
                    }, 2000);
                } else {
                    showMessage('Error updating inventory: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Network error occurred', 'error');
            });
            
            hideAddOverwriteInventoryPopup();
        }

        function hideInventoryPopup() {
            document.getElementById('inventoryPopup').classList.remove('show');
            document.getElementById('inventoryForm').reset();
        }

        function submitInventory(event) {
            event.preventDefault();
            
            const weight = document.getElementById('inventoryWeightInput').value;
            const invDate = document.getElementById('inventoryDateInput').value;
            const notes = document.getElementById('inventoryNotesInput').value;
            
            fetch('/office/record-inventory/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    lot_id: currentLotId,
                    weight: weight,
                    inv_date: invDate,
                    notes: notes
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => Promise.reject(err));
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showMessage('Inventory recorded successfully', 'success');
                    setTimeout(() => {
                        window.location.href = window.location.pathname;
                    }, 2000);
                } else {
                    showMessage('Error recording inventory: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                if (error.error) {
                    showMessage('Error recording inventory: ' + error.error, 'error');
                } else {
                    console.error('Error:', error);
                    showMessage('Network error occurred', 'error');
                }
            });
            
            hideInventoryPopup();
        }





















        // function recordInventory(lotId) {
        //     hideLotActionsPopup();
        //     currentLotId = lotId;
            
        //     // Set default date to today
        //     const today = new Date().toISOString().split('T')[0];
        //     document.getElementById('inventoryDateInput').value = today;
            
        //     // Find the lot data to display variety and lot info
        //     const lot = allLotsData.find(l => l.id == lotId);
        //     let title = "Record Inventory";
            
        //     if (lot) {
        //         const varietyName = document.getElementById('varietyName').textContent.trim();
        //         const lotDisplay = `${lot.grower}${lot.year}${lot.harvest}`;
        //         title = `Record Inventory<br>${varietyName} ${lotDisplay}`;
        //     }
            
        //     document.getElementById('inventoryTitle').innerHTML = title;
        //     document.getElementById('inventoryPopup').classList.add('show');
        // }

        // function hideInventoryPopup() {
        //     document.getElementById('inventoryPopup').classList.remove('show');
        //     document.getElementById('inventoryForm').reset();
        // }

        // function submitInventory(event) {
        //     event.preventDefault();
            
        //     const weight = document.getElementById('inventoryWeightInput').value;
        //     const invDate = document.getElementById('inventoryDateInput').value;
        //     const notes = document.getElementById('inventoryNotesInput').value;
            
        //     fetch('/office/record-inventory/', {
        //         method: 'POST',
        //         headers: {
        //             'Content-Type': 'application/json',
        //             'X-CSRFToken': getCookie('csrftoken')
        //         },
        //         body: JSON.stringify({
        //             lot_id: currentLotId,
        //             weight: weight,
        //             inv_date: invDate,
        //             notes: notes
        //         })
        //     })
        //     .then(response => {
        //         if (!response.ok) {
        //             return response.json().then(err => Promise.reject(err));
        //         }
        //         return response.json();
        //     })
        //     .then(data => {
        //         if (data.success) {
        //             showMessage('Inventory recorded successfully', 'success');
        //             setTimeout(() => {
        //                 window.location.href = window.location.pathname;
        //             }, 2000);
        //         } else {
        //             showMessage('Error recording inventory: ' + (data.error || 'Unknown error'), 'error');
        //         }
        //     })
        //     .catch(error => {
        //         if (error.error) {
        //             showMessage('Error recording inventory: ' + error.error, 'error');
        //         } else {
        //             console.error('Error:', error);
        //             showMessage('Network error occurred', 'error');
        //         }
        //     });
            
        //     hideInventoryPopup();
        // }







        function recordGermination(lotId) {
            hideLotActionsPopup();
            currentLotId = lotId;
            
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('germinationDateInput').value = today;
            
            // Find the lot data to display variety and lot info
            const lot = allLotsData.find(l => l.id == lotId);
            let title = "Record Germination";
            
            if (lot) {
                const varietyName = document.getElementById('varietyName').textContent.trim();
                const lotDisplay = `${lot.grower}${lot.year}${lot.harvest}`;
                title = `Record Germination<br>${varietyName} ${lotDisplay}`;
            }
            
            document.getElementById('germinationTitle').innerHTML = title;
            document.getElementById('germinationPopup').classList.add('show');
        }

        function hideGerminationPopup() {
            document.getElementById('germinationPopup').classList.remove('show');
            document.getElementById('germinationForm').reset();
        }

        function submitGermination(event) {
            event.preventDefault();
            
            const germinationRate = document.getElementById('germinationRateInput').value;
            const testDate = document.getElementById('germinationDateInput').value;
            const notes = document.getElementById('germinationNotesInput').value;
            
            fetch('/office/record-germination/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    lot_id: currentLotId,
                    germination_rate: germinationRate,
                    test_date: testDate,
                    notes: notes
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => Promise.reject(err));
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showMessage('Germination recorded successfully', 'success');
                    localStorage.removeItem('germination_inventory_data'); // Clear the cached data directly
                    setTimeout(() => {
                        window.location.href = window.location.pathname;
                    }, 2000);
                } else {
                    showMessage('Error recording germination: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                if (error.error) {
                    showMessage('Error recording germination: ' + error.error, 'error');
                } else {
                    console.error('Error:', error);
                    showMessage('Network error occurred', 'error');
                }
            });
            
            hideGerminationPopup();
        }


        function changeLotStatus(lotId) {
            hideLotActionsPopup();
            
            // Find the current status from the lots table
            const currentStatus = getCurrentLotStatus(lotId);
            
            if (!currentStatus) {
                showMessage('Could not find lot status', 'error');
                return;
            }
            
            if (currentStatus.toLowerCase() === 'retired') {
                showMessage('Cannot change status of a retired lot', 'error');
                return;
            }
            
            // Show the status change popup
            showChangeStatusPopup(lotId, currentStatus);
        }

        function getCurrentLotStatus(lotId) {
            // Find the lot row in the lots table
            const lotRows = document.querySelectorAll('.lots-table tbody tr');
            
            for (const row of lotRows) {
                const editIcon = row.querySelector('.edit-icon');
                if (editIcon && editIcon.dataset.lotId === lotId.toString()) {
                    // Status is in the 4th column (index 3)
                    return row.cells[3].textContent.trim();
                }
            }
            
            return null;
        }

        function showChangeStatusPopup(lotId, currentStatus) {
            currentLotId = lotId;
            
            // Set title
            const lot = allLotsData.find(l => l.id == lotId);
            let title = "Change Lot Status";
            if (lot) {
                const varietyName = document.getElementById('varietyName').textContent.trim();
                const lotDisplay = `${lot.grower}${lot.year}${lot.harvest}`;
                title = `Change Status: ${varietyName} ${lotDisplay}`;
            }
            
            document.getElementById('changeStatusTitle').textContent = title;
            
            // Style buttons based on current status
            const pendingBtn = document.getElementById('pendingStatusBtn');
            const activeBtn = document.getElementById('activeStatusBtn');
            
            // Reset button classes
            pendingBtn.className = 'print-action-btn';
            activeBtn.className = 'print-action-btn';
            
            // Highlight current status
            if (currentStatus.toLowerCase() === 'pending') {
                pendingBtn.classList.add('status-btn-current');
                activeBtn.classList.add('status-btn-available');
            } else if (currentStatus.toLowerCase() === 'active') {
                activeBtn.classList.add('status-btn-current');
                pendingBtn.classList.add('status-btn-available');
            }
            
            document.getElementById('changeStatusPopup').classList.add('show');
        }

        function hideChangeStatusPopup() {
            document.getElementById('changeStatusPopup').classList.remove('show');
            currentLotId = null;
        }

        function setLotStatus(newStatus) {
            if (!currentLotId) {
                showMessage('No lot selected', 'error');
                return;
            }
            
            fetch('/office/change-lot-status/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    lot_id: currentLotId,
                    status: newStatus
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(`Lot status changed to ${newStatus}`, 'success');
                    setTimeout(() => {
                        window.location.href = window.location.pathname;
                    }, 2000);
                } else {
                    showMessage('Error changing status: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Network error occurred', 'error');
            });
            
            hideChangeStatusPopup();
        }

        function viewLotUsage(lotId) {
            hideLotActionsPopup();
            console.log('View usage for lot:', lotId);
            showMessage('View Usage functionality coming soon', 'success');
            // TODO: Implement usage view popup
        }

        function deleteLot(lotId) {
            hideLotActionsPopup();
            if (confirm('Are you sure you want to delete this lot? This action cannot be undone.')) {
                // console.log('Delete lot:', lotId);
                // TODO: Implement delete lot API call
            }
        }

        function deleteLot(lotId) {
            hideLotActionsPopup();
            lotToDelete = lotId;
            document.getElementById('deleteConfirmPopup').classList.add('show');
        }

        function confirmDeleteLot() {
            if (lotToDelete) {
                // TODO: Make API call to delete the lot
                fetch('/office/delete-lot/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        lot_id: lotToDelete
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = window.location.pathname;
                    } else {
                        alert('Error deleting lot: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Network error occurred');
                });
            }
            hideDeleteConfirm();
        }

        function hideDeleteConfirm() {
            document.getElementById('deleteConfirmPopup').classList.remove('show');
            lotToDelete = null;
        }
        function hideLowInvPopup() {
            document.getElementById('lowInvPopup').classList.remove('show');
            currentLotId = null;
        }

        function findLotById(lotId) {
            return allLotsData.find(lot => lot.id == lotId);
        }


        function showAddProductPopup() {
            document.body.classList.add('modal-open');
            document.getElementById('addProductPopup').classList.add('show');
        }

        function hideAddProductPopup() {
            document.body.classList.remove('modal-open');
            document.getElementById('addProductPopup').classList.remove('show');
            document.getElementById('addProductForm').reset();
        }

        function submitAddProduct(event) {
            event.preventDefault();
            
            const formData = new FormData();
            formData.append('variety_id', '{{ variety.sku_prefix }}');
            formData.append('sku_suffix', document.getElementById('productSkuSuffix').value);
            formData.append('pkg_size', document.getElementById('productPkgSize').value);
            formData.append('env_type', document.getElementById('productEnvType').value);
            formData.append('alt_sku', document.getElementById('productAltSku').value);
            formData.append('lineitem_name', document.getElementById('productLineitemName').value);
            formData.append('rack_location', document.getElementById('productRackLocation').value);
            formData.append('env_multiplier', document.getElementById('productEnvMultiplier').value);
            formData.append('label', document.getElementById('productLabel').value);
            formData.append('num_printed', document.getElementById('productNumPrinted').value);
            formData.append('num_printed_next_year', document.getElementById('productNumPrintedNextYear').value);
            formData.append('scoop_size', document.getElementById('productScoopSize').value);
            formData.append('bulk_pre_pack', document.getElementById('productBulkPrePack').value);
            formData.append('print_back', document.getElementById('productPrintBack').checked);
            formData.append('is_sub_product', document.getElementById('productIsSubProduct').checked);
            formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
            
            fetch('/office/add-product/', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('Product added successfully', 'success');
                    setTimeout(() => {
                        window.location.href = window.location.pathname;
                    }, 2000);
                } else {
                    let errorMessage = 'Error adding product';
                    if (data.errors) {
                        const errors = Object.values(data.errors).flat();
                        errorMessage += ': ' + errors.join(', ');
                    }
                    showMessage(errorMessage, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Network error occurred', 'error');
            });
            
            hideAddProductPopup();
        }

        // Get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Dashboard navigation
        function goToDashboard() {
            window.location.href = "/office/dashboard/";
        }
    </script>
</body>
</html>