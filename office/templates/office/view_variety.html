{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Variety Lookup - Uprising Seeds</title>

    <link rel="stylesheet" href="{% static 'office/css/base.css' %}">
    <link rel="stylesheet" href="{% static 'office/css/view_variety.css' %}">

</head>

<body>
    <div class="container">
        <!-- Header Section -->
        <div class="header">
            <!-- Left: Brand and Search -->
            <div class="header-left">
                <div class="top-row">
                    <button class="dashboard-btn" onclick="goToDashboard()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 12H5M12 19l-7-7 7-7"/>
                        </svg>
                        Dashboard
                    </button>
                    
                    <div class="brand-section">
                        <h1 class="brand-title">Variety Lookup</h1>
                    </div>
                </div>
                            
                <div class="search-container">
                    <input type="text" class="search-input" id="varietySearch" placeholder="Search varieties..." autocomplete="off">
                    <div class="search-dropdown" id="searchDropdown">
                        <!-- Dropdown items will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Center: Variety Info -->
            <div class="header-center">
                <div class="variety-info">
                    <!-- <div class="variety-name" id="varietyName">
                        {% if variety %}{{ variety.var_name|default:"Select a variety" }}{% else %}Select a variety{% endif %}
                    </div> -->
                    <div class="variety-name" id="varietyName" style="display: flex; align-items: center; gap: 10px;">
                        {{ variety.var_name|default:"Select a variety to view details" }}
                        {% if variety.var_name %}
                        <span class="edit-icon" onclick="openEditVarietyPopup()" title="Edit Variety">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                        </span>
                        {% endif %}
                    </div>
                    <div class="variety-details">
                        <div class="variety-detail">
                            <span class="variety-detail-label">SKU:</span>
                            <span class="variety-detail-value" id="varietySku">{% if variety %}{{ variety.sku_prefix }}{% else %}--{% endif %}</span>
                        </div>
                        <div class="variety-detail">
                            <span class="variety-detail-label">Type:</span>
                            <span class="variety-detail-value" id="varietyType">{% if variety %}{{ variety.veg_type|default:"--" }}{% else %}--{% endif %}</span>
                        </div>
                        {% if variety and variety.days %}
                        <div class="variety-detail">
                            <span class="variety-detail-value">{{ variety.days }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Right: Photo -->
            <div class="header-right">
                <div class="variety-photo-container" onclick="showPhotoPopup()">
                    {% if variety and variety.photo_path %}
                        <img src="{% static variety.photo_path %}" alt="{{ variety.var_name }}" class="variety-photo" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="photo-placeholder" style="display: none;">
                            Photo Not<br>Found
                        </div>
                    {% else %}
                        <div class="photo-placeholder">
                            No Photo<br>Available
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        {% if messages %}
            <div class="messages-container">
                {% for message in messages %}
                    <div class="message message-{{ message.tags }}">
                        <span class="message-text">{{ message }}</span>
                        <button class="message-close" onclick="this.parentElement.remove()">×</button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <!-- Main Content: Tables on Left, Labels on Right -->
        <div class="main-content">
            <!-- Left Side: Tables Container -->
            <div class="tables-container">
                <!-- Products Table -->
                <div class="table-section">
                    {% if products %}
                    <div class="table-wrapper">
                        <table class="data-table products-table">
                            <thead>
                                <tr>
                                    <th>
                                        Product
                                        <span class="add-icon" onclick="showAddProductPopup()">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="12" cy="12" r="10"></circle>
                                                <line x1="12" y1="8" x2="12" y2="16"></line>
                                                <line x1="8" y1="12" x2="16" y2="12"></line>
                                            </svg>
                                        </span>
                                    </th>
                                    <th>Lot</th>
                                    <th>YTD Sales</th>
                                    <th>Last Year Sales</th>
                                    <th># Printed</th>
                                    <th>Env. Type</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for product in products %}
                                    <tr data-product-id="{{ product.pk }}"
                                        data-variety-name="{{ product.variety.var_name }}"
                                        data-crop="{{ product.variety.crop|default:'' }}"
                                        data-common-name="{{ product.variety.common_name|default:'' }}"
                                        data-days="{{ product.variety.days|default:'' }}"
                                        data-sku-suffix="{{ product.sku_suffix|default:'' }}"
                                        data-pkg-size="{{ product.pkg_size|default:'' }}"
                                        data-env-type="{{ product.env_type|default:'' }}"
                                        data-alt-sku="{{ product.alt_sku|default:'' }}"
                                        data-lineitem-name="{{ product.lineitem_name|default:'' }}"
                                        data-rack-location="{{ product.rack_location|default:'' }}"
                                        data-env-multiplier="{{ product.env_multiplier|default:'' }}"
                                        data-scoop-size="{{ product.scoop_size|default:'' }}"
                                        data-print-back="{{ product.print_back|yesno:'true,false' }}"
                                        data-is-sub-product="{{ product.is_sub_product|yesno:'true,false' }}"
                                        data-rad-type="{{ product.variety.get_rad_type|default:'' }}"
                                        data-desc1="{{ product.variety.desc_line1|default:'' }}"
                                        data-desc2="{{ product.variety.desc_line2|default:'' }}"
                                        data-desc3="{{ product.variety.desc_line3|default:'' }}"
                                        data-back1="{{ product.variety.back1|default:'' }}"
                                        data-back2="{{ product.variety.back2|default:'' }}"
                                        data-back3="{{ product.variety.back3|default:'' }}"
                                        data-back4="{{ product.variety.back4|default:'' }}"
                                        data-back5="{{ product.variety.back5|default:'' }}"
                                        data-back6="{{ product.variety.back6|default:'' }}"
                                        data-back7="{{ product.variety.back7|default:'' }}"
                                        data-lot-code="{% if product.lot %}{% if product.lot.grower and product.lot.year %}{{ product.lot.grower }}{{ product.lot.year }}{% if product.lot.harvest %}{{ product.lot.harvest }}{% endif %}{% endif %}{% endif %}"
                                        data-germination="{% if product.lot %}{{ product.lot.get_most_recent_germ_percent|default:'' }}{% endif %}"
                                        data-lot-for-year="{% if product.lot %}{{ product.lot.get_most_recent_germ_for_year|default:'' }}{% endif %}"
                                        data-for-year="25"
                                        data-last-print-date="{{ product.get_last_print_date }}">
                                        <td>
                                            <div class="product-cell-content">
                                                <span class="print-icon" onclick="showPrintPopup('{{ product.pk }}', '{{ product.variety.var_name|escapejs }} - {{ product.sku_suffix|escapejs }}')">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <polyline points="6,9 6,2 18,2 18,9"></polyline>
                                                        <path d="M6,18H4a2,2,0,0,1-2-2V11a2,2,0,0,1,2-2H20a2,2,0,0,1,2,2v5a2,2,0,0,1-2,2H18"></path>
                                                        <polyline points="6,14 18,14 18,22 6,22 6,14"></polyline>
                                                    </svg>
                                                </span>
                                                <span class="edit-icon" onclick="showProductActionsPopup('{{ product.pk }}')">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                                    </svg>
                                                </span>
                                                <span class="product-sku">{{ product.sku_suffix|default:"--" }}</span>
                                            </div>
                                        </td>
                                        <td>
                                            {% if product.lot %}
                                                {% if product.lot.grower and product.lot.year %}
                                                    {{ product.lot.grower }}{{ product.lot.year }}{% if product.lot.harvest %}{{ product.lot.harvest }}{% endif %}
                                                {% else %}
                                                    --
                                                {% endif %}
                                            {% else %}
                                                --
                                            {% endif %}
                         
                                        </td>
                                        <td>{{ product.get_ytd_sales|default:"--" }}</td>
                                        <td>{{ product.get_last_year_sales|default:"--" }}</td>
                                        <td>{{ product.get_total_printed|default:"0" }}</td>
                                        <td>{{ product.env_type|default:"--" }}</td>
                                    </tr>
                                    {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="empty-state">
                        No products found for this variety
                    </div>
                    {% endif %}
                </div>

                 <!-- Lots Table -->
                <div class="table-section">
                    <div class="table-wrapper">
                        <table class="data-table lots-table">
                            <thead>
                                <tr>
                                    <th>
                                        Lot
                                        <span class="add-icon" onclick="showAddLotPopup()">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="12" cy="12" r="10"></circle>
                                                <line x1="12" y1="8" x2="12" y2="16"></line>
                                                <line x1="8" y1="12" x2="16" y2="12"></line>
                                            </svg>
                                        </span>
                                    </th>
                                    <th>Germ (For yr.)</th>
                                    <th>Inventory</th>
                                    <!-- <th>Status</th> -->
                                     <th>
                                        Status
                                        <span class="filter-icon" id="statusFilterIcon" onclick="toggleRetiredLots()" title="Toggle retired lots">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                                            </svg>
                                        </span>
                                    </th>
                                    <th>Low Inventory</th>
                                    <th>Stock</th>
                                </tr>
                            </thead>
                            {% if lots %}
                            <tbody>
                                {% for lot in lots %}
                                <tr>
                                    <td>
                                        <span class="edit-icon" data-lot-id="{{ lot.pk }}" data-low-inv="{{ lot.low_inv|yesno:'true,false' }}" onclick="showLotActionsPopup(this)">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                            </svg>
                                        </span>
                                        {% if lot.grower and lot.year %}
                                            {{ lot.grower }}{{ lot.year }}{% if lot.harvest %}{{ lot.harvest }}{% endif %}
                                        {% else %}
                                            --
                                        {% endif %}
                                    </td>
                                    <td>
                                        {{ lot.get_most_recent_germ_percent_with_year|default:"--" }}
                                        {% if lot.get_germ_record_with_no_test_date %}*{% endif %}
                                    </td>
                                    <td>{{ lot.get_most_recent_inventory|default:"--" }}</td>
                                    <!-- <td>{{ lot.get_lot_status|default:"--" }}</td> -->
                                     <td>
                                        {% if lot.get_lot_status %}
                                            <span class="lot-status {{ lot.get_lot_status|lower }}">{{ lot.get_lot_status }}</span>
                                        {% else %}
                                            --
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if lot.low_inv %}
                                            <span class="yes-no-pill no">Yes</span>
                                        {% else %}
                                            <span class="yes-no-pill yes">No</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if lot.check_stock_seed %}
                                            <span class="yes-no-pill yes">Yes</span>
                                        {% else %}
                                            <span class="yes-no-pill no">No</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            {% endif %}
                        </table>
                    </div>
                    
                    {% if not lots %}
                    <div class="empty-state">
                        No lots found for this variety
                    </div>
                    {% endif %}
                    
                    {% if has_pending_germ %}
                        <div style="margin-top: 15px; margin-bottom: -15px; padding: 12px 20px; font-size: 0.9rem; color: #666; font-style: italic;">
                            * A new germination sample has been sent to the lab for testing
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Right Side: Label Info Section -->
            <div class="label-section">
                <div class="label-content">
                    <div class="label-group">
                        <div class="label-group-title">
                            Front Label
                            <span class="edit-icon" onclick="showEditFrontLabelsPopup()" style="margin-left: 10px;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                            </span>
                        </div>
                        {% if variety %}
                            <div class="label-line">
                                {% if variety.desc_line1 %}{{ variety.desc_line1 }}{% else %}<span class="label-line-empty">Line 1 not set</span>{% endif %}
                            </div>
                            <div class="label-line">
                                {% if variety.desc_line2 %}{{ variety.desc_line2 }}{% else %}<span class="label-line-empty">Line 2 not set</span>{% endif %}
                            </div>
                            {% if variety.desc_line3 %}
                            <div class="label-line">
                                {{ variety.desc_line3 }}
                            </div>
                            {% endif %}
                        {% else %}
                            <div class="label-line"><span class="label-line-empty">No variety selected</span></div>
                        {% endif %}
                    </div>

                    <div class="label-group">
                        <div class="label-group-title">
                            Back Label
                            <span class="edit-icon" onclick="showEditBackLabelsPopup()" style="margin-left: 10px;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                            </span>
                        </div>
                        {% if variety %}
                            <div class="label-line">
                                {% if variety.back1 %}{{ variety.back1 }}{% else %}<span class="label-line-empty">Back line 1 not set</span>{% endif %}
                            </div>
                            <div class="label-line">
                                {% if variety.back2 %}{{ variety.back2 }}{% else %}<span class="label-line-empty">Back line 2 not set</span>{% endif %}
                            </div>
                            <div class="label-line">
                                {% if variety.back3 %}{{ variety.back3 }}{% else %}<span class="label-line-empty">Back line 3 not set</span>{% endif %}
                            </div>
                            <div class="label-line">
                                {% if variety.back4 %}{{ variety.back4 }}{% else %}<span class="label-line-empty">Back line 4 not set</span>{% endif %}
                            </div>
                            <div class="label-line">
                                {% if variety.back5 %}{{ variety.back5 }}{% else %}<span class="label-line-empty">Back line 5 not set</span>{% endif %}
                            </div>
                            <div class="label-line">
                                {% if variety.back6 %}{{ variety.back6 }}{% else %}<span class="label-line-empty">Back line 6 not set</span>{% endif %}
                            </div>
                            <div class="label-line">
                                {% if variety.back7 %}{{ variety.back7 }}{% else %}<span class="label-line-empty">Back line 7 not set</span>{% endif %}
                            </div>
                        {% else %}
                            <div class="label-line"><span class="label-line-empty">No variety selected</span></div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Popup -->
    <div class="photo-popup-overlay" id="photoPopupOverlay">
        <div class="photo-popup">
            <button class="photo-popup-close" onclick="hidePhotoPopup()">×</button>
            
            {% if variety and variety.photo_path %}
                <img src="{% static variety.photo_path %}" alt="{{ variety.var_name }}" class="photo-popup-image" id="photoPopupImage" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="photo-popup-placeholder" style="display: none;">
                    Photo Not Found
                </div>
            {% else %}
                <div class="photo-popup-placeholder">
                    No Photo Available
                </div>
            {% endif %}
            
            <div class="photo-popup-caption" id="photoPopupCaption">
                {% if variety %}{{ variety.var_name }}{% else %}No variety selected{% endif %}
            </div>
        </div>
    </div>

    <!-- Print Popup -->

    <div class="print-popup-overlay" id="printPopupOverlay">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Print Labels</h3>
                <button class="print-popup-close" onclick="hidePrintPopup()">×</button>
            </div>
        
            <!-- Wrap both inputs in a flex container -->
            <div class="print-inputs-row">
                <div class="print-quantity-container">
                    <label class="print-quantity-label" for="printQuantity">Quantity:</label>
                    <input type="number" class="print-quantity-input" id="printQuantity" min="1" value="1">
                </div>
                <div class="print-quantity-container">
                    <label class="print-quantity-label" for="packedForYearSelect">Packed for year:</label>
                    <input type="text" class="print-quantity-input" id="packedForYearInput" style="display: none;" readonly>
                    <select class="print-quantity-input" id="packedForYearSelect" style="display: none;">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
            </div>

            <div class="print-options">
                <button class="print-option-btn selected" data-option="front_single">Front Single</button>
                <button class="print-option-btn" data-option="front_sheet">Front Sheet</button>
                <button class="print-option-btn" data-option="back_single">Back Single</button>
                <button class="print-option-btn" data-option="back_sheet">Back Sheet</button>
                <button class="print-option-btn" data-option="front_back_single">Front/Back Single</button>
                <button class="print-option-btn" data-option="front_back_sheet">Front/Back Sheet</button>
            </div>
        
            <div class="print-actions">
                <button class="print-action-btn cancel-btn" onclick="hidePrintPopup()">Cancel</button>
                <button class="print-action-btn print-btn" onclick="submitPrintJob()">Print</button>
            </div>
        </div>
    </div>

    <!-- Bulk Pre-Pack Prompt -->
    <div class="print-popup-overlay" id="bulkPrePackPrompt">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Record as Bulk Pre-Pack?</h3>
            </div>
            <p style="text-align: center; margin: 20px 0; color: #374151; font-size: 1rem; line-height: 1.6;">
                You're printing <strong><span id="bulkPrePackQty"></span> bulk labels</strong>.<br><br>
                Would you like to add these to the <strong>bulk pre-pack inventory</strong>?
            </p>
            <div class="print-actions">
                <button class="print-action-btn cancel-btn" onclick="cancelBulkPrePackPrompt()">Cancel Print</button>
                <button class="print-action-btn secondary-btn" onclick="continueWithoutBulkPrePack()">No, Don't Record</button>
                <button class="print-action-btn print-btn" onclick="continueWithBulkPrePack()">Yes, Record It</button>
            </div>
        </div>
    </div>

    <!-- Low Inventory Warning Popup -->
    <div class="print-popup-overlay" id="lowInventoryWarning">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Low Inventory Warning</h3>
                <button class="print-popup-close" onclick="hideLowInventoryWarning()">×</button>
            </div>
            <p style="text-align: center; margin-bottom: 25px; color: #ff6b6b;">
                This product is assigned to a lot with low inventory.<br>
                <strong>Do you want to continue printing?</strong>
            </p>
            <div class="print-actions">
                <button class="print-action-btn cancel-btn" onclick="hideLowInventoryWarning()">Cancel</button>
                <button class="print-action-btn print-btn" onclick="continuePrintDespiteLowInv()">Continue</button>
            </div>
        </div>
    </div>

    <!-- Recent Print Warning Popup -->
    <div class="print-popup-overlay" id="recentPrintWarning">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Recent Print Detected</h3>
                <button class="print-popup-close" onclick="hideRecentPrintWarning()">×</button>
            </div>
            <p style="text-align: center; margin-bottom: 25px; color: #ff6b6b;">
                This product was last printed on <strong id="lastPrintDateDisplay"></strong>.<br>
                <strong>Do you want to continue printing?</strong>
            </p>
            <div class="print-actions">
                <button class="print-action-btn cancel-btn" onclick="hideRecentPrintWarning()">Cancel</button>
                <button class="print-action-btn print-btn" onclick="continueRecentPrint()">Continue</button>
            </div>
        </div>
    </div>

    <!-- Pending Status Warning Popup -->
    <div class="print-popup-overlay" id="pendingStatusWarning">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Cannot Print</h3>
                <button class="print-popup-close" onclick="hidePendingStatusWarning()">×</button>
            </div>
            <p style="text-align: center; margin-bottom: 20px; color: #ff6b6b;">
                This product is assigned to a lot with pending status.<br>
                <strong>Please activate the lot before printing.</strong>
            </p>
            <div class="print-actions">
                <button class="print-action-btn cancel-btn" onclick="hidePendingStatusWarning()">OK</button>
            </div>
        </div>
    </div>

    <!-- Add Lot Popup -->
    <div class="print-popup-overlay" id="addLotPopup">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Add New Lot</h3>
                <button class="print-popup-close" onclick="hideAddLotPopup()">×</button>
            </div>
            
            <form id="addLotForm" onsubmit="submitAddLot(event)">
                <div class="form-group">
                    <label>Grower:</label>
                    <select id="lotGrowerSelect" required>
                        <option value="">Select grower</option>
                        <!-- {% for grower in growers %}
                            <option value="{{ grower.pk }}">{{ grower.code }}</option>
                        {% endfor %} -->
                        {% for grower in growers %}
                            <option value="{{ grower.pk }}" data-grower-code="{{ grower.code }}">{{ grower.code }} - {{ grower.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Year:</label>
                    <input type="text" id="lotYearInput" placeholder="two digit year" maxlength="2" required>
                </div>
                <div class="form-group">
                    <label>Harvest:</label>
                    <input type="text" id="lotHarvestInput" placeholder="A, B, C..." maxlength="1">
                </div>
                
                <div class="print-actions">
                    <button type="button" class="print-action-btn cancel-btn" onclick="hideAddLotPopup()">Cancel</button>
                    <button type="submit" class="print-action-btn print-btn">Add Lot</button>
                </div>
            </form>
        </div>
    </div>

    <!-- No Lot Warning Popup -->
    <div class="print-popup-overlay" id="noLotWarning">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Cannot Print</h3>
                <button class="print-popup-close" onclick="hideNoLotWarning()">×</button>
            </div>
            <p style="text-align: center; margin-bottom: 20px; color: #dc3545;">
                No lot detected for this product.<br>
                <strong>Please assign a lot before printing.</strong>
            </p>
            <div class="print-actions">
                <button class="print-action-btn cancel-btn" onclick="hideNoLotWarning()">OK</button>
            </div>
        </div>
    </div>

    <!-- Retired Lot Warning Popup -->
    <div class="print-popup-overlay" id="retiredLotWarning">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Cannot Print</h3>
                <button class="print-popup-close" onclick="hideRetiredLotWarning()">×</button>
            </div>
            <p style="text-align: center; margin-bottom: 20px;">This product is assigned to a retired lot.</p>
            <div class="print-actions">
                <button class="print-action-btn cancel-btn" onclick="hideRetiredLotWarning()">OK</button>
            </div>
        </div>
    </div>

    <!-- Product Actions Popup -->
    <div class="print-popup-overlay" id="productActionsPopup">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Product Actions</h3>
                <button class="print-popup-close" onclick="hideProductActionsPopup()">×</button>
            </div>
            
            <div class="lot-actions">
                <button class="lot-action-btn" onclick="changeProductLot(currentProductId)">Change Lot</button>
                <button class="lot-action-btn" onclick="editProduct(currentProductId)">Edit Product</button>
                <button class="lot-action-btn" onclick="viewProductPackingHistory(currentProductId)">View Packing History</button>
            </div>
        </div>
    </div>


    <!-- Edit Product Popup -->
    <div id="editProductPopup" class="modal-overlay">
        <div class="modal">
            <button class="close-modal" onclick="hideEditProductPopup()">&times;</button>
            <div class="modal-header">
                <h2 class="modal-title">Edit Product</h2>
            </div>

            <div id="editProductSuccessMessage" class="success-message" style="display: none;">
                Product updated successfully! 
            </div>

            <form id="editProductForm" onsubmit="submitEditProduct(event)">
                {% csrf_token %}
                <div class="form-grid">
                    <div class="form-group">
                        <label for="editProductVariety">Variety</label>
                        <input type="text" id="editProductVariety" name="variety" class="field-medium" readonly>
                    </div>

                    <div class="form-group">
                        <label for="editProductSkuSuffix">SKU Suffix *</label>
                        <select id="editProductSkuSuffix" name="sku_suffix" class="field-medium" required>
                            {% for suffix in sku_suffixes %}
                                <option value="{{ suffix }}">{{ suffix }}</option>
                            {% endfor %}
                        </select>
                        <div class="error-message" id="edit_sku_suffix_error"></div>
                    </div>

                    <div class="form-group">
                        <label for="editProductPkgSize">Package Size</label>
                        <select id="editProductPkgSize" name="pkg_size" class="field-narrow">
                            {% for size in pkg_sizes %}
                                <option value="{{ size }}">{{ size }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="editProductAltSku">Alternative SKU</label>
                        <input type="text" id="editProductAltSku" name="alt_sku" class="field-medium">
                    </div>

                    <div class="form-group">
                        <label for="editProductLineitemName">Line Item Name</label>
                        <input type="text" id="editProductLineitemName" name="lineitem_name" class="field-wide">
                    </div>

                    <div class="form-group">
                        <label for="editProductRackLocation">Rack Location</label>
                        <input type="text" id="editProductRackLocation" name="rack_location" class="field-medium">
                    </div>

                    <div class="form-group">
                        <label for="editProductEnvType">Envelope Type</label>
                        <select id="editProductEnvType" name="env_type" class="field-medium">
                            {% for env in env_types %}
                                <option value="{{ env }}">{{ env }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="editProductEnvMultiplier">Envelope Multiplier</label>
                        <input type="number" id="editProductEnvMultiplier" name="env_multiplier" value="1" class="field-narrow">
                    </div>

                    <div class="form-group">
                        <label for="editProductScoopSize">Scoop Size</label>
                        <input type="text" id="editProductScoopSize" name="scoop_size" class="field-medium">
                    </div>

                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="editProductPrintBack" name="print_back">
                        <label for="editProductPrintBack">Print Back</label>
                    </div>

                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="editProductIsSubProduct" name="is_sub_product">
                        <label for="editProductIsSubProduct">Is Sub Product</label>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideEditProductPopup()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Product</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Product Packing History Popup -->
    <div class="modal-overlay" id="productPackingHistoryPopup">
        <div class="modal lot-history-modal">
            <button class="close-modal" onclick="hideProductPackingHistoryPopup()">&times;</button>
                    
            <div class="lot-history-content">
                <!-- Basic Info Section -->
                <div class="history-section">
                    <div class="history-section-header">
                        <h3>Product Information</h3>
                    </div>
                    <div class="history-section-content">
                        <div class="info-row">
                            <span class="info-label">Variety:</span>
                            <span class="info-value" id="productHistoryVarietyName">--</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Product SKU:</span>
                            <span class="info-value" id="productHistorySkuDisplay">--</span>
                        </div> 
                    </div>
                </div>

                <!-- Packing History Section -->
                <div class="history-section">
                    <div class="history-section-header">
                        <h3>Print History</h3>
                    </div>
                    <div class="history-section-content">
                        <div id="productPackingHistoryContent">
                            <div class="no-records">No print records found</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lot Actions Popup -->
    <div class="print-popup-overlay" id="lotActionsPopup">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Lot Actions</h3>
                <button class="print-popup-close" onclick="hideLotActionsPopup()">×</button>
            </div>
            
            <div class="lot-actions">
                <button class="lot-action-btn" onclick="editLotLowInv(currentLotId, currentLotLowInv)">Set Low Inventory</button>
                <button class="lot-action-btn" onclick="retireLot(currentLotId)">Retire Lot</button>
                <button class="lot-action-btn" onclick="recordStockSeed(currentLotId)">Record Stock Seed</button>
                <button class="lot-action-btn" onclick="recordInventory(currentLotId)">Record Inventory</button>
                <button class="lot-action-btn" onclick="recordGermination(currentLotId)">Record Germination</button>
                <button class="lot-action-btn" onclick="changeLotStatus(currentLotId)">Change Status</button>
                <button class="lot-action-btn" onclick="viewLotUsage(currentLotId)">View Usage</button>
                <button class="lot-action-btn" onclick="viewLotHistory(currentLotId)">View History</button>
                <button class="lot-action-btn delete-btn" onclick="deleteLot(currentLotId)">Delete Lot</button>
            </div>
        </div>
    </div>


    <!-- Lot Selection Popup -->
    <div class="print-popup-overlay" id="lotSelectionPopup">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Select Lot</h3>
                <button class="print-popup-close" onclick="hideLotSelectionPopup()">×</button>
            </div>
            
            <!-- Add checkbox for changing all products -->
            <div class="change-all-checkbox-container">
                <label class="change-all-checkbox-label">
                    <input type="checkbox" id="changeAllProductsCheckbox" class="change-all-checkbox">
                    <span class="checkbox-text">Change lot for all product sizes?</span>
                </label>
            </div>
            
            <div id="availableLots" class="lot-options">
                <!-- Lots will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Low Inventory Popup -->
    <div class="print-popup-overlay" id="lowInvPopup">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Set Low Inventory</h3>
                <button class="print-popup-close" onclick="hideLowInvPopup()">×</button>
            </div>
            
            <div class="print-actions">
                <button class="print-action-btn" id="lowInvYes" onclick="setLotLowInv(true)">Yes</button>
                <button class="print-action-btn" id="lowInvNo" onclick="setLotLowInv(false)">No</button>
            </div>
        </div>
    </div>

    <!-- Retire Lot Popup -->
    <div class="print-popup-overlay" id="retireLotPopup">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title" id="retireLotTitle">Retire Lot</h3>
                <button class="print-popup-close" onclick="hideRetireLotPopup()">×</button>
            </div>
            
            <form id="retireLotForm" onsubmit="submitRetireLot(event)">
                <div class="form-group">
                    <label>Lbs Remaining:</label>
                    <input type="number" id="retireLbsInput" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Retirement Date:</label>
                    <input type="date" id="retireDateInput" value="{% now 'Y-m-d' %}">
                </div>
                <div class="form-group">
                    <label>Notes:</label>
                    <textarea id="retireNotesInput" rows="4" placeholder="Enter applicable notes..."></textarea>
                </div>
                
                <div class="print-actions">
                    <button type="button" class="print-action-btn cancel-btn" onclick="hideRetireLotPopup()">Cancel</button>
                    <button type="submit" class="print-action-btn delete-confirm-btn">Retire Lot</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Record Stock Seed Popup -->
    <div class="print-popup-overlay" id="stockSeedPopup">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title" id="stockSeedTitle">Record Stock Seed</h3>
                <button class="print-popup-close" onclick="hideStockSeedPopup()">×</button>
            </div>
            
            <form id="stockSeedForm" onsubmit="submitStockSeed(event)">
                <div class="form-group">
                    <label>Quantity:</label>
                    <input type="text" id="stockSeedQtyInput" placeholder="e.g. 5 lbs, 200g, etc." required>
                </div>
                <div class="form-group">
                    <label>Notes:</label>
                    <textarea id="stockSeedNotesInput" rows="5" placeholder="Enter stock seed notes..."></textarea>
                </div>
                
                <div class="print-actions">
                    <button type="button" class="print-action-btn cancel-btn" onclick="hideStockSeedPopup()">Cancel</button>
                    <button type="submit" class="print-action-btn print-btn">Record Stock Seed</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Reprint Stock Seed Label Popup -->
    <div class="print-popup-overlay" id="reprintStockSeedPopup">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Stock Seed Already Recorded</h3>
                <button class="print-popup-close" onclick="hideReprintStockSeedPopup()">×</button>
            </div>
            
            <p style="text-align: center; margin-bottom: 25px; color: #333;">
                Stock seed has already been recorded for this lot.<br>
                <strong>Would you like to reprint the stock seed label?</strong>
            </p>
            
            <div class="print-actions">
                <button class="print-action-btn cancel-btn" onclick="hideReprintStockSeedPopup()">Cancel</button>
                <button class="print-action-btn print-btn" onclick="reprintStockSeedLabel()">Reprint Label</button>
            </div>
        </div>
    </div>

    <!-- Record Germination Popup -->
    <div class="print-popup-overlay" id="germinationPopup">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title" id="germinationTitle">Record Germination</h3>
                <button class="print-popup-close" onclick="hideGerminationPopup()">×</button>
            </div>
            
            <form id="germinationForm" onsubmit="submitGermination(event)">
                <div class="form-group">
                    <label>Germination Rate (%):</label>
                    <input type="number" id="germinationRateInput" min="0" max="100" required>
                </div>
                <div class="form-group">
                    <label>Test Date:</label>
                    <input type="date" id="germinationDateInput">
                </div>
                <div class="form-group">
                    <label>Notes:</label>
                    <textarea id="germinationNotesInput" rows="4" placeholder="Enter germination test notes..."></textarea>
                </div>
                
                <div class="print-actions">
                    <button type="button" class="print-action-btn cancel-btn" onclick="hideGerminationPopup()">Cancel</button>
                    <button type="submit" class="print-action-btn print-btn">Record Germination</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Record Inventory Popup -->
    <div class="print-popup-overlay" id="inventoryPopup">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title" id="inventoryTitle">Record Inventory</h3>
                <button class="print-popup-close" onclick="hideInventoryPopup()">×</button>
            </div>
            
            <form id="inventoryForm" onsubmit="submitInventory(event)">
                <div class="form-group">
                    <label>Weight (lbs):</label>
                    <input type="number" id="inventoryWeightInput" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Inventory Date:</label>
                    <input type="date" id="inventoryDateInput">
                </div>
                <div class="form-group">
                    <label>Notes:</label>
                    <textarea id="inventoryNotesInput" rows="4" placeholder="Enter inventory notes..."></textarea>
                </div>
                
                <div class="print-actions">
                    <button type="button" class="print-action-btn cancel-btn" onclick="hideInventoryPopup()">Cancel</button>
                    <button type="submit" class="print-action-btn print-btn">Record Inventory</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Overwrite Inventory Popup -->
    <div class="print-popup-overlay" id="addOverwriteInventoryPopup">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Recent Inventory Exists</h3>
                <button class="print-popup-close" onclick="hideAddOverwriteInventoryPopup()">×</button>
            </div>
            
            <p style="text-align: center; margin-bottom: 20px;">
                Last inventory: <strong id="lastInventoryDisplay"></strong><br>
                Would you like to add to it or overwrite it?
            </p>
            
            <form id="addOverwriteInventoryForm" onsubmit="submitAddOverwriteInventory(event)">
                <div class="form-group">
                    <label>Weight (lbs):</label>
                    <input type="number" id="addOverwriteWeightInput" step="0.01" min="0" required>
                </div>
                
                <div class="print-actions" style="display: flex; gap: 8px;">
                    <button type="button" class="print-action-btn cancel-btn" onclick="hideAddOverwriteInventoryPopup()">Cancel</button>
                    <button type="submit" name="action" value="add" class="print-action-btn print-btn" style="flex: 1;">Add to Existing</button>
                    <button type="submit" name="action" value="overwrite" class="print-action-btn print-btn" style="flex: 1; background: #ff9800;">Overwrite</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Lot History Popup -->
    <div class="modal-overlay" id="lotHistoryPopup">
        <div class="modal lot-history-modal">
            <button class="close-modal" onclick="hideLotHistoryPopup()">&times;</button>
            
            <div class="lot-history-content">
                <!-- Basic Info Section -->
                <div class="history-section">
                    <div class="history-section-header">
                        <h3>Lot Information</h3>
                    </div>
                    <div class="history-section-content">
                        <div class="info-row">
                            <span class="info-label">Variety:</span>
                            <span class="info-value" id="historyVarietyName">--</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Lot ID:</span>
                            <span class="info-value" id="historySkuDisplay">--</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Low Inventory:</span>
                            <span class="info-value lot-status-indicator" id="historyLowInventory">--</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Retired:</span>
                            <span class="info-value lot-status-indicator" id="historyRetiredStatus">--</span>
                        </div>
                        <div id="retiredDetailsSection" style="display: none;">
                            <div class="info-row">
                                <span class="info-label">Retired Date:</span>
                                <span class="info-value" id="historyRetiredDate">--</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Lbs Remaining:</span>
                                <span class="info-value" id="historyRetiredLbs">--</span>
                            </div>
                            <div class="info-row" id="retiredNotesRow" style="display: none;">
                                <span class="info-label">Retirement Notes:</span>
                                <span class="info-value" id="historyRetiredNotes">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stock Seed Section -->
                <div class="history-section" id="stockSeedSection">
                    <div class="history-section-header">
                        <h3>Stock Seed Records</h3>
                    </div>
                    <div class="history-section-content">
                        <div id="stockSeedContent">
                            <div class="no-records">No stock seed records found</div>
                        </div>
                    </div>
                </div>

                <!-- Inventory Section -->
                <div class="history-section" id="inventorySection">
                    <div class="history-section-header">
                        <h3>Inventory Records</h3>
                    </div>
                    <div class="history-section-content">
                        <div id="inventoryContent">
                            <div class="no-records">No inventory records found</div>
                        </div>
                    </div>
                </div>

                <!-- Germination Section -->
                <div class="history-section" id="germinationSection">
                    <div class="history-section-header">
                        <h3>Germination Records</h3>
                    </div>
                    <div class="history-section-content">
                        <div id="germinationContent">
                            <div class="no-records">No germination records found</div>
                        </div>
                    </div>
                </div>

                <!-- Packing History Section -->
                <div class="history-section" id="packingHistorySection">
                    <div class="history-section-header">
                        <h3>Packing History</h3>
                    </div>
                    <div class="history-section-content">
                        <div id="packingHistoryContent">
                            <div class="no-records">No packing records found</div>
                        </div>
                    </div>
                </div>

                <!-- Notes Section -->
                <div class="history-section" id="notesSection">
                    <div class="history-section-header">
                        <h3>General Notes</h3>
                    </div>
                    <div class="history-section-content">
                        <div id="notesContent">
                            <div class="no-records">No notes found</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Popup -->
    <div class="print-popup-overlay" id="deleteConfirmPopup">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Delete Lot</h3>
                <button class="print-popup-close" onclick="hideDeleteConfirm()">×</button>
            </div>
            
            <p style="text-align: center; margin-bottom: 25px; color: #dc3545;">
                Are you sure you want to delete this lot?<br>
                <strong>This action cannot be undone.</strong>
            </p>
            
            <div class="print-actions">
                <button class="print-action-btn cancel-btn" onclick="hideDeleteConfirm()">Cancel</button>
                <button class="print-action-btn delete-confirm-btn" onclick="confirmDeleteLot()">Delete</button>
            </div>
        </div>
    </div>

    
    <!-- Edit Front Labels Popup -->
    <div class="print-popup-overlay" id="editFrontLabelsPopup">
        <div class="print-popup" style="max-width: 700px;">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Edit Front Label</h3>
                <button class="print-popup-close" onclick="hideEditFrontLabelsPopup()">×</button>
            </div>
            
            <form id="editFrontLabelsForm" onsubmit="submitEditFrontLabels(event)">
                <div class="label-edit-section">
                    <div class="form-group">
                        <label>Line 1:</label>
                        <input type="text" id="editFrontLine1" value="{% if variety %}{{ variety.desc_line1 }}{% endif %}">
                    </div>
                    <div class="form-group">
                        <label>Line 2:</label>
                        <input type="text" id="editFrontLine2" value="{% if variety %}{{ variety.desc_line2 }}{% endif %}">
                    </div>
                    <div class="form-group">
                        <label>Line 3:</label>
                        <input type="text" id="editFrontLine3" value="{% if variety %}{{ variety.desc_line3 }}{% endif %}">
                    </div>
                </div>
                
                <div class="print-actions">
                    <button type="button" class="print-action-btn cancel-btn" onclick="hideEditFrontLabelsPopup()">Cancel</button>
                    <button type="submit" class="print-action-btn print-btn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Back Labels Popup -->
    <div class="print-popup-overlay" id="editBackLabelsPopup">
        <div class="print-popup" style="max-width: 700px;">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Edit Back Label</h3>
                <button class="print-popup-close" onclick="hideEditBackLabelsPopup()">×</button>
            </div>
            
            <form id="editBackLabelsForm" onsubmit="submitEditBackLabels(event)">
                <div class="label-edit-section">
                    <div class="form-group">
                        <label>Line 1:</label>
                        <input type="text" id="editBackLine1" value="{% if variety %}{{ variety.back1 }}{% endif %}">
                    </div>
                    <div class="form-group">
                        <label>Line 2:</label>
                        <input type="text" id="editBackLine2" value="{% if variety %}{{ variety.back2 }}{% endif %}">
                    </div>
                    <div class="form-group">
                        <label>Line 3:</label>
                        <input type="text" id="editBackLine3" value="{% if variety %}{{ variety.back3 }}{% endif %}">
                    </div>
                    <div class="form-group">
                        <label>Line 4:</label>
                        <input type="text" id="editBackLine4" value="{% if variety %}{{ variety.back4 }}{% endif %}">
                    </div>
                    <div class="form-group">
                        <label>Line 5:</label>
                        <input type="text" id="editBackLine5" value="{% if variety %}{{ variety.back5 }}{% endif %}">
                    </div>
                    <div class="form-group">
                        <label>Line 6:</label>
                        <input type="text" id="editBackLine6" value="{% if variety %}{{ variety.back6 }}{% endif %}">
                    </div>
                    <div class="form-group">
                        <label>Line 7:</label>
                        <input type="text" id="editBackLine7" value="{% if variety %}{{ variety.back7 }}{% endif %}">
                    </div>
                </div>
                
                <div class="print-actions">
                    <button type="button" class="print-action-btn cancel-btn" onclick="hideEditBackLabelsPopup()">Cancel</button>
                    <button type="submit" class="print-action-btn print-btn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Change Lot Status Popup -->
    <div class="print-popup-overlay" id="changeStatusPopup">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title" id="changeStatusTitle">Change Lot Status</h3>
                <button class="print-popup-close" onclick="hideChangeStatusPopup()">×</button>
            </div>
            
            <div class="print-actions">
                <button class="print-action-btn" id="pendingStatusBtn" onclick="setLotStatus('pending')">Pending</button>
                <button class="print-action-btn" id="activeStatusBtn" onclick="setLotStatus('active')">Active</button>
            </div>
        </div>
    </div>


    <!-- Edit Variety Popup -->
    <div class="print-popup-overlay" id="editVarietyPopup">
        <div class="print-popup" style="max-width: 800px; max-height: 85vh; overflow-y: auto;">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Edit Variety Details</h3>
                <button class="print-popup-close" onclick="hideEditVarietyPopup()">×</button>
            </div>
            
            <form id="editVarietyForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    
                    <div class="form-group">
                        <label>SKU Prefix</label>
                        <input type="text" id="editSkuPrefix" value="{{ variety.sku_prefix }}" readonly>
                    </div>

                    <div class="form-group">
                        <label>Variety Name</label>
                        <input type="text" id="editVarName" value="{{ variety.var_name|default:'' }}">
                    </div>

                    <div class="form-group">
                        <label>Crop</label>
                        <select id="editCrop">
                            <option value="">Select Crop</option>
                            {% for crop in crops %}
                            <option value="{{ crop }}" {% if variety.crop|upper == crop|upper %}selected{% endif %}>{{ crop|upper }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Common Spelling</label>
                        <input type="text" id="editCommonSpelling" value="{{ variety.common_spelling|default:'' }}">
                    </div>

                    <div class="form-group">
                        <label>Common Name</label>
                        <input type="text" id="editCommonName" value="{{ variety.common_name|default:'' }}">
                    </div>

                    <div class="form-group">
                        <label>Group</label>
                        <select id="editGroup">
                            <option value="">Select Group</option>
                            {% for group in groups %}
                            <option value="{{ group }}" {% if variety.group and variety.group == group %}selected{% endif %}>{{ group }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Vegetable Type</label>
                        <select id="editVegType">
                            <option value="">Select Type</option>
                            {% for veg_type in veg_types %}
                            {% if veg_type != "Veg Type" %}
                            <option value="{{ veg_type }}" {% if variety.veg_type|upper == veg_type|upper %}selected{% endif %}>{{ veg_type|upper }}</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Species</label>
                        <input type="text" id="editSpecies" value="{{ variety.species|default:'' }}">
                    </div>

                    <div class="form-group">
                        <label>Supergroup</label>
                        <select id="editSupergroup">
                            <option value="">Select Supergroup</option>
                            {% for supergroup in supergroups %}
                            <option value="{{ supergroup }}" {% if variety.supergroup and variety.supergroup == supergroup %}selected{% endif %}>{{ supergroup }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Subtype</label>
                        <select id="editSubtype">
                            <option value="">Select Subtype</option>
                            {% for subtype in subtypes %}
                            <option value="{{ subtype }}" {% if variety.subtype and variety.subtype == subtype %}selected{% endif %}>{{ subtype }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Days to Maturity</label>
                        <input type="text" id="editDays" value="{{ variety.days|default:'' }}">
                    </div>

                    <div class="form-group">
                        <label>Stock Quantity</label>
                        <input type="text" id="editStockQty" value="{{ variety.stock_qty|default:'' }}">
                    </div>

                    <div class="form-group">
                        <label>Photo Path</label>
                        <input type="text" id="editPhotoPath" value="{{ variety.photo_path|default:'' }}">
                    </div>

                    <div class="form-group">
                        <label>Category</label>
                        <select id="editCategory">
                            <option value="">Select Category</option>
                            {% for category in categories %}
                            <option value="{{ category }}" {% if variety.category and variety.category == category %}selected{% endif %}>{{ category }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Active</label>
                        <select id="editActive">
                            <option value="true" {% if variety.active %}selected{% endif %}>True</option>
                            <option value="false" {% if not variety.active %}selected{% endif %}>False</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Wholesale</label>
                        <select id="editWholesale">
                            <option value="true" {% if variety.wholesale %}selected{% endif %}>True</option>
                            <option value="false" {% if not variety.wholesale %}selected{% endif %}>False</option>
                        </select>
                    </div>

                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Wholesale Notes</label>
                        <textarea id="editWsNotes" rows="3">{{ variety.ws_notes|default:'' }}</textarea>
                    </div>

                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Wholesale Description</label>
                        <textarea id="editWsDescription" rows="3">{{ variety.ws_description|default:'' }}</textarea>
                    </div>

                </div>

                <div class="print-actions" style="margin-top: 20px;">
                    <button type="button" class="print-action-btn cancel-btn" onclick="hideEditVarietyPopup()">Cancel</button>
                    <button type="button" class="print-action-btn print-btn" onclick="saveVarietyChanges()">Save Changes</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Add Product Popup -->
    <div id="addProductPopup" class="modal-overlay">
        <div class="modal">
            <button class="close-modal" onclick="hideAddProductPopup()">&times;</button>
            <div class="modal-header">
                <h2 class="modal-title">Add Product</h2>
            </div>

            <div id="productSuccessMessage" class="success-message" style="display: none;">
                Product created successfully! 
            </div>

            <form id="addProductForm" onsubmit="submitAddProduct(event)">
                {% csrf_token %}
                <div class="form-grid">
                    <div class="form-group">
                        <label for="product_variety">Variety</label>
                        <input type="text" id="product_variety" name="variety" value="{% if variety %}{{ variety.sku_prefix }}{% endif %}" class="field-medium" readonly>
                    </div>

                    <div class="form-group">
                        <label for="productSkuSuffix">SKU Suffix *</label>
                        <select id="productSkuSuffix" name="sku_suffix" class="field-medium" required>
                            <!-- <option value="">Select SKU suffix</option> -->
                            {% for suffix in sku_suffixes %}
                                <option value="{{ suffix }}">{{ suffix }}</option>
                            {% endfor %}
                        </select>
                        <div class="error-message" id="sku_suffix_error"></div>
                    </div>

                    <div class="form-group">
                        <label for="productPkgSize">Package Size</label>
                        <select id="productPkgSize" name="pkg_size" class="field-narrow">
                            <!-- <option value="">Package Size</option> -->
                            {% for size in pkg_sizes %}
                                <option value="{{ size }}">{{ size }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="productAltSku">Alternative SKU</label>
                        <input type="text" id="productAltSku" name="alt_sku" class="field-medium">
                    </div>

                    <div class="form-group">
                        <label for="productLineitemName">Line Item Name</label>
                        <input type="text" id="productLineitemName" name="lineitem_name" class="field-wide">
                    </div>

                    <div class="form-group">
                        <label for="productRackLocation">Rack Location</label>
                        <input type="text" id="productRackLocation" name="rack_location" class="field-medium">
                    </div>

                    <div class="form-group">
                        <label for="productEnvType">Envelope Type</label>
                        <select id="productEnvType" name="env_type" class="field-medium">
                            <!-- <option value="">Envelope Type</option> -->
                            {% for env in env_types %}
                                <option value="{{ env }}">{{ env }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="productEnvMultiplier">Envelope Multiplier</label>
                        <!-- <input type="number" id="productEnvMultiplier" name="env_multiplier"> -->
                         <input type="number" id="productEnvMultiplier" name="env_multiplier" value="1" class="field-narrow">
                    </div>

                    <div class="form-group">
                        <label for="productScoopSize">Scoop Size</label>
                        <input type="text" id="productScoopSize" name="scoop_size" class="field-medium">
                    </div>

                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="productPrintBack" name="print_back">
                        <label for="productPrintBack">Print Back</label>
                    </div>

                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="productIsSubProduct" name="is_sub_product">
                        <label for="productIsSubProduct">Is Sub Product</label>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideAddProductPopup()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Product</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Packing Record Popup -->
    <div class="print-popup-overlay" id="editPackingRecordPopup">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title" id="editPackingRecordTitle">Edit Packing Record</h3>
                <button class="print-popup-close" onclick="hideEditPackingRecordPopup()">×</button>
            </div>
            
            <form id="editPackingRecordForm" onsubmit="submitEditPackingRecord(event)">
                <div class="form-group">
                    <label>Current Quantity:</label>
                    <input type="number" id="currentPackingQty" readonly style="background: #f8f9fa; color: #666;">
                </div>
                <div class="form-group">
                    <label>Deduct Amount:</label>
                    <input type="number" id="deductPackingQty" min="1" required placeholder="Amount to deduct">
                </div>
                
                <div class="print-actions">
                    <button type="button" class="print-action-btn cancel-btn" onclick="hideEditPackingRecordPopup()">Cancel</button>
                    <button type="submit" class="print-action-btn print-btn">Submit</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Packing Record Popup -->
    <div class="print-popup-overlay" id="deletePackingRecordPopup">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Delete Packing Record</h3>
                <button class="print-popup-close" onclick="hideDeletePackingRecordPopup()">×</button>
            </div>
            
            <p style="text-align: center; margin-bottom: 25px; color: #dc3545;">
                Are you sure you want to delete this packing record?<br>
                <strong>This action cannot be undone.</strong>
            </p>
            
            <div class="print-actions">
                <button class="print-action-btn cancel-btn" onclick="hideDeletePackingRecordPopup()">Cancel</button>
                <button class="print-action-btn delete-confirm-btn" onclick="confirmDeletePackingRecord()">Yes, Delete</button>
            </div>
        </div>
    </div>

    <!-- For Year Mismatch Warning Popup -->
    <div class="print-popup-overlay" id="forYearMismatchWarning">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Cannot Print</h3>
                <button class="print-popup-close" onclick="hideForYearMismatchWarning()">×</button>
            </div>
            <p style="text-align: center; margin-bottom: 20px; color: #dc3545;">
                <strong>Year Mismatch Detected</strong><br>
                <span id="forYearMismatchMessage">The lot's year doesn't match the current printing year.</span><br>
                Please check the lot assignment.
            </p>
            <div class="print-actions">
                <button class="print-action-btn cancel-btn" onclick="hideForYearMismatchWarning()">OK</button>
            </div>
        </div>
    </div>

    <!-- Password Verification Popup -->
    <div class="print-popup-overlay" id="passwordPopup">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Password Required</h3>
                <button class="print-popup-close" onclick="hidePasswordPopup()">×</button>
            </div>
            
            <p style="text-align: center; margin-bottom: 20px; color: #333;">
                Please enter password to proceed
            </p>
            
            <form id="passwordForm" onsubmit="return false;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <input 
                        type="text" 
                        id="passwordInput" 
                        placeholder="Enter password"
                        style="padding: 10px; border: 2px solid rgba(102, 126, 234, 0.2); border-radius: 8px; width: 200px; text-align: center;"
                        autocomplete="off"
                    >
                    <div id="passwordError" style="color: #dc3545; font-size: 0.85rem; margin-top: 8px; display: none;">
                        Incorrect password
                    </div>
                </div>
                
                <div class="print-actions">
                    <button type="button" class="print-action-btn cancel-btn" onclick="hidePasswordPopup()">Cancel</button>
                    <button type="button" class="print-action-btn print-btn" onclick="verifyPassword()">Submit</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Print Back Mismatch Warning Popup -->
    <div class="print-popup-overlay" id="printBackWarning">
        <div class="print-popup">
            <div class="print-popup-header">
                <h3 class="print-popup-title">Warning</h3>
                <button class="print-popup-close" onclick="hidePrintBackWarning()">×</button>
            </div>
            <p id="printBackWarningMessage" style="text-align: center; margin-bottom: 20px; color: #333; font-size: 1rem; line-height: 1.5;">
            </p>
            <div class="print-actions">
                <button class="print-action-btn cancel-btn" onclick="hidePrintBackWarning()">Cancel</button>
                <button class="print-action-btn print-btn" onclick="continuePrintDespiteBackMismatch()">Yes, Continue</button>
            </div>
        </div>
    </div>

    <script>
        // Django-rendered data
        const VARIETY_SKU_PREFIX = '{{ variety.sku_prefix }}';
        const varietyDataString = '{{ all_vars_json|escapejs }}';
        const packedForYear = '{{ packed_for_year }}';
        const isTransition = JSON.parse('{{ transition|yesno:"true,false"|lower }}');
        const lotsExtraData = JSON.parse('{{ lots_extra_data|escapejs }}');
        const lotsDataString = '{{ lots_json|escapejs }}';
    </script>

    <script src="{% static 'office/js/view_variety.js' %}"></script>
    
</body>
</html>