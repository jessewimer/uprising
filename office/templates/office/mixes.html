{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Mixes - Uprising Seeds</title>
    <link rel="stylesheet" href="{% static 'office/css/base.css' %}">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: fadeInUp 0.4s ease-out;
        }

        .dashboard-button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .dashboard-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .header-title {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            flex: 1;
            text-align: center;
        }

        .mix-selector {
            padding: 12px 20px;
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            background: white;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 250px;
        }

        .mix-selector optgroup {
            font-weight: 700;
            font-style: normal;
            color: #333;
            background: #f8f9fa;
        }

        .mix-selector option {
            padding-left: 10px;
            font-weight: 400;
        }

        .mix-selector:hover {
            border-color: #667eea;
        }

        .mix-selector:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Main Content */
        .content {
            display: flex;
            gap: 30px;
            animation: fadeInUp 0.6s ease-out;
        }

        .empty-state {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 60px 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 100%;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state-text {
            color: #666;
            font-size: 1.2rem;
        }

        /* Left Panel - Mix Lots List */
        .left-panel {
            flex: 0 0 420px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.2);
        }

        .panel-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
        }

        .add-button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #26de81, #20bf6b);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .add-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(38, 222, 129, 0.3);
        }

        .mix-lots-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .mix-lot-item {
            padding: 20px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mix-lot-item:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.15);
        }

        .mix-lot-item.active {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .lot-code {
            font-size: 1.2rem;
            font-weight: 700;
            color: #667eea;
            text-align: center;
        }

        .lot-info {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.6;
        }

        /* Right Panel - Details */
        .right-panel {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .details-empty {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .details-empty-icon {
            font-size: 3rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .lot-details {
            display: none;
        }

        .lot-details.show {
            display: block;
        }

        .details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.2);
        }

        .detail-lot-code {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .action-button {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .action-button.primary {
            background: linear-gradient(135deg, #26de81, #20bf6b);
            color: white;
        }

        .action-button.danger {
            background: linear-gradient(135deg, #ee5a6f, #f29263);
            color: white;
        }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        /* Info Grid */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e9ecef;
        }

        .info-label {
            font-size: 0.85rem;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .info-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }

        /* Tables */
        .section {
            margin-bottom: 40px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.2);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
            margin: 0;
        }
        /* .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        } */

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        thead {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        thead th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: white;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tbody tr {
            border-bottom: 1px solid #e9ecef;
        }

        tbody tr:last-child {
            border-bottom: none;
        }

        tbody tr:hover {
            background: #f8f9ff;
        }

        tbody td {
            padding: 15px;
            color: #333;
        }

        .batch-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .batch-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .batch-date {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
        }

        .batch-weight {
            font-size: 1.2rem;
            font-weight: 700;
            color: #667eea;
        }

        .batch-notes {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* Modals */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: transparent;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #999;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            color: #333;
            transform: scale(1.1);
        }

        .modal-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 30px;
            color: #333;
        }

        /* Form */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Recipe section styles */
        .recipe-section {
            background: #f8f9ff;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid rgba(102, 126, 234, 0.1);
        }

        .recipe-title {
            font-size: 1rem;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
        }

        .recipe-parts-section {
            margin-bottom: 8px;
        }

        .recipe-parts-section:last-child {
            margin-bottom: 0;
        }

        .recipe-parts-label {
            font-weight: 600;
            color: #555;
            display: inline;
        }

        .recipe-content {
            color: #666;
            display: inline;
        }

        .parts-input {
            width: 60px;
            padding: 6px 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
        }

        .parts-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .parts-input:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #26de81, #20bf6b);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(38, 222, 129, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #495057;
            border: 2px solid #dee2e6;
        }

        .btn-secondary:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        /* Hidden state */
        .hidden {
            display: none;
        }


        /* Disabled row styling for lots without germ */
        .disabled-row {
            opacity: 0.5;
            background: #f5f5f5;
        }

        .disabled-row:hover {
            background: #f5f5f5 !important;
        }

        /* Sticky table header styling */
        thead {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        thead th {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        /* Parts input in table */
        td .parts-input {
            width: 60px;
            padding: 6px 8px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
        }

        td .parts-input:focus {
            outline: none;
            border-color: #667eea;
        }

        td .parts-input:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
        }
        /* Message System */
        .messages-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            animation: slideInRight 0.3s ease-out;
        }

        .message-success {
            border-left: 4px solid #10b981;
        }

        .message-error {
            border-left: 4px solid #ef4444;
        }

        .message-text {
            flex: 1;
            font-size: 0.95rem;
            color: #333;
        }

        .message-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body data-current-year="{{ current_order_year }}">
    <div class="container">
        <!-- Header -->
        <div class="header">
            <a href="{% url 'office_landing' %}" class="dashboard-button">
                ‚Üê Dashboard
            </a>
            <h1 class="header-title">Mix Management</h1>
            <select id="mixSelector" class="mix-selector" onchange="handleMixChange(this.value)">
                <option value="">Select a Mix...</option>
                <optgroup label="Final Mixes">
                    {% for sku, config in final_mixes.items %}
                        <option value="{{ sku }}">{{ config.name }}</option>
                    {% endfor %}
                </optgroup>
                <optgroup label="Base Component Mixes">
                    {% for sku, config in base_mixes.items %}
                        <option value="{{ sku }}">{{ config.name }}</option>
                    {% endfor %}
                </optgroup>
            </select>
        </div>

        <!-- Main Content -->
        <div class="content">
            <!-- Empty State (shown when no mix selected) -->
            <div id="emptyState" class="empty-state">
                <div class="empty-state-icon">üå±</div>
                <p class="empty-state-text">Select a mix from the dropdown to get started</p>
            </div>

            <!-- Left Panel - Mix Lots List -->
            <div id="leftPanel" class="left-panel" style="display: none;">
                <div class="panel-header">
                    <h3 class="panel-title" id="mixLotsTitle">Mix Lots</h3>
                    <button class="add-button" onclick="showAddMixLotModal()">+ Add Lot</button>
                </div>
                <div id="mixLotsList" class="mix-lots-list">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Right Panel - Details -->
            <div id="rightPanel" class="right-panel" style="display: none;">
                <div id="detailsEmpty" class="details-empty">
                    <div class="details-empty-icon">üìã</div>
                    <p>Select a mix lot to view details</p>
                </div>

                <div id="detailsContent" class="hidden">
                    <!-- <div class="lot-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <h2 id="detailLotCode">--</h2>
                            <div class="lot-meta">
                                Germ: <span id="detailGerm">--</span>
                            </div>
                        </div>
                        <button id="retireMixLotButton" class="add-button" style="background: #dc3545; margin: 0;" onclick="showRetireMixLotModal()">
                            Retire
                        </button>
                    </div> -->
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid rgba(102, 126, 234, 0.2);">
                        <div>
                            <h2 id="detailLotCode" style="font-size: 2rem; font-weight: 700; color: #667eea; margin-bottom: 8px;">--</h2>
                            <div style="font-size: 1.1rem; color: #666;">
                                Germ: <span id="detailGerm" style="font-weight: 600;">--</span>
                                <span style="margin: 0 10px; color: #ccc;">|</span>
                                Created: <span id="detailCreated" style="font-weight: 600;">--</span>
                            </div>
                        </div>
                        <button id="retireMixLotButton" class="add-button" style="background: #dc3545; margin: 0;" onclick="showRetireMixLotModal()">
                            Retire
                        </button>
                    </div>

                    <!-- Components Section -->
                    <div class="section">
                        <div class="section-header">
                            <h3 class="section-title">Components</h3>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Variety</th>
                                    <th>Lot Code</th>
                                    <th>Germ %</th>
                                    <th>Parts</th>
                                </tr>
                            </thead>
                            <tbody id="componentsTableBody">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Batches Section -->
                    <div class="section">
                        <div class="section-header">
                            <h3 class="section-title">Batches</h3>
                            <button id="addBatchButton" class="add-button" onclick="showAddBatchModal()">
                                + Add Batch
                            </button>
                        </div>
                        <div class="batches-list" id="batchesList">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Mix Lot Modal -->
    <div class="modal-overlay" id="addMixLotModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeAddMixLotModal()">&times;</button>
            <h2 class="modal-title">
                <span style="color: #333;">Create New Mix Lot:</span>
                <span id="newLotCode" style="color: #667eea;"><!-- Will be populated by JavaScript --></span>
            </h2>

            <div class="form-group" id="recipeSection" style="display:none;">
                <!-- Recipe will be populated by JavaScript -->
            </div>

            <div class="form-group">
                <label class="form-label">Select Component Lots</label>
                <div style="max-height: 400px; overflow-y: auto; border: 2px solid #e9ecef; border-radius: 8px;">
                    <table class="data-table" style="margin: 0;">
                        <thead style="position: sticky; top: 0; z-index: 10;">
                            <tr>
                                <th style="width: 60px;">Select</th>
                                <th>Variety</th>
                                <th>Lot</th>
                                <th style="width: 80px;">Germ %</th>
                                <th style="width: 100px;">Inventory</th>
                                <th style="width: 80px;">Parts</th>
                            </tr>
                        </thead>
                        <tbody id="availableLotsTableBody">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Calculated Germination Rate</label>
                <input type="text" class="form-input" id="calcGerm" disabled>
            </div>

            <div class="modal-actions">
                <button class="btn btn-primary" onclick="saveMixLot()">üíæ Save Mix Lot</button>
                <button class="btn btn-secondary" onclick="closeAddMixLotModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Add Batch Modal -->
    <div class="modal-overlay" id="addBatchModal">
        <div class="modal-content" style="max-width: 600px;">
            <button class="modal-close" onclick="closeAddBatchModal()">&times;</button>
            <h2 class="modal-title">Record New Batch</h2>

            <div class="form-group">
                <label class="form-label">Date</label>
                <input type="date" class="form-input" id="batchDate">
            </div>

            <div class="form-group">
                <label class="form-label">Final Weight (lbs)</label>
                <input type="number" step="0.01" class="form-input" id="batchWeight" placeholder="0.00">
            </div>

            <div class="form-group">
                <label class="form-label">Notes (measurement spoon, etc.)</label>
                <textarea class="form-input" id="batchNotes" rows="3"></textarea>
            </div>

            <div class="modal-actions">
                <button class="btn btn-primary" onclick="saveBatch()">üíæ Save Batch</button>
                <button class="btn btn-secondary" onclick="closeAddBatchModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Retire Mix Lot Confirmation Modal -->
    <div class="modal-overlay" id="retireMixLotModal">
        <div class="modal-content" style="max-width: 500px;">
            <button class="modal-close" onclick="closeRetireMixLotModal()">&times;</button>
            <h2 class="modal-title" style="color: #dc3545;">Retire Mix Lot</h2>
            
            <div style="text-align: center; padding: 20px 0; color: #666;">
                <div style="font-size: 3rem; margin-bottom: 15px;">‚ö†Ô∏è</div>
                <p style="font-size: 1.1rem; margin-bottom: 10px;">
                    Are you sure you want to retire <strong id="retireLotCodeDisplay">this lot</strong>?
                </p>
                <p style="font-size: 0.95rem; color: #999;">
                    This action will mark the lot as retired and prevent new batches from being added.
                </p>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeRetireMixLotModal()">Cancel</button>
                <button class="btn btn-primary" style="background: linear-gradient(135deg, #dc3545, #b91c1c);" onclick="confirmRetireMixLot()">Yes, Retire Lot</button>
            </div>
        </div>
    </div>


    <script>
        const CURRENT_ORDER_YEAR = parseInt(document.body.dataset.currentYear);
        let currentMixSku = null;
        let currentMixLotId = null;
        let currentMixName = null;

        // CSRF token helper - read from meta tag
        function getCSRFToken() {
            return document.querySelector('meta[name="csrf-token"]')?.content || '';
        }

        // Recipe configurations
        const MIX_RECIPES = {
            'CAR-RA': {
                '1 part each': ['Yellowstone', 'Scarlet Nantes', 'Purple Dragon']
            },
            'BEE-3B': {
                '1 part each': ['Touchstone Gold', 'Shiraz', 'Chioggia']
            },
            'LET-MX': {
                '1 part each': ['Any combination of available lettuces']
            },
            'MIX-SP': {
                '1 part each': ['Lettuce Mix', 'Spicy Mix']
            },
            'MIX-MI': {
                '1 part each': ['Lettuce Mix', 'Mild Mix']
            },
            'MIX-LB': {
                '1 part each': ['Available lettuces']
            },
            'MIX-SB': {
                '2 parts each': ['Astro', 'Wrinkled Crinkled', 'Rainbow'],
                '1 part each': ['Tatsoi', 'Ruby Streaks', 'Russian Frills/Red Russian', 'Golden Frills', 'Early Mizuna']
            },
            'MIX-MB': {
                '2 parts each': ['Beaujolais', 'Rainbow'],
                '1 part each': ['Astro', 'Tatsoi', 'Russian Frills', 'Early Mizuna']
            },
            'FLO-ED': {
                '1 part each': ['Florist Blue boy', 'Black Ball'],
                '3 parts': ['Calendula Mix', 'Borage'],
                '5 parts': ['Trailing Mix']
            }
        };

        function getRecipeHTML(mixSku) {
            const recipe = MIX_RECIPES[mixSku];
            if (!recipe) return '';
            
            let html = '<div class="recipe-title">Recipe:</div>';
            
            for (const [partsLabel, ingredients] of Object.entries(recipe)) {
                html += `
                    <div class="recipe-parts-section">
                        <span class="recipe-parts-label">${partsLabel}:</span>
                        <span class="recipe-content"> ${ingredients.join(', ')}</span>
                    </div>
                `;
            }
            
            return html;
        }

        // Mix validation rules
        const MIX_VALIDATION_RULES = {
            'CAR-RA': {
                type: 'exact_varieties',
                required: ['CAR-YE', 'CAR-SN', 'CAR-DR'],
                message: 'Rainbow Carrot Mix requires exactly 1 each of: Yellow Carrot (CAR-YE), Scarlet Nantes (CAR-SN), and Purple Dragon (CAR-DR)'
            },
            'MIX-SP': {
                type: 'category_count',
                required: { 'lettuce': 1, 'spicy': 1 },
                message: 'Uprising Spicy Mix requires exactly 1 Lettuce Mix lot and 1 Spicy Mix lot'
            },
            'BEE-3B': {
                type: 'exact_varieties',
                required: ['BEE-TG', 'BEE-SH', 'BEE-CH'],
                message: '3 Beet Mix requires exactly 1 each of: Touchstone Gold (BEE-TG), Shiraz (BEE-SH), and Chioggia (BEE-CH)'
            },
            'MIX-MI': {
                type: 'category_count',
                required: { 'lettuce': 1, 'mild': 1 },
                message: 'Uprising Mild Mix requires exactly 1 Lettuce Mix lot and 1 Mild Mix lot'
            }
        };

        const VARIETY_CATEGORIES = {
            'MIX-LB': 'lettuce',
            'MIX-SB': 'spicy',
            'MIX-MB': 'mild'
        };

        function handleMixChange(mixSku) {
            if (!mixSku) {
                showEmptyState();
                return;
            }
            
            currentMixSku = mixSku;
            currentMixLotId = null;  // ADD THIS LINE - Clear the current lot ID
            const selector = document.getElementById('mixSelector');
            currentMixName = selector.options[selector.selectedIndex].text;
            
            // ADD THESE LINES - Clear the right panel
            document.getElementById('detailsEmpty').style.display = 'block';
            document.getElementById('detailsContent').classList.add('hidden');
            
            loadMixLotsList(mixSku);
        }

        function showEmptyState() {
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('leftPanel').style.display = 'none';
            document.getElementById('rightPanel').style.display = 'none';
            currentMixSku = null;
            currentMixLotId = null;
        }

        function loadMixLotsList(mixSku) {
            fetch(`/office/mixes/existing-lots/?mix=${mixSku}`)
                .then(response => response.json())
                .then(mixLots => {
                    document.getElementById('emptyState').style.display = 'none';
                    document.getElementById('leftPanel').style.display = 'block';
                    document.getElementById('rightPanel').style.display = 'block';
                    
                    document.getElementById('mixLotsTitle').textContent = currentMixName;
                    
                    const listContainer = document.getElementById('mixLotsList');
                    listContainer.innerHTML = '';
                    
                    if (mixLots.length === 0) {
                        listContainer.innerHTML = '<p style="text-align: center; color: #999;">No lots created yet</p>';
                        return;
                    }
                    
                    mixLots.forEach(lot => {
                        const lotItem = document.createElement('div');
                        lotItem.className = 'mix-lot-item';
                        lotItem.onclick = () => loadMixLotDetails(lot.id);
                        
                        lotItem.innerHTML = `
                            <div class="lot-code">${lot.lot_code}</div>
                            <div class="lot-info" style="margin-top: 12px; text-align: center;">
                                ${lot.is_retired ? '<span style="color: #dc3545; font-weight: 600;">Retired</span>' : '<span style="color: #26de81; font-weight: 600;">Active</span>'}
                            </div>
                        `;
                        
                        listContainer.appendChild(lotItem);
                    });
                })
                .catch(error => {
                    console.error('Error loading mix lots:', error);
                    showMessage('Error loading mix lots', 'error');
                });
        }

        function loadMixLotDetails(mixLotId) {
            currentMixLotId = mixLotId;
            
            // Update active state only if called from a click event
            document.querySelectorAll('.mix-lot-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Find and mark the clicked item as active
            const clickedItem = document.querySelector(`.mix-lot-item[onclick*="${mixLotId}"]`);
            if (clickedItem) {
                clickedItem.classList.add('active');
            }
            
            fetch(`/office/mixes/lot-details/${mixLotId}/`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('detailsEmpty').style.display = 'none';
                    document.getElementById('detailsContent').classList.remove('hidden');
                    
                    document.getElementById('detailLotCode').textContent = data.lot_code;
                    document.getElementById('detailGerm').textContent = `${data.germ_rate}%`;
                    document.getElementById('detailCreated').textContent = data.created_date;
                    
                    // Components
                    const componentsBody = document.getElementById('componentsTableBody');
                    componentsBody.innerHTML = '';
                    data.components.forEach(comp => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${comp.variety_name}</td>
                            <td>${comp.lot_code}</td>
                            <td>${comp.germ_rate}%</td>
                            <td>${comp.parts}</td>
                        `;
                        componentsBody.appendChild(tr);
                    });
                    
                    // Batches
                    const batchesList = document.getElementById('batchesList');
                    batchesList.innerHTML = '';
                    if (data.batches.length === 0) {
                        batchesList.innerHTML = '<p style="text-align: center; color: #999;">No batches recorded yet</p>';
                    } else {
                        data.batches.forEach(batch => {
                            const batchCard = document.createElement('div');
                            batchCard.className = 'batch-card';
                            batchCard.innerHTML = `
                                <div class="batch-header">
                                    <div class="batch-date">${batch.date}</div>
                                    <div class="batch-weight">${batch.final_weight} lbs</div>
                                </div>
                                ${batch.notes ? `<div class="batch-notes">${batch.notes}</div>` : ''}
                            `;
                            batchesList.appendChild(batchCard);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading lot details:', error);
                    showMessage('Error loading lot details', 'error');
                });
        }

        function showAddMixLotModal() {
            if (!currentMixSku) {
                showMessage('Please select a mix first', 'error');
                return;
            }
            
            // Check if there's already an active lot for this mix
            fetch(`/office/mixes/existing-lots/?mix=${currentMixSku}`)
                .then(response => response.json())
                .then(mixLots => {
                    const hasActiveLot = mixLots.some(lot => !lot.is_retired);
                    
                    if (hasActiveLot) {
                        showMessage('Cannot add a new lot - there is already an active lot for this mix. Retire the active lot first.', 'error');
                        return;
                    }
                    
                    // Generate lot code
                    fetch(`/office/mixes/generate-lot-code/?mix=${currentMixSku}`)
                        .then(response => response.json())
                        .then(data => {
                            // Set lot code in the header
                            document.getElementById('newLotCode').textContent = data.lot_code;
                            
                            // Set recipe section
                            const recipeHTML = getRecipeHTML(currentMixSku);
                            const recipeSection = document.getElementById('recipeSection');
                            if (recipeHTML) {
                                recipeSection.innerHTML = recipeHTML;
                                recipeSection.style.display = 'block';
                            } else {
                                recipeSection.style.display = 'none';
                            }
                            
                            // Load available lots
                            loadAvailableLotsForMix(currentMixSku);
                            
                            // Show modal
                            document.getElementById('addMixLotModal').classList.add('show');
                        });
                })
                .catch(error => {
                    console.error('Error checking for active lots:', error);
                    showMessage('Error checking for active lots', 'error');
                });
        }

        function loadAvailableLotsForMix(mixSku) {
            fetch(`/office/mixes/available-lots/?mix=${mixSku}&year={{ current_order_year }}`)
                .then(response => response.json())
                .then(lots => {
                    const tbody = document.getElementById('availableLotsTableBody');
                    
                    if (lots.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999; padding: 20px;">No available lots found</td></tr>';
                        return;
                    }
                    
                    // Sort lots by variety name, then by lot code
                    lots.sort((a, b) => {
                        if (a.variety_name !== b.variety_name) {
                            return a.variety_name.localeCompare(b.variety_name);
                        }
                        return a.full_lot_code.localeCompare(b.full_lot_code);
                    });
                    
                    // Build table rows
                    let html = '';
                    lots.forEach(lot => {
                        const hasGerm = lot.germ_rate && lot.germ_rate > 0;
                        const disabledAttr = hasGerm ? '' : 'disabled';
                        const rowClass = hasGerm ? '' : 'class="disabled-row"';
                        
                        html += `
                            <tr ${rowClass} style="cursor: ${hasGerm ? 'pointer' : 'not-allowed'};" onclick="toggleRowCheckbox(event, ${lot.id})">
                                <td style="text-align: center;">
                                    <input type="checkbox" 
                                        class="lot-checkbox" 
                                        id="checkbox-${lot.id}"
                                        data-lot-id="${lot.id}" 
                                        data-lot-code="${lot.full_lot_code}"
                                        data-germ-rate="${lot.germ_rate || 0}"
                                        data-is-mix="${lot.is_mix || false}"
                                        data-variety-sku="${lot.variety_sku}"
                                        ${disabledAttr}
                                        onchange="updateSelectedLots()">
                                </td>
                                <td>${lot.variety_name}</td>
                                <td><strong>${lot.full_lot_code}</strong></td>
                                <td>${lot.germ_rate || 'N/A'}%</td>
                                <td>${lot.inventory}</td>
                                <td onclick="event.stopPropagation();">
                                    <input type="number" 
                                        class="parts-input" 
                                        data-lot-id="${lot.id}" 
                                        value="1" 
                                        min="1"
                                        onchange="updateSelectedLots()"
                                        ${disabledAttr}>
                                </td>
                            </tr>
                        `;
                    });
                    
                    tbody.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error loading lots:', error);
                    showMessage('Error loading available lots', 'error');
                });
        }

        function toggleRowCheckbox(event, lotId) {
            // Don't toggle if clicking on the checkbox itself or the parts input
            if (event.target.type === 'checkbox' || event.target.type === 'number') {
                return;
            }
            
            const checkbox = document.getElementById(`checkbox-${lotId}`);
            if (checkbox && !checkbox.disabled) {
                checkbox.checked = !checkbox.checked;
                updateSelectedLots();
            }
        }

        function updateSelectedLots() {
            updateGermCalculation();
        }

        function updateGermCalculation() {
            const checkboxes = document.querySelectorAll('.lot-checkbox:checked');
            
            if (checkboxes.length === 0) {
                document.getElementById('calcGerm').value = '';
                return;
            }

            let totalParts = 0;
            let weightedGerm = 0;

            checkboxes.forEach(cb => {
                const lotId = cb.dataset.lotId;
                const germ = parseFloat(cb.dataset.germRate);
                const partsInput = document.querySelector(`.parts-input[data-lot-id="${lotId}"]`);
                const parts = parseInt(partsInput.value) || 1;

                totalParts += parts;
                weightedGerm += (germ * parts);
            });

            const avgGerm = Math.round(weightedGerm / totalParts);
            document.getElementById('calcGerm').value = `${avgGerm}%`;
        }

        function validateMixComponents() {
            const rules = MIX_VALIDATION_RULES[currentMixSku];
            
            // If no rules defined for this mix, allow it
            if (!rules) {
                return { valid: true };
            }
            
            const checkboxes = document.querySelectorAll('.lot-checkbox:checked');
            const selectedVarieties = [];
            
            checkboxes.forEach(cb => {
                const varietySku = cb.dataset.varietySku;
                selectedVarieties.push(varietySku);
            });
            
            if (rules.type === 'exact_varieties') {
                // Check if we have exactly the required varieties
                const required = rules.required;
                
                if (selectedVarieties.length !== required.length) {
                    return { valid: false, message: rules.message };
                }
                
                // Check each required variety is present exactly once
                for (const reqVariety of required) {
                    const count = selectedVarieties.filter(v => v === reqVariety).length;
                    if (count !== 1) {
                        return { valid: false, message: rules.message };
                    }
                }
                
                return { valid: true };
            }
            
            if (rules.type === 'category_count') {
                // Count varieties by category
                const categoryCounts = {};
                
                selectedVarieties.forEach(sku => {
                    const category = VARIETY_CATEGORIES[sku];
                    if (category) {
                        categoryCounts[category] = (categoryCounts[category] || 0) + 1;
                    }
                });
                
                // Check if counts match requirements
                for (const [category, requiredCount] of Object.entries(rules.required)) {
                    const actualCount = categoryCounts[category] || 0;
                    if (actualCount !== requiredCount) {
                        return { valid: false, message: rules.message };
                    }
                }
                
                return { valid: true };
            }
            
            return { valid: true };
        }

        function saveMixLot() {
            const lotCode = document.getElementById('newLotCode').textContent.trim();
            const checkboxes = document.querySelectorAll('.lot-checkbox:checked');
            
            if (!lotCode) {
                showMessage('Lot code is missing', 'error');
                return;
            }

            if (checkboxes.length === 0) {
                showMessage('Please select at least one component lot', 'error');
                return;
            }

            // Validate mix components
            const validation = validateMixComponents();
            if (!validation.valid) {
                showMessage(validation.message, 'error');
                return;
            }

            const components = [];
            checkboxes.forEach(cb => {
                const lotId = cb.dataset.lotId;
                const partsInput = document.querySelector(`.parts-input[data-lot-id="${lotId}"]`);
                components.push({
                    lot_id: parseInt(lotId),
                    parts: parseInt(partsInput.value) || 1
                });
            });

            fetch(`/office/mixes/create-lot/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({
                    mix_sku: currentMixSku,
                    lot_code: lotCode,
                    components: components
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(`Mix lot ${data.lot_code} created successfully!`, 'success');
                    closeAddMixLotModal();
                    loadMixLotsList(currentMixSku);
                } else {
                    showMessage('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error creating mix lot:', error);
                showMessage('Error creating mix lot', 'error');
            });
        }

        function closeAddMixLotModal() {
            document.getElementById('addMixLotModal').classList.remove('show');
            document.getElementById('newLotCode').textContent = '';
            document.getElementById('calcGerm').value = '';
            document.querySelectorAll('.lot-checkbox').forEach(cb => cb.checked = false);
        }


        function showAddBatchModal() {
            if (!currentMixLotId) {
                showMessage('Please select a mix lot first', 'error');
                return;
            }
            
            // Check if lot is retired
            fetch(`/office/mixes/lot-details/${currentMixLotId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.is_retired) {
                        showMessage('Cannot add batch to a retired lot', 'error');
                        return;
                    }
                    
                    document.getElementById('batchDate').valueAsDate = new Date();
                    document.getElementById('addBatchModal').classList.add('show');
                })
                .catch(error => {
                    console.error('Error checking lot status:', error);
                    showMessage('Error checking lot status', 'error');
                });
        }
        // function showAddBatchModal() {
        //     if (!currentMixLotId) {
        //         showMessage('Please select a mix lot first', 'error');
        //         return;
        //     }
            
        //     document.getElementById('batchDate').valueAsDate = new Date();
        //     document.getElementById('addBatchModal').classList.add('show');
        // }

        function saveBatch() {
            const date = document.getElementById('batchDate').value;
            const weight = document.getElementById('batchWeight').value;
            const notes = document.getElementById('batchNotes').value;

            if (!date || !weight) {
                showMessage('Please fill in date and weight', 'error');
                return;
            }

            fetch(`/office/mixes/create-batch/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({
                    mix_lot_id: currentMixLotId,
                    date: date,
                    final_weight: weight,
                    notes: notes
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('Batch recorded successfully!', 'success');
                    closeAddBatchModal();
                    loadMixLotDetails(currentMixLotId);
                } else {
                    showMessage('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error recording batch:', error);
                showMessage('Error recording batch', 'error');
            });
        }

        function closeAddBatchModal() {
            document.getElementById('addBatchModal').classList.remove('show');
            document.getElementById('batchWeight').value = '';
            document.getElementById('batchNotes').value = '';
        }

        // Close modals on escape
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeAddMixLotModal();
                closeAddBatchModal();
            }
        });

        // Close modals on outside click
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', function(event) {
                if (event.target === this) {
                    closeAddMixLotModal();
                    closeAddBatchModal();
                }
            });
        });

        function showMessage(text, type = 'success') {
            let container = document.querySelector('.messages-container');
            if (!container) {
                container = document.createElement('div');
                container.className = 'messages-container';
                document.body.appendChild(container);
            }
            
            const message = document.createElement('div');
            message.className = `message message-${type}`;
            message.innerHTML = `
                <span class="message-text">${text}</span>
                <button class="message-close" onclick="this.parentElement.remove()">√ó</button>
            `;
            
            container.appendChild(message);
            
            setTimeout(() => {
                if (message.parentElement) {
                    message.style.animation = 'slideOutRight 0.3s ease-out forwards';
                    setTimeout(() => {
                        if (message.parentElement) message.remove();
                    }, 300);
                }
            }, 4000);
        }

        function showRetireMixLotModal() {
            if (!currentMixLotId) {
                showMessage('Please select a mix lot first', 'error');
                return;
            }
            
            // Check if lot is already retired
            fetch(`/office/mixes/lot-details/${currentMixLotId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.is_retired) {
                        showMessage('This lot is already retired', 'error');
                        return;
                    }
                    
                    // Get the current lot code to display in modal
                    const lotCode = document.getElementById('detailLotCode').textContent;
                    document.getElementById('retireLotCodeDisplay').textContent = lotCode;
                    
                    // Show the modal
                    document.getElementById('retireMixLotModal').classList.add('show');
                })
                .catch(error => {
                    console.error('Error checking lot status:', error);
                    showMessage('Error checking lot status', 'error');
                });
        }

        function closeRetireMixLotModal() {
            document.getElementById('retireMixLotModal').classList.remove('show');
        }

        function confirmRetireMixLot() {
            closeRetireMixLotModal();
            retireMixLot(currentMixLotId);
        }

        function retireMixLot(mixLotId) {
            const today = new Date().toISOString().split('T')[0];
            
            fetch('/office/retire-lot/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({
                    lot_id: mixLotId,
                    is_mix: true,
                    notes: '',
                    retire_date: today
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('Mix lot retired successfully', 'success');
                    // Reload the mix lots list to update the status
                    loadMixLotsList(currentMixSku);
                    // Reload the details to update the retire button
                    loadMixLotDetails(currentMixLotId);
                } else {
                    showMessage('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Error retiring mix lot', 'error');
            });
        }

        // Reset dropdown on page load
        window.addEventListener('DOMContentLoaded', function() {
            document.getElementById('mixSelector').value = '';
            showEmptyState();
        });
    </script>
</body>
</html>