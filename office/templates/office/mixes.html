{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mixes - Uprising Seeds</title>
    <link rel="stylesheet" href="{% static 'office/css/base.css' %}">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: fadeInUp 0.4s ease-out;
        }

        .dashboard-button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .dashboard-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .header-title {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            flex: 1;
            text-align: center;
        }

        .mix-selector {
            padding: 12px 20px;
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            background: white;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 250px;
        }

        .mix-selector optgroup {
            font-weight: 700;
            font-style: normal;
            color: #333;
            background: #f8f9fa;
        }

        .mix-selector option {
            padding-left: 10px;
            font-weight: 400;
        }

        .mix-selector:hover {
            border-color: #667eea;
        }

        .mix-selector:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Main Content */
        .content {
            display: flex;
            gap: 30px;
            animation: fadeInUp 0.6s ease-out;
        }

        .empty-state {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 60px 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 100%;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state-text {
            color: #666;
            font-size: 1.2rem;
        }

        /* Left Panel - Mix Lots List */
        .left-panel {
            flex: 0 0 420px;  /* Changed from 350px to 420px */
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.2);
        }

        .panel-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
        }

        .add-button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #26de81, #20bf6b);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .add-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(38, 222, 129, 0.3);
        }

        .mix-lots-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .mix-lot-item {
            padding: 20px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mix-lot-item:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.15);
        }

        .mix-lot-item.active {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .lot-code {
            font-size: 1.2rem;
            font-weight: 700;
            color: #667eea;
            text-align: center;  /* Added this */
        }

        .lot-info {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.6;
        }

        /* Right Panel - Details */
        .right-panel {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .details-empty {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .details-empty-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        .section {
            margin-bottom: 40px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.2);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
        }

        .lot-header {
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .lot-header h2 {
            font-size: 2rem;
            color: #667eea;
            margin: 0;
        }

        .lot-meta {
            color: #666;
            font-size: 1rem;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 20px;
        }

        .data-table thead {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .data-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .data-table th:first-child {
            border-top-left-radius: 12px;
        }

        .data-table th:last-child {
            border-top-right-radius: 12px;
        }

        .data-table td {
            padding: 15px;
            background: white;
            border-bottom: 1px solid #e9ecef;
        }

        .data-table tbody tr:hover td {
            background: #f8f9fa;
        }

        .data-table tbody tr:last-child td:first-child {
            border-bottom-left-radius: 12px;
        }

        .data-table tbody tr:last-child td:last-child {
            border-bottom-right-radius: 12px;
        }

        /* Batches */
        .batches-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .batch-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e9ecef;
        }

        .batch-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .batch-date {
            font-weight: 700;
            color: #667eea;
            font-size: 1.1rem;
        }

        .batch-weight {
            color: #666;
            font-size: 0.95rem;
        }

        .batch-notes {
            color: #666;
            font-size: 0.9rem;
            margin-top: 10px;
            font-style: italic;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideInUp 0.3s ease-out;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: transparent;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #999;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            color: #333;
            transform: scale(1.1);
        }

        .modal-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 30px;
            color: #333;
        }

        /* Form */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Lot selection table in modal */
        .lot-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .parts-input {
            width: 80px;
            padding: 8px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
        }

        .parts-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #26de81, #20bf6b);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(38, 222, 129, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #495057;
            border: 2px solid #dee2e6;
        }

        .btn-secondary:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        /* Hidden state */
        .hidden {
            display: none;
        }

        /* Message System */
        .messages-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            animation: slideInRight 0.3s ease-out;
        }

        .message-success {
            border-left: 4px solid #10b981;
        }

        .message-error {
            border-left: 4px solid #ef4444;
        }

        .message-text {
            flex: 1;
            font-size: 0.95rem;
            color: #333;
        }

        .message-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .content {
                flex-direction: column;
            }

            .left-panel {
                flex: 1;
                max-height: 400px;
            }

            .right-panel {
                max-height: none;
            }
        }
    </style>
</head>
<body data-current-year="{{ current_year }}">
    <div class="container">
        <!-- Header -->
        <div class="header">
            <a href="{% url 'office_landing' %}" class="dashboard-button">
                ‚Üê Dashboard
            </a>
            <h1 class="header-title">Mixes</h1>
            <select class="mix-selector" id="mixSelector">
                <option value="">Select a mix...</option>
                
                <optgroup label="Product Mixes">
                    <option value="CAR-RA">Rainbow Carrot Mix</option>
                    <option value="LET-MX">Uprising Lettuce Mix</option>
                    <option value="BEE-3B">3 Beet Mix</option>  <!-- ‚úÖ Fixed -->
                    <option value="MIX-SP">Uprising Spicy Mesclun</option>  <!-- ‚úÖ Fixed -->
                    <option value="MIX-MI">Uprising Mild Mesclun</option>  <!-- ‚úÖ Fixed -->
                    <option value="MIX-BR">Uprising Braising Mix</option>  <!-- ‚úÖ Fixed -->
                    <option value="FLO-ED">Edible Flower Mix</option>
                </optgroup>
                
                <optgroup label="Component Mixes">
                    <option value="lettuce-base">Lettuce Mix</option>
                    <option value="spicy-base">Spicy Mix</option>
                    <option value="mild-base">Mild Mix</option>
                </optgroup>
            </select>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="empty-state">
            <div class="empty-state-icon">ü•£</div>
            <p class="empty-state-text">Select a mix from the dropdown above to get started</p>
        </div>

        <!-- Main Content -->
        <div id="mainContent" class="content hidden">
            <!-- Left Panel - Mix Lots List -->
            <div class="left-panel">
                <div class="panel-header">
                    <h3 class="panel-title">Mix Lots</h3>
                    <button class="add-button" onclick="showAddMixLotModal()">
                        + Add
                    </button>
                </div>
                <div class="mix-lots-list" id="mixLotsList">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Right Panel - Details -->
            <div class="right-panel">
                <div id="detailsEmpty" class="details-empty">
                    <div class="details-empty-icon">üìã</div>
                    <p>Select a mix lot to view details</p>
                </div>

                <div id="detailsContent" class="hidden">
                    <div class="lot-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <h2 id="detailLotCode">--</h2>
                            <div class="lot-meta">
                                Germ: <span id="detailGerm">--</span>
                            </div>
                        </div>
                        <button id="retireMixLotButton" class="add-button" style="background: #dc3545; margin: 0;" onclick="showRetireMixLotModal()">
                            Retire
                        </button>
                    </div>

                    <!-- Components Section -->
                    <div class="section">
                        <div class="section-header">
                            <h3 class="section-title">Components</h3>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Variety</th>
                                    <th>Lot Code</th>
                                    <th>Germ %</th>
                                    <th>Parts</th>
                                </tr>
                            </thead>
                            <tbody id="componentsTableBody">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Batches Section -->
                    <div class="section">
                        <div class="section-header">
                            <h3 class="section-title">Batches</h3>
                            <button id="addBatchButton" class="add-button" onclick="showAddBatchModal()">
                                + Add Batch
                            </button>
                        </div>
                        <div class="batches-list" id="batchesList">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Mix Lot Modal -->
    <div class="modal-overlay" id="addMixLotModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeAddMixLotModal()">&times;</button>
            <h2 class="modal-title">Create New Mix Lot</h2>

            <div class="form-group">
                <label class="form-label">Lot Code</label>
                <input type="text" class="form-input" id="newLotCode" placeholder="e.g., UO26A">
                <small style="color: #666; margin-top: 5px; display: block;">
                    Format: UO[Year][Letter] - e.g., UO26A, UO26B
                </small>
            </div>

            <div class="form-group">
                <label class="form-label">Select Component Lots</label>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Select</th>
                            <th>Variety</th>
                            <th>Lot</th>
                            <th>Germ %</th>
                            <th>Inventory</th>
                            <th>Parts</th>
                        </tr>
                    </thead>
                    <tbody id="availableLotsTableBody">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <div class="form-group">
                <label class="form-label">Calculated Germination Rate</label>
                <input type="text" class="form-input" id="calcGerm" disabled>
            </div>

            <div class="modal-actions">
                <button class="btn btn-primary" onclick="saveMixLot()">üíæ Save Mix Lot</button>
                <button class="btn btn-secondary" onclick="closeAddMixLotModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Add Batch Modal -->
    <div class="modal-overlay" id="addBatchModal">
        <div class="modal-content" style="max-width: 600px;">
            <button class="modal-close" onclick="closeAddBatchModal()">&times;</button>
            <h2 class="modal-title">Record New Batch</h2>

            <div class="form-group">
                <label class="form-label">Date</label>
                <input type="date" class="form-input" id="batchDate">
            </div>

            <div class="form-group">
                <label class="form-label">Final Weight (lbs)</label>
                <input type="number" step="0.01" class="form-input" id="batchWeight" placeholder="0.00">
            </div>

            <div class="form-group">
                <label class="form-label">Notes (measurement spoon, etc.)</label>
                <textarea class="form-input" id="batchNotes" rows="3"></textarea>
            </div>

            <div class="modal-actions">
                <button class="btn btn-primary" onclick="saveBatch()">üíæ Save Batch</button>
                <button class="btn btn-secondary" onclick="closeAddBatchModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Retire Mix Lot Confirmation Modal -->
    <div class="modal-overlay" id="retireMixLotModal">
        <div class="modal-content" style="max-width: 500px;">
            <button class="modal-close" onclick="closeRetireMixLotModal()">&times;</button>
            <h2 class="modal-title" style="color: #dc3545;">Retire Mix Lot</h2>
            
            <div style="text-align: center; padding: 20px 0; color: #666;">
                <div style="font-size: 3rem; margin-bottom: 15px;">‚ö†Ô∏è</div>
                <p style="font-size: 1.1rem; margin-bottom: 10px;">
                    Are you sure you want to retire <strong id="retireLotCodeDisplay">this lot</strong>?
                </p>
                <p style="font-size: 0.95rem; color: #999;">
                    This action will mark the lot as retired and prevent new batches from being added.
                </p>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeRetireMixLotModal()">Cancel</button>
                <button class="btn btn-primary" style="background: linear-gradient(135deg, #dc3545, #b91c1c);" onclick="confirmRetireMixLot()">Yes, Retire Lot</button>
            </div>
        </div>
    </div>


    <script>
        const CURRENT_ORDER_YEAR = parseInt(document.body.dataset.currentYear);
        let currentMixSku = null;
        let currentMixLotId = null;
        let currentMixName = null;

        // Mix selector change
        document.getElementById('mixSelector').addEventListener('change', function() {
            currentMixSku = this.value;
            if (currentMixSku) {
                loadMix(currentMixSku);
            } else {
                showEmptyState();
            }
        });

        function showEmptyState() {
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('mainContent').classList.add('hidden');
        }

        function loadMix(mixSku) {
            currentMixSku = mixSku;
            
            // Get the selected mix name from dropdown
            const selector = document.getElementById('mixSelector');
            currentMixName = selector.options[selector.selectedIndex].text;
            
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            
            // Update panel title
            document.querySelector('.panel-title').textContent = currentMixName;
            
            loadMixLotsList(mixSku);
            
            // Clear details
            document.getElementById('detailsEmpty').classList.remove('hidden');
            document.getElementById('detailsContent').classList.add('hidden');
        }

        function loadMixLotsList(mixSku) {
            fetch(`{% url 'get_existing_mix_lots' %}?mix=${mixSku}`)
                .then(response => response.json())
                .then(mixLots => {
                    displayMixLotsList(mixLots);
                })
                .catch(error => {
                    console.error('Error loading mix lots:', error);
                    document.getElementById('mixLotsList').innerHTML = '<p style="color: #999; text-align: center;">No lots available</p>';
                });
        }

        function displayMixLotsList(mixLots) {
            const container = document.getElementById('mixLotsList');
            
            if (mixLots.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center;">No mix lots yet. Click + Add to create one.</p>';
                return;
            }

            container.innerHTML = '';
            mixLots.forEach(lot => {
                const div = document.createElement('div');
                div.className = 'mix-lot-item';
                div.onclick = () => selectMixLot(lot.id);
                
                div.innerHTML = `
                    <div class="lot-code">
                        ${lot.lot_code}
                        ${lot.is_retired ? '<span style="color: #dc3545; font-size: 0.85rem; margin-left: 8px;">(Retired)</span>' : ''}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function selectMixLot(mixLotId) {
            currentMixLotId = mixLotId;
            
            // Update active state
            document.querySelectorAll('.mix-lot-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            loadMixLotDetails(mixLotId);
        }

        function loadMixLotDetails(mixLotId) {
            fetch(`/office/mixes/lot-details/${mixLotId}/`)
                .then(response => response.json())
                .then(data => {
                    displayMixLotDetails(data);
                })
                .catch(error => {
                    console.error('Error loading lot details:', error);
                    showMessage('Error loading lot details', 'error');
                });
        }

        function displayMixLotDetails(data) {
            console.log('Mix lot data:', data); // ADD THIS LINE TO SEE WHAT'S BEING RETURNED
            console.log('Is retired?', data.is_retired); // ADD THIS TOO
            document.getElementById('detailsEmpty').classList.add('hidden');
            document.getElementById('detailsContent').classList.remove('hidden');
            
            // Header
            document.getElementById('detailLotCode').textContent = data.lot_code;
            document.getElementById('detailGerm').textContent = data.germ_display;
            
            // Handle Retire button based on retirement status
            const retireButton = document.getElementById('retireMixLotButton');
            if (data.is_retired) {
                retireButton.style.display = 'none'; // Hide retire button if already retired
            } else {
                retireButton.style.display = 'block'; // Show retire button if not retired
            }
            
            // Handle Add Batch button based on retirement status
            const addBatchButton = document.getElementById('addBatchButton');
            if (data.is_retired) {
                addBatchButton.disabled = true;
                addBatchButton.style.opacity = '0.5';
                addBatchButton.style.cursor = 'not-allowed';
                addBatchButton.onclick = null; // Remove click handler entirely
            } else {
                addBatchButton.disabled = false;
                addBatchButton.style.opacity = '1';
                addBatchButton.style.cursor = 'pointer';
                addBatchButton.onclick = showAddBatchModal; // Restore click handler
            }
            
            // Components
            const tbody = document.getElementById('componentsTableBody');
            tbody.innerHTML = '';
            data.components.forEach(comp => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${comp.variety_name}</td>
                    <td>${comp.lot_code}</td>
                    <td>${comp.germ_rate}%</td>
                    <td>${comp.parts}</td>
                `;
                tbody.appendChild(tr);
            });
            
            // Batches
            const batchesList = document.getElementById('batchesList');
            if (data.batches.length === 0) {
                batchesList.innerHTML = '<p style="color: #999;">No batches recorded yet.</p>';
            } else {
                batchesList.innerHTML = '';
                data.batches.forEach(batch => {
                    const div = document.createElement('div');
                    div.className = 'batch-card';
                    div.innerHTML = `
                        <div class="batch-header">
                            <div class="batch-date">${batch.date}</div>
                            <div class="batch-weight">${batch.final_weight} lbs</div>
                        </div>
                        ${batch.notes ? `<div class="batch-notes">${batch.notes}</div>` : ''}
                    `;
                    batchesList.appendChild(div);
                });
            }
        }

        function showAddMixLotModal() {
            if (!currentMixSku) {
                showMessage('Please select a mix first', 'error');
                return;
            }
            
            // Load available lots
            fetch(`{% url 'get_available_lots_for_mix' %}?mix=${currentMixSku}&year=${CURRENT_ORDER_YEAR}`)
                .then(response => response.json())
                .then(lots => {
                    displayAvailableLots(lots);
                    document.getElementById('addMixLotModal').classList.add('show');
                })
                .catch(error => {
                    console.error('Error loading available lots:', error);
                    showMessage('Error loading available lots', 'error');
                });
        }

        function displayAvailableLots(lots) {
            const tbody = document.getElementById('availableLotsTableBody');
            tbody.innerHTML = '';
            
            if (lots.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">No lots with active germination found</td></tr>';
                return;
            }
            
            lots.forEach(lot => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox" class="lot-checkbox" data-lot-id="${lot.id}" data-germ="${lot.germ_rate}" onchange="updateGermCalculation()"></td>
                    <td>${lot.variety_name}</td>
                    <td>${lot.lot_code}</td>
                    <td>${lot.germ_rate}%</td>
                    <td>${lot.inventory}</td>
                    <td><input type="number" class="parts-input" min="1" value="1" data-lot-id="${lot.id}" onchange="updateGermCalculation()"></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateGermCalculation() {
            const checkboxes = document.querySelectorAll('.lot-checkbox:checked');
            
            if (checkboxes.length === 0) {
                document.getElementById('calcGerm').value = '';
                return;
            }

            let totalParts = 0;
            let weightedGerm = 0;

            checkboxes.forEach(cb => {
                const lotId = cb.dataset.lotId;
                const germ = parseInt(cb.dataset.germ);
                const partsInput = document.querySelector(`.parts-input[data-lot-id="${lotId}"]`);
                const parts = parseInt(partsInput.value) || 1;

                totalParts += parts;
                weightedGerm += (germ * parts);
            });

            const avgGerm = Math.round(weightedGerm / totalParts);
            document.getElementById('calcGerm').value = `${avgGerm}%`;
        }

        function saveMixLot() {
            const lotCode = document.getElementById('newLotCode').value.trim();
            const checkboxes = document.querySelectorAll('.lot-checkbox:checked');
            
            if (!lotCode) {
                showMessage('Please enter a lot code', 'error');
                return;
            }
            
            if (checkboxes.length === 0) {
                showMessage('Please select at least one component lot', 'error');
                return;
            }

            const components = [];
            checkboxes.forEach(cb => {
                const lotId = cb.dataset.lotId;
                const partsInput = document.querySelector(`.parts-input[data-lot-id="${lotId}"]`);
                components.push({
                    lot_id: parseInt(lotId),
                    parts: parseInt(partsInput.value) || 1
                });
            });

            fetch(`{% url 'create_mix_lot' %}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    mix_sku: currentMixSku,
                    lot_code: lotCode,
                    components: components
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(`Mix lot ${data.lot_code} created successfully!`, 'success');
                    closeAddMixLotModal();
                    loadMixLotsList(currentMixSku);
                } else {
                    showMessage('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error creating mix lot:', error);
                showMessage('Error creating mix lot', 'error');
            });
        }

        function closeAddMixLotModal() {
            document.getElementById('addMixLotModal').classList.remove('show');
            document.getElementById('newLotCode').value = '';
            document.getElementById('calcGerm').value = '';
            document.querySelectorAll('.lot-checkbox').forEach(cb => cb.checked = false);
        }

        function showAddBatchModal() {
            if (!currentMixLotId) {
                showMessage('Please select a mix lot first', 'error');
                return;
            }
            
            document.getElementById('batchDate').valueAsDate = new Date();
            document.getElementById('addBatchModal').classList.add('show');
        }

        function saveBatch() {
            const date = document.getElementById('batchDate').value;
            const weight = document.getElementById('batchWeight').value;
            const notes = document.getElementById('batchNotes').value;

            if (!date || !weight) {
                showMessage('Please fill in date and weight', 'error');
                return;
            }

            fetch(`{% url 'create_batch' %}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    mix_lot_id: currentMixLotId,
                    date: date,
                    final_weight: weight,
                    notes: notes
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('Batch recorded successfully!', 'success');
                    closeAddBatchModal();
                    loadMixLotDetails(currentMixLotId);
                } else {
                    showMessage('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error recording batch:', error);
                showMessage('Error recording batch', 'error');
            });
        }

        function closeAddBatchModal() {
            document.getElementById('addBatchModal').classList.remove('show');
            document.getElementById('batchWeight').value = '';
            document.getElementById('batchNotes').value = '';
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Close modals on escape
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeAddMixLotModal();
                closeAddBatchModal();
            }
        });

        // Close modals on outside click
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', function(event) {
                if (event.target === this) {
                    closeAddMixLotModal();
                    closeAddBatchModal();
                }
            });
        });

        function showMessage(text, type = 'success') {
            let container = document.querySelector('.messages-container');
            if (!container) {
                container = document.createElement('div');
                container.className = 'messages-container';
                document.body.appendChild(container);
            }
            
            const message = document.createElement('div');
            message.className = `message message-${type}`;
            message.innerHTML = `
                <span class="message-text">${text}</span>
                <button class="message-close" onclick="this.parentElement.remove()">√ó</button>
            `;
            
            container.appendChild(message);
            
            setTimeout(() => {
                if (message.parentElement) {
                    message.style.animation = 'slideOutRight 0.3s ease-out forwards';
                    setTimeout(() => {
                        if (message.parentElement) message.remove();
                    }, 300);
                }
            }, 4000);
        }

        function showRetireMixLotModal() {
            if (!currentMixLotId) {
                showMessage('Please select a mix lot first', 'error');
                return;
            }
            
            // Get the current lot code to display in modal
            const lotCode = document.getElementById('detailLotCode').textContent;
            document.getElementById('retireLotCodeDisplay').textContent = lotCode;
            
            // Show the modal
            document.getElementById('retireMixLotModal').classList.add('show');
        }

        function closeRetireMixLotModal() {
            document.getElementById('retireMixLotModal').classList.remove('show');
        }

        function confirmRetireMixLot() {
            closeRetireMixLotModal();
            retireMixLot(currentMixLotId);
        }

        function retireMixLot(mixLotId) {
            const today = new Date().toISOString().split('T')[0];
            
            fetch('/office/retire-lot/', {  // Use your existing endpoint
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    lot_id: mixLotId,  // Use lot_id to match your view
                    is_mix: true,      // Add this flag
                    notes: '',
                    retire_date: today // Add today's date
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('Mix lot retired successfully', 'success');
                    setTimeout(() => location.reload(), 2000);
                } else {
                    showMessage('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Error retiring mix lot', 'error');
            });
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Reset dropdown on page load
        window.addEventListener('DOMContentLoaded', function() {
            document.getElementById('mixSelector').value = '';
            showEmptyState();
        });
    </script>
</body>
</html>